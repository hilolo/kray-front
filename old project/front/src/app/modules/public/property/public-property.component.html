<div class="public-page" [class.public-page--dark]="isDarkMode">
    <header class="public-page__header">
        <div class="public-page__title">
            <mat-icon svgIcon="heroicons_outline:home-modern" class="icon-size-6"></mat-icon>
            <div>
                <p class="public-page__subtitle">Property spotlight</p>
                <h1 class="public-page__heading">{{ property?.name }}</h1>
            </div>
        </div>

        <div class="header-actions">
            <div class="language-links">
                <ng-container *ngFor="let lang of languageOptions">
                    <a *ngIf="getLanguageLink(lang.id) as link"
                       mat-stroked-button
                       color="primary"
                       [routerLink]="link"
                       (click)="switchLanguage(lang.id)"
                       [class.language-link--active]="activeLang === lang.id">
                        {{ lang.label }}
                    </a>
                </ng-container>
            </div>
            <button type="button"
                    mat-icon-button
                    class="theme-toggle"
                    (click)="toggleTheme()"
                    [matTooltip]="theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'">
                <mat-icon *ngIf="theme === 'dark'" svgIcon="heroicons_outline:sun"></mat-icon>
                <mat-icon *ngIf="theme === 'light'" svgIcon="heroicons_outline:moon"></mat-icon>
            </button>
        </div>
    </header>

    <ng-container *ngIf="property; else state">

        <div class="public-content">
            <div class="property-main">
                <div class="property-media">
                    <div class="property-cover-wrapper">
                        <button type="button"
                                class="image-nav-btn image-nav-btn--prev"
                                *ngIf="hasMultipleImages"
                                (click)="previousImage(); $event.stopPropagation()"
                                [attr.aria-label]="'Previous image'">
                            <mat-icon svgIcon="heroicons_outline:chevron-left"></mat-icon>
                        </button>
                        
                        <div class="property-cover">
                            <img *ngIf="activeImage?.url || mainImageUrl; else coverPlaceholder"
                                 [src]="activeImage?.url || mainImageUrl"
                                 alt="Property main image"
                                 (click)="openImageViewer(activeImageIndex)"
                                 class="property-main-image">
                            
                            <div class="image-counter" *ngIf="hasMultipleImages">
                                {{ activeImageIndex + 1 }} / {{ galleryImages.length }}
                            </div>
                        </div>
                        
                        <button type="button"
                                class="image-nav-btn image-nav-btn--next"
                                *ngIf="hasMultipleImages"
                                (click)="nextImage(); $event.stopPropagation()"
                                [attr.aria-label]="'Next image'">
                            <mat-icon svgIcon="heroicons_outline:chevron-right"></mat-icon>
                        </button>
                    </div>

                </div>

                <div class="property-content">
                    <div class="meta-row">
                        <div class="reference-block" *ngIf="property?.identifier">
                            <span class="reference-label">Référence</span>
                            <span class="reference-value">{{ property?.identifier }}</span>
                        </div>

                        <div class="badge-row">
                            <span class="badge badge--muted" *ngIf="property?.typeProperty">{{ property?.typeProperty }}</span>
                            <span class="badge badge--accent">{{ getCategoryLabel(property?.category) }}</span>
                        </div>
                    </div>
                    <p class="property-address">
                        <mat-icon svgIcon="heroicons_outline:map-pin" class="icon-size-4"></mat-icon>
                        <span>{{ getPropertyAddress() }}</span>
                    </p>

                    <div class="price-block">
                        <span class="price">{{ property?.price | pricePaymentType:property?.typePaiment }}</span>
                    </div>

                    <div class="stat-grid">
                        <div class="stat">
                            <span class="stat-label">Surface</span>
                            <span class="stat-value">{{ formatNumber(property?.area, 'm²') }}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Rooms</span>
                            <span class="stat-value">{{ property?.pieces ?? '—' }}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Bathrooms</span>
                            <span class="stat-value">{{ property?.bathrooms ?? '—' }}</span>
                        </div>
                    </div>

                    <div class="section" *ngIf="property?.description">
                        <h2>Overview</h2>
                        <p>{{ property?.description }}</p>
                    </div>

                    <div class="section" *ngIf="property?.features?.length">
                        <h3>Highlights</h3>
                        <div class="tag-list">
                            <span class="tag" *ngFor="let feature of property?.features">{{ feature }}</span>
                        </div>
                    </div>

                    <div class="section" *ngIf="property?.equipment?.length">
                        <h3>Equipment</h3>
                        <div class="tag-list">
                            <span class="tag tag--accent" *ngFor="let item of property?.equipment">{{ item }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="company-card" *ngIf="companyInfo?.name">
                <div class="company-header">
                    <div class="company-logo" *ngIf="companyInfo?.logoUrl; else logoFallback">
                        <img [src]="companyInfo?.logoUrl" alt="Company logo">
                    </div>
                    <ng-template #logoFallback>
                        <div class="company-logo company-logo--placeholder">
                            <mat-icon svgIcon="heroicons_outline:building-office" class="icon-size-6"></mat-icon>
                        </div>
                    </ng-template>
                    <div>
                        <p class="company-caption">Listing managed by</p>
                        <h3 class="company-name">{{ companyInfo?.name }}</h3>
                    </div>
                </div>

                <div class="company-details">
                    <div class="company-detail" *ngIf="companyInfo?.phone">
                        <mat-icon svgIcon="heroicons_outline:phone" class="icon-size-4"></mat-icon>
                        <a [href]="'tel:' + companyInfo?.phone">{{ companyInfo?.phone }}</a>
                    </div>
                    <div class="company-detail" *ngIf="companyInfo?.email">
                        <mat-icon svgIcon="heroicons_outline:envelope" class="icon-size-4"></mat-icon>
                        <a [href]="'mailto:' + companyInfo?.email">{{ companyInfo?.email }}</a>
                    </div>
                    <div class="company-detail" *ngIf="companyInfo?.address">
                        <mat-icon svgIcon="heroicons_outline:map-pin" class="icon-size-4"></mat-icon>
                        <span>{{ companyInfo?.address }}</span>
                    </div>
                    <div class="company-detail" *ngIf="getWebsiteHref()">
                        <mat-icon svgIcon="heroicons_outline:globe-alt" class="icon-size-4"></mat-icon>
                        <a [href]="getWebsiteHref()" target="_blank" rel="noopener">Visit website</a>
                    </div>
                </div>

                <div class="company-actions" *ngIf="companyInfo?.phone || companyInfo?.email">
                    <a mat-flat-button color="primary" *ngIf="companyInfo?.phone" [href]="'tel:' + companyInfo?.phone">
                        Call now
                    </a>
                    <a mat-stroked-button color="primary" *ngIf="companyInfo?.email" [href]="'mailto:' + companyInfo?.email">
                        Send email
                    </a>
                </div>

                <section class="contact-card" *ngIf="contactForm as form">
                    <h3 class="contact-card__title">Demande d'information</h3>
                    <form class="contact-card__form" [formGroup]="form" (ngSubmit)="submitContactForm()">
                        <div class="contact-field" [class.contact-field--error]="form.get('fullName')?.invalid && form.get('fullName')?.touched">
                            <label for="contact-fullName">Nom et prénom</label>
                            <input id="contact-fullName" type="text" formControlName="fullName" placeholder="Introduisez votre nom et prénom">
                            <span class="contact-field__error" *ngIf="form.get('fullName')?.invalid && form.get('fullName')?.touched">Champ obligatoire</span>
                        </div>

                        <div class="contact-field" [class.contact-field--error]="form.get('phone')?.invalid && form.get('phone')?.touched">
                            <label for="contact-phone">Téléphone</label>
                            <input id="contact-phone" type="tel" formControlName="phone" placeholder="Introduisez votre numéro de téléphone">
                            <span class="contact-field__error" *ngIf="form.get('phone')?.invalid && form.get('phone')?.touched">Champ obligatoire</span>
                        </div>

                        <div class="contact-field" [class.contact-field--error]="form.get('email')?.invalid && form.get('email')?.touched">
                            <label for="contact-email">Email</label>
                            <input id="contact-email" type="email" formControlName="email" placeholder="Introduisez votre Email">
                            <span class="contact-field__error" *ngIf="form.get('email')?.invalid && form.get('email')?.touched">Email invalide</span>
                        </div>

                        <div class="contact-field" [class.contact-field--error]="form.get('message')?.invalid && form.get('message')?.touched">
                            <label for="contact-message">Message</label>
                            <textarea id="contact-message" rows="4" formControlName="message" placeholder="Votre message"></textarea>
                            <span class="contact-field__error" *ngIf="form.get('message')?.invalid && form.get('message')?.touched">Veuillez saisir un message</span>
                        </div>

                        <div class="contact-card__actions">
                            <button class="contact-card__submit" mat-flat-button color="primary" type="submit">
                                <mat-icon svgIcon="heroicons_outline:envelope"></mat-icon>
                                Demande d'information
                            </button>

                            <a *ngIf="whatsappLink" class="contact-card__whatsapp" [href]="whatsappLink" target="_blank" rel="noopener noreferrer">
                                <mat-icon svgIcon="heroicons_outline:chat-bubble-left-right"></mat-icon>
                                Contacter via WhatsApp
                            </a>
                        </div>
                    </form>
                </section>
            </aside>
        </div>

        <footer class="public-footer">
            <p class="public-footer__text">
                Powered by <span class="public-footer__brand">ImmoGest</span>
            </p>
        </footer>
    </ng-container>

    <ng-template #state>
        <ng-container *ngIf="isNotFound">
            <div class="state-card state-card--error">
                <mat-icon svgIcon="heroicons_outline:exclamation-triangle" class="icon-size-8"></mat-icon>
                <h2>Property unavailable</h2>
                <p>This property is not publicly accessible or may have been removed.</p>
                <button mat-flat-button color="primary" (click)="navigateHome()">Return home</button>
            </div>
        </ng-container>
    </ng-template>
</div>

<app-image-viewer
    [isOpen]="isImageViewerOpen"
    [images]="viewerImages"
    [currentIndex]="viewerIndex"
    (close)="closeImageViewer()"
    (imageChanged)="onViewerImageChanged($event)">
</app-image-viewer>

<ng-template #coverPlaceholder>
    <div class="cover-placeholder">
        <mat-icon svgIcon="heroicons_outline:home" class="icon-size-10"></mat-icon>
    </div>
</ng-template>

