<div class="absolute inset-0 flex flex-col min-w-0 overflow-hidden">
    <div class="flex flex-col h-full bg-card dark:bg-transparent">
        <!-- Main -->
        <div class="flex flex-col flex-auto overflow-hidden">
            <!-- Header -->
            <div class="py-6 px-6 md:px-8 border-b flex-shrink-0">
                <!-- Buttons -->
                <div class="flex items-center justify-between gap-2">
                    <button mat-stroked-button 
                            type="button"
                            (click)="cancel()"
                            class="min-w-0">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:arrow-left'"></mat-icon>
                        <span class="ml-2">Back</span>
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <button mat-stroked-button 
                                type="button"
                                (click)="cancel()">
                            <span>Cancel</span>
                        </button>
                        <button mat-flat-button 
                                type="button"
                                [color]="'primary'"
                                (click)="savePayment()">
                            <span>Save</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Form Content -->
            <div class="flex-auto overflow-y-auto p-6 md:px-8">
                <form [formGroup]="paymentForm" class="w-full space-y-6">
                    
                    <!-- Allocation Section -->
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                        <div class="text-lg font-semibold mb-6">Allocation</div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Property -->
                            <div class="flex">
                                <div class="relative flex-auto">
                                    <mat-form-field class="flex-auto">
                                        <mat-label>PROPERTY</mat-label>
                                        <input matInput 
                                               type="text"
                                               [value]="isEditingProperty ? propertySearchTerm : getSelectedPropertyName()"
                                               [placeholder]="'Search properties...'"
                                               (input)="onPropertyInput($event)"
                                               (focus)="onPropertyFocus()"
                                               (blur)="onPropertyBlur()"
                                               autocomplete="off">
                                        <mat-icon matPrefix class="icon-size-5" [svgIcon]="'heroicons_solid:home'"></mat-icon>
                                        <button mat-icon-button matSuffix *ngIf="paymentForm.get('propertyId')?.value"
                                                (click)="clearPropertySelection()"
                                                class="icon-size-5">
                                            <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                                        </button>
                                    </mat-form-field>
                                    
                                    <!-- Dropdown -->
                                    <div *ngIf="showPropertyDropdown && filteredProperties && filteredProperties.length > 0" 
                                         class="absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                        <div *ngFor="let property of filteredProperties" 
                                             class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-200 dark:border-gray-700 last:border-b-0"
                                             (mousedown)="selectPropertyOption(property.id)">
                                            <div class="font-medium text-gray-900 dark:text-white">
                                                {{ property.name }}
                                            </div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400" *ngIf="property.identifier">
                                                {{ property.identifier }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tenancy -->
                            <div class="flex">
                                <div class="relative flex-auto">
                                    <mat-form-field class="flex-auto">
                                        <mat-label>TENANCY</mat-label>
                                        <input matInput 
                                               type="text"
                                               [value]="isEditingLeasing ? leasingSearchTerm : getSelectedLeasingName()"
                                               [placeholder]="'Search tenancies...'"
                                               (input)="onLeasingInput($event)"
                                               (focus)="onLeasingFocus()"
                                               (blur)="onLeasingBlur()"
                                               autocomplete="off">
                                        <mat-icon matPrefix class="icon-size-5" [svgIcon]="'heroicons_solid:document-text'"></mat-icon>
                                        <button mat-icon-button matSuffix *ngIf="paymentForm.get('leasingId')?.value"
                                                (click)="clearLeasingSelection()"
                                                class="icon-size-5">
                                            <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                                        </button>
                                    </mat-form-field>
                                    
                                    <!-- Dropdown -->
                                    <div *ngIf="showLeasingDropdown && filteredLeasings && filteredLeasings.length > 0" 
                                         class="absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                        <div *ngFor="let leasing of filteredLeasings" 
                                             class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-200 dark:border-gray-700 last:border-b-0"
                                             (mousedown)="selectLeasingOption(leasing.id)">
                                            <div class="font-medium text-gray-900 dark:text-white">
                                                {{ leasing.propertyName }} - {{ leasing.tenantName }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- General info Section -->
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                        <div class="text-lg font-semibold mb-6">General info</div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Category -->
                            <div class="flex md:col-span-2">
                                <mat-form-field class="flex-auto">
                                    <mat-label>CATEGORY</mat-label>
                                    <mat-select formControlName="category" required>
                                        <mat-option *ngFor="let cat of getCurrentCategories()" [value]="cat.value">
                                            {{ cat.label }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Period From and To -->
                            <div class="flex md:col-span-2">
                                <mat-form-field class="flex-auto md:pr-3">
                                    <mat-label>PERIOD FROM</mat-label>
                                    <input matInput 
                                           [matDatepicker]="periodFromPicker"
                                           formControlName="periodFrom"
                                           [placeholder]="'Choose a date'">
                                    <mat-datepicker-toggle matSuffix [for]="periodFromPicker"></mat-datepicker-toggle>
                                    <mat-datepicker #periodFromPicker></mat-datepicker>
                                </mat-form-field>
                                <mat-form-field class="flex-auto md:pl-3">
                                    <mat-label>PERIOD TO</mat-label>
                                    <input matInput 
                                           [matDatepicker]="periodToPicker"
                                           formControlName="periodTo"
                                           [placeholder]="'Choose a date'">
                                    <mat-datepicker-toggle matSuffix [for]="periodToPicker"></mat-datepicker-toggle>
                                    <mat-datepicker #periodToPicker></mat-datepicker>
                                </mat-form-field>
                            </div>

                            <!-- FROM (Payer/Contact) -->
                            <div class="flex md:col-span-2">
                                <div class="relative flex-auto">
                                    <mat-form-field class="flex-auto">
                                        <mat-label>FROM*</mat-label>
                                        <input matInput 
                                               type="text"
                                               [value]="isEditingContact ? contactSearchTerm : getSelectedContactName()"
                                               [placeholder]="'Search contacts...'"
                                               (input)="onContactInput($event)"
                                               (focus)="onContactFocus()"
                                               (blur)="onContactBlur()"
                                               autocomplete="off"
                                               required>
                                        <mat-icon matPrefix class="icon-size-5" [svgIcon]="'heroicons_solid:user'"></mat-icon>
                                        <button mat-icon-button matSuffix *ngIf="paymentForm.get('contactId')?.value"
                                                (click)="clearContactSelection()"
                                                class="icon-size-5">
                                            <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                                        </button>
                                    </mat-form-field>
                                    
                                    <!-- Dropdown -->
                                    <div *ngIf="showContactDropdown && filteredContacts && filteredContacts.length > 0" 
                                         class="absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                        <div *ngFor="let contact of filteredContacts" 
                                             class="px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-200 dark:border-gray-700 last:border-b-0"
                                             (mousedown)="selectContactOption(contact.id)">
                                            <div class="font-medium text-gray-900 dark:text-white">
                                                {{ contact.firstName }} {{ contact.lastName }}
                                            </div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400" *ngIf="contact.email">
                                                {{ contact.email }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Amount Section -->
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                        <div class="text-lg font-semibold mb-6">Amount</div>
                        
                        <!-- PAYMENTS Section -->
                        <div class="mb-6">
                            <div class="text-base font-semibold mb-4">PAYMENTS</div>
                            
                            <div formArrayName="items" class="space-y-4">
                                <div *ngFor="let item of itemsFormArray.controls; let i = index" 
                                     [formGroupName]="i"
                                     class="flex items-center gap-3 p-3 border border-gray-200 dark:border-gray-700 rounded">
                                    
                                    <!-- Amount -->
                                    <mat-form-field class="flex-auto" style="min-width: 180px;">
                                        <mat-label>Amount</mat-label>
                                        <input matInput 
                                               type="number" 
                                               formControlName="amount"
                                               [placeholder]="'0'"
                                               step="0.01"
                                               min="0">
                                        <span matSuffix class="ml-1 text-gray-500 text-sm">MAD</span>
                                    </mat-form-field>

                                    <!-- VAT -->
                                    <mat-form-field class="flex-auto" style="min-width: 120px;">
                                        <mat-label>VAT</mat-label>
                                        <span matPrefix class="mr-1 text-gray-500 text-sm">%</span>
                                        <input matInput 
                                               type="number" 
                                               formControlName="vat"
                                               [placeholder]="'0'"
                                               step="0.01"
                                               min="0"
                                               max="100">
                                    </mat-form-field>

                                    <!-- Description -->
                                    <mat-form-field class="flex-auto">
                                        <mat-label>Description</mat-label>
                                        <input matInput 
                                               formControlName="description"
                                               [placeholder]="'Description'">
                                    </mat-form-field>

                                    <!-- Remove Button -->
                                    <button mat-icon-button 
                                            type="button"
                                            (click)="removePaymentItem(i)"
                                            class="text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex-shrink-0 w-10 h-10">
                                        <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                                    </button>
                                </div>
                            </div>

                            <!-- Add Item Button -->
                            <button mat-stroked-button 
                                    type="button"
                                    (click)="addPaymentItem()"
                                    class="mt-4 border-gray-300">
                                <mat-icon [svgIcon]="'heroicons_outline:plus'"></mat-icon>
                                <span class="ml-2">Add another item</span>
                            </button>
                        </div>

                        <!-- Summary -->
                        <div class="space-y-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <!-- Subtotal -->
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">SUBTOTAL TAX EXCL.:</span>
                                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ subtotal.toFixed(2) }} MAD</span>
                            </div>

                            <!-- VAT -->
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">VAT:</span>
                                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ vatTotal.toFixed(2) }} MAD</span>
                            </div>

                            <!-- Total -->
                            <div class="flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700">
                                <span class="text-base font-semibold text-gray-900 dark:text-white">TOTAL (TAX INCL.):</span>
                                <span class="text-xl font-bold text-green-600 dark:text-green-400">{{ total.toFixed(2) }} MAD</span>
                            </div>
                        </div>
                    </div>

                    <!-- Other information Section -->
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                        <div class="text-lg font-semibold mb-6">Other information</div>
                        
                        <div class="flex flex-col">
                            <!-- Numbering -->
                            <mat-form-field class="flex-auto">
                                <mat-label>NUMBERING</mat-label>
                                <input matInput 
                                       formControlName="numbering"
                                       [placeholder]="'Enter a unique reference number'">
                                <mat-hint>Enter a unique reference number if required. This will be shown on the document.</mat-hint>
                            </mat-form-field>
                        </div>
                    </div>

                    <!-- Documents Section -->
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                        <div class="text-lg font-semibold mb-6">Documents</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            <!-- Documents section - can be implemented later -->
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
