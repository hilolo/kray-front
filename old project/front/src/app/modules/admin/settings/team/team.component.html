<div class="w-full">
    <!-- Header -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Team Members</h2>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
            Manage your team members and their permissions
        </p>
    </div>

    <!-- Loading state -->
    <div *ngIf="loading" class="flex justify-center items-center py-12">
        <mat-spinner diameter="40"></mat-spinner>
    </div>

    <!-- Split view: Team members list + Permissions panel -->
    <div *ngIf="!loading" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Left side: Team members list -->
        <div class="flex flex-col">
            <div class="flex flex-col divide-y border border-gray-200 dark:border-gray-700 rounded-lg">
                <div *ngIf="teamMembers.length === 0" class="p-6">
                    <app-no-data message="No data available at this moment"></app-no-data>
                </div>

                <ng-container *ngFor="let member of teamMembers; trackBy: trackByFn">
                    <div class="flex flex-col sm:flex-row sm:items-center p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
                         [class.bg-primary-50]="selectedMember?.id === member.id"
                         [class.dark:bg-primary-900]="selectedMember?.id === member.id">
                        <div class="flex items-center flex-1">
                            <div class="flex flex-0 items-center justify-center w-10 h-10 rounded-full overflow-hidden">
                                <ng-container *ngIf="member.avatar">
                                    <img
                                        class="object-cover w-full h-full"
                                        [src]="member.avatar"
                                        [alt]="member.name"/>
                                </ng-container>
                                <ng-container *ngIf="!member.avatar">
                                    <div class="flex items-center justify-center w-full h-full rounded-full text-lg uppercase bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-200">
                                        {{member.name?.charAt(0) || 'U'}}
                                    </div>
                                </ng-container>
                            </div>
                            <div class="ml-4 flex-1">
                                <div class="font-medium">{{member.name || 'No name'}}</div>
                                <div class="text-secondary text-sm">{{member.email}}</div>
                                <div *ngIf="member.phone" class="text-xs text-gray-500 dark:text-gray-400">{{member.phone}}</div>
                                <div class="flex items-center text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <mat-icon class="icon-size-4 mr-1" svgIcon="heroicons_outline:shield-check"></mat-icon>
                                    {{getPermissionsSummary(member)}}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 mt-3 sm:mt-0 sm:ml-auto">
                            <div class="order-2 sm:order-1">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                                      [ngClass]="getRoleColorClass(member.role)">
                                    {{ getRoleDisplayName(member.role) }}
                                </span>
                            </div>
                            <!-- Edit button for admins -->
                            <div class="order-3 sm:order-2" *ngIf="canEditPermissions">
                                <button
                                    mat-icon-button
                                    [matTooltip]="'Edit Permissions'"
                                    (click)="editPermissions(member)">
                                    <mat-icon svgIcon="heroicons_outline:pencil-square"></mat-icon>
                                </button>
                            </div>
                            <!-- View button for non-admins (only their own) -->
                            <div class="order-3 sm:order-2" *ngIf="!canEditPermissions && member.id === currentUser?.id">
                                <button
                                    mat-icon-button
                                    [matTooltip]="'View My Permissions'"
                                    (click)="editPermissions(member)">
                                    <mat-icon svgIcon="heroicons_outline:eye"></mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                </ng-container>
            </div>
        </div>

        <!-- Right side: Permissions panel -->
        <div class="flex flex-col">
            <div *ngIf="!showPermissionsPanel" class="flex flex-col items-center justify-center h-full min-h-[400px] border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                <mat-icon class="icon-size-20 text-gray-400 mb-4" svgIcon="heroicons_outline:shield-check"></mat-icon>
                <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">No Member Selected</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    Select a team member from the list to manage their permissions
                </p>
            </div>

            <div *ngIf="showPermissionsPanel && selectedMember" class="flex flex-col border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                <!-- Permissions header -->
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center">
                        <div class="flex flex-0 items-center justify-center w-10 h-10 rounded-full overflow-hidden mr-3">
                            <ng-container *ngIf="selectedMember.avatar">
                                <img
                                    class="object-cover w-full h-full"
                                    [src]="selectedMember.avatar"
                                    [alt]="selectedMember.name"/>
                            </ng-container>
                            <ng-container *ngIf="!selectedMember.avatar">
                                <div class="flex items-center justify-center w-full h-full rounded-full text-lg uppercase bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-200">
                                    {{selectedMember.name?.charAt(0) || 'U'}}
                                </div>
                            </ng-container>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold">{{selectedMember.name}}</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Manage Permissions</p>
                        </div>
                    </div>
                    <button
                        mat-icon-button
                        (click)="closePermissionsPanel()"
                        matTooltip="Close">
                        <mat-icon>close</mat-icon>
                    </button>
                </div>

                <!-- Permissions content -->
                <div class="flex flex-col overflow-y-auto max-h-[600px] p-4" [formGroup]="permissionsForm">
                    <!-- Read-only notice for non-admins -->
                    <div *ngIf="!canEditPermissions" class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg">
                        <div class="flex items-start">
                            <mat-icon class="mr-3 text-blue-600 dark:text-blue-400" svgIcon="heroicons_outline:information-circle"></mat-icon>
                            <div>
                                <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-1">Read-Only Mode</h4>
                                <p class="text-sm text-blue-800 dark:text-blue-200">
                                    You are viewing your permissions in read-only mode. Only administrators can modify user permissions.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Select All Option (only for admins) -->
                    <div *ngIf="canEditPermissions" class="flex items-center justify-between mb-4 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        <mat-checkbox
                            [checked]="isAllModulesSelected()"
                            [indeterminate]="!isAllModulesSelected() && hasSomeModulesSelected()"
                            [disabled]="!canInteractWithPermissions()"
                            (change)="selectAll()"
                            color="primary">
                            <span class="font-medium text-sm">Select All Permissions</span>
                        </mat-checkbox>
                    </div>

                    <mat-divider class="my-4"></mat-divider>

                    <!-- Permissions Table Header -->
                    <div class="grid grid-cols-12 gap-2 mb-3 px-2 py-2 bg-gray-100 dark:bg-gray-900 rounded-lg text-xs font-semibold">
                        <div class="col-span-5">Module</div>
                        <div class="col-span-2 text-center">View</div>
                        <div class="col-span-2 text-center">Edit</div>
                        <div class="col-span-2 text-center">Delete</div>
                        <div class="col-span-1 text-center">All</div>
                    </div>

                    <!-- Modules List -->
                    <div class="flex flex-col space-y-2">
                        <div
                            *ngFor="let module of modules"
                            class="grid grid-cols-12 gap-2 items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                            
                            <!-- Module Info -->
                            <div class="col-span-5 flex items-center space-x-2">
                                <mat-icon [svgIcon]="module.icon" class="icon-size-5 text-gray-600 dark:text-gray-400"></mat-icon>
                                <div class="flex flex-col">
                                    <span class="font-medium text-xs">{{ module.name }}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400 hidden xl:block">{{ module.description }}</span>
                                </div>
                            </div>

                            <!-- View Permission -->
                            <div class="col-span-2 flex justify-center">
                                <mat-checkbox
                                    [formControlName]="module.id + '_view'"
                                    [disabled]="!canInteractWithPermissions()"
                                    color="primary">
                                </mat-checkbox>
                            </div>

                            <!-- Edit Permission -->
                            <div class="col-span-2 flex justify-center">
                                <mat-checkbox
                                    [formControlName]="module.id + '_edit'"
                                    [disabled]="!canInteractWithPermissions()"
                                    color="primary">
                                </mat-checkbox>
                            </div>

                            <!-- Delete Permission -->
                            <div class="col-span-2 flex justify-center">
                                <mat-checkbox
                                    [formControlName]="module.id + '_delete'"
                                    [disabled]="!canInteractWithPermissions()"
                                    color="warn">
                                </mat-checkbox>
                            </div>

                            <!-- Select All for Module (only for admins) -->
                            <div class="col-span-1 flex justify-center">
                                <mat-checkbox
                                    *ngIf="canEditPermissions"
                                    [checked]="isAllSelected(module)"
                                    [indeterminate]="isSomeSelected(module)"
                                    [disabled]="!canInteractWithPermissions()"
                                    (change)="toggleAllForModule(module, $event.checked)"
                                    color="accent">
                                </mat-checkbox>
                                <span *ngIf="!canEditPermissions" class="text-gray-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="flex items-center justify-end gap-4 p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                    <!-- Admin actions -->
                    <ng-container *ngIf="canEditPermissions">
                        <button
                            mat-button
                            [disabled]="savingPermissions"
                            (click)="closePermissionsPanel()">
                            Cancel
                        </button>
                        <button
                            mat-flat-button
                            color="primary"
                            [disabled]="savingPermissions"
                            (click)="savePermissions()">
                            <mat-icon class="mr-2 icon-size-5" *ngIf="!savingPermissions">save</mat-icon>
                            <mat-spinner *ngIf="savingPermissions" diameter="20" class="mr-2"></mat-spinner>
                            {{ savingPermissions ? 'Saving...' : 'Save Permissions' }}
                        </button>
                    </ng-container>
                    
                    <!-- Non-admin actions (read-only) -->
                    <ng-container *ngIf="!canEditPermissions">
                        <button
                            mat-flat-button
                            color="primary"
                            (click)="closePermissionsPanel()">
                            Close
                        </button>
                    </ng-container>
                </div>
            </div>
        </div>

    </div>
</div>