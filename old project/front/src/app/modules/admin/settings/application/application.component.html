<div class="w-full max-w-3xl">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="flex items-center justify-center py-6"> 
        <div class="text-center">
            <mat-spinner diameter="40" class="mx-auto mb-4"></mat-spinner>
            <p class="text-gray-600 dark:text-gray-400">{{ 'common.loading' | transloco }}</p>
        </div>
    </div>

    <!-- Content -->
    <div *ngIf="!isLoading">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                    {{ 'settings.application.header.title' | transloco }}
                </h2>
                <div class="h-1 w-20 bg-blue-600 dark:bg-blue-400 rounded mb-2"></div>
                <p class="text-gray-600 dark:text-gray-400 mt-1">
                    {{ 'settings.application.header.description' | transloco }}
                </p>
            </div>
        </div>
    </div>

    <form [formGroup]="settingsForm" (ngSubmit)="saveSettings()" [class.opacity-50]="isSaving" [class.pointer-events-none]="isSaving">
        <!-- Language Selector -->
        <div class="mb-6">
            <mat-form-field [ngClass]="formFieldHelpers" class="w-40" subscriptSizing="dynamic">
                <mat-label>{{ 'settings.application.language_label' | transloco }}</mat-label>
                <mat-select formControlName="language" class="text-sm">
                    <mat-option value="en">{{ 'settings.application.language_english' | transloco }}</mat-option>
                    <mat-option value="fr">{{ 'settings.application.language_french' | transloco }}</mat-option>
                </mat-select>
            </mat-form-field>
        </div>
        <!-- Property Section Title -->
        <div class="w-full mb-6">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Property</h3>
            <div class="h-1 w-20 bg-blue-600 dark:bg-blue-400 rounded"></div>
        </div>

        <!-- Default City Section -->
        <div class="w-full">
            <div class="text-xl">{{ 'settings.application.default_city' | transloco }}</div>
            <div class="text-secondary">{{ 'settings.application.default_city_description' | transloco }}</div>
        </div>
        
        <div class="grid sm:grid-cols-2 gap-4 w-full mt-6">
            <!-- Default City -->
            <div>
                <mat-form-field [ngClass]="formFieldHelpers" class="w-full" subscriptSizing="dynamic">
                    <mat-label>{{ 'settings.application.city_label' | transloco }}</mat-label>
                    <mat-select formControlName="defaultCity">
                        <mat-option *ngFor="let city of moroccanCities" [value]="city">
                            {{ city }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
        </div>

        <!-- Fixed Categories Section -->
        <div class="w-full mt-6">
            <div class="text-xl">{{ 'settings.application.categories' | transloco }}</div>
            <div class="text-secondary">{{ 'settings.application.categories_description' | transloco }}</div>
        </div>
        
        <div class="w-full mt-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Location -->
                <div class="p-6 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Location</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Location references</p>
                    </div>
                    <mat-form-field [ngClass]="formFieldHelpers" class="w-full" subscriptSizing="dynamic">
                        <mat-label>Reference</mat-label>
                        <input matInput formControlName="locationReference" placeholder="Enter reference..." (keydown)="onInputKeyDown($event)">
                    </mat-form-field>
                </div>

                <!-- Vente-->
                <div class="p-6 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Vente </h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Sale references</p>
                    </div>
                    <mat-form-field [ngClass]="formFieldHelpers" class="w-full" subscriptSizing="dynamic">
                        <mat-label>Reference</mat-label>
                        <input matInput formControlName="venteReference" placeholder="Enter reference..." (keydown)="onInputKeyDown($event)">
                    </mat-form-field>
                </div>

                <!-- Vacance  -->
                <div class="p-6 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Vacance </h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Vacation references</p>
                    </div>
                    <mat-form-field [ngClass]="formFieldHelpers" class="w-full" subscriptSizing="dynamic">
                        <mat-label>Reference</mat-label>
                        <input matInput formControlName="vacanceReference" placeholder="Enter reference..." (keydown)="onInputKeyDown($event)">
                    </mat-form-field>
                </div>
            </div>
        </div>

        <!-- Property Types Section -->
        <div class="w-full mt-6">
            <div class="text-xl">{{ 'settings.application.property_types' | transloco }}</div>
            <div class="text-secondary">{{ 'settings.application.property_types_description' | transloco }}</div>
        </div>
        
        <div class="w-full mt-6">
            <div class="flex flex-wrap gap-4">
                <button type="button" 
                        *ngFor="let propertyType of propertyTypesArray.controls; let i = index" 
                        (click)="togglePropertyType(i)"
                        class="property-type-chip-large"
                        [class.selected]="isPropertyTypeSelected(i)">
                    <span class="flex items-center gap-2">
                        {{ propertyType.value }}
                        <button type="button" 
                                (click)="removePropertyType(i); $event.stopPropagation()"
                                class="ml-1 text-red-500 hover:text-red-700">
                            ×
                        </button>
                    </span>
                </button>
                
                <!-- Inline Add Property Type -->
                <div *ngIf="!addingPropertyType" class="property-type-chip-large border-dashed border-2 border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/30">
                    <button type="button" 
                            (click)="startAddingPropertyType()"
                            class="flex items-center gap-2 text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300">
                        <span class="text-lg">+</span>
                        <span>{{ 'settings.application.add_property_type' | transloco }}</span>
                    </button>
                </div>
                
                <!-- Add Property Type Input -->
                <div *ngIf="addingPropertyType" class="property-type-chip-large bg-purple-50 dark:bg-purple-900/20 border-purple-300 dark:border-purple-600">
                    <div class="flex items-center gap-2">
                        <input type="text" 
                               [(ngModel)]="customPropertyType"
                               [ngModelOptions]="{standalone: true}"
                               [placeholder]="'settings.application.property_type_placeholder' | transloco"
                               class="flex-1 bg-transparent border-none outline-none text-gray-900 dark:text-white placeholder-gray-500"
                               (keyup.enter)="confirmAddPropertyType(); $event.preventDefault(); $event.stopPropagation()"
                               (keyup.escape)="cancelAddPropertyType()"
                               (keydown)="onInputKeyDown($event)"
                               autofocus>
                        <button type="button" 
                                (click)="confirmAddPropertyType()"
                                class="text-green-600 hover:text-green-700 text-sm">
                            ✓
                        </button>
                        <button type="button" 
                                (click)="cancelAddPropertyType()"
                                class="text-red-500 hover:text-red-700 text-sm">
                            ×
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Property Features Section -->
        <div class="w-full mt-6">
            <div class="text-xl">{{ 'settings.application.features' | transloco }}</div>
            <div class="text-secondary">{{ 'settings.application.features_description' | transloco }}</div>
        </div>
        
        <div class="w-full mt-6">
            <div class="flex flex-wrap gap-4">
                <button type="button" 
                        *ngFor="let feature of featuresArray.controls; let i = index" 
                        (click)="toggleFeature(i)"
                        class="feature-chip-large"
                        [class.selected]="isFeatureSelected(i)">
                    <span class="flex items-center gap-2">
                        {{ feature.value }}
                        <button type="button" 
                                (click)="removeFeature(i); $event.stopPropagation()"
                                class="ml-1 text-red-500 hover:text-red-700">
                            ×
                        </button>
                    </span>
                </button>
                
                <!-- Inline Add Feature -->
                <div *ngIf="!addingFeature" class="feature-chip-large border-dashed border-2 border-blue-300 dark:border-blue-600 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30">
                    <button type="button" 
                            (click)="startAddingFeature()"
                            class="flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300">
                        <span class="text-lg">+</span>
                        <span>{{ 'settings.application.add_feature' | transloco }}</span>
                    </button>
                </div>
                
                <!-- Add Feature Input -->
                <div *ngIf="addingFeature" class="feature-chip-large bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-600">
                    <div class="flex items-center gap-2">
                        <input type="text" 
                               [(ngModel)]="customFeature"
                               [ngModelOptions]="{standalone: true}"
                               [placeholder]="'settings.application.feature_placeholder' | transloco"
                               class="flex-1 bg-transparent border-none outline-none text-gray-900 dark:text-white placeholder-gray-500"
                               (keyup.enter)="confirmAddFeature(); $event.preventDefault(); $event.stopPropagation()"
                               (keyup.escape)="cancelAddFeature()"
                               (keydown)="onInputKeyDown($event)"
                               autofocus>
                        <button type="button" 
                                (click)="confirmAddFeature()"
                                class="text-green-600 hover:text-green-700 text-sm">
                            ✓
                        </button>
                        <button type="button" 
                                (click)="cancelAddFeature()"
                                class="text-red-500 hover:text-red-700 text-sm">
                            ×
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Property Amenities Section -->
        <div class="w-full mt-6">
            <div class="text-xl">{{ 'settings.application.amenities' | transloco }}</div>
            <div class="text-secondary">{{ 'settings.application.amenities_description' | transloco }}</div>
        </div>
        
        <div class="w-full mt-6">
            <div class="flex flex-wrap gap-4">
                <button type="button" 
                        *ngFor="let amenity of amenitiesArray.controls; let i = index" 
                        (click)="toggleAmenity(i)"
                        class="amenity-chip-large"
                        [class.selected]="isAmenitySelected(i)">
                    <span class="flex items-center gap-2">
                        {{ amenity.value }}
                        <button type="button" 
                                (click)="removeAmenity(i); $event.stopPropagation()"
                                class="ml-1 text-red-500 hover:text-red-700">
                            ×
                        </button>
                    </span>
                </button>
                
                <!-- Inline Add Amenity -->
                <div *ngIf="!addingAmenity" class="amenity-chip-large border-dashed border-2 border-green-300 dark:border-green-600 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30">
                    <button type="button" 
                            (click)="startAddingAmenity()"
                            class="flex items-center gap-2 text-green-600 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300">
                        <span class="text-lg">+</span>
                        <span>{{ 'settings.application.add_amenity' | transloco }}</span>
                    </button>
                </div>
                
                <!-- Add Amenity Input -->
                <div *ngIf="addingAmenity" class="amenity-chip-large bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-600">
                    <div class="flex items-center gap-2">
                        <input type="text" 
                               [(ngModel)]="customAmenity"
                               [ngModelOptions]="{standalone: true}"
                               [placeholder]="'settings.application.amenity_placeholder' | transloco"
                               class="flex-1 bg-transparent border-none outline-none text-gray-900 dark:text-white placeholder-gray-500"
                               (keyup.enter)="confirmAddAmenity(); $event.preventDefault(); $event.stopPropagation()"
                               (keyup.escape)="cancelAddAmenity()"
                               (keydown)="onInputKeyDown($event)"
                               autofocus>
                        <button type="button" 
                                (click)="confirmAddAmenity()"
                                class="text-green-600 hover:text-green-700 text-sm">
                            ✓
                        </button>
                        <button type="button" 
                                (click)="cancelAddAmenity()"
                                class="text-red-500 hover:text-red-700 text-sm">
                            ×
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-end mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <div class="flex gap-4">
                <button type="button" mat-stroked-button>
                    {{ 'common.cancel' | transloco }}
                </button>
                <button type="submit" mat-flat-button color="primary" [disabled]="isSaving">
                    <mat-spinner *ngIf="isSaving" diameter="20" class="mr-2"></mat-spinner>
                    <mat-icon *ngIf="!isSaving" [svgIcon]="'heroicons_outline:check'"></mat-icon>
                    {{ isSaving ? ('common.saving' | transloco) : ('common.save' | transloco) }}
                </button>
            </div>
        </div>
    </form>
    </div>
</div>
