<div class="absolute inset-0 flex flex-col min-w-0 overflow-hidden">

    <div class="flex flex-col h-full bg-card dark:bg-transparent">
        <!-- Main -->
        <div class="flex flex-col flex-auto overflow-hidden">
            <!-- Header -->
            <div class="py-6 px-6 md:px-8 border-b flex-shrink-0">
                <!-- Title -->
                <div class="mb-3 flex items-start justify-between">
                    <div class="flex-1">
                        <div class="text-2xl font-bold tracking-tight leading-none text-gray-900 dark:text-white">
                            {{ isViewMode ? (editMode ? 'Edit Reservation' : 'View Reservation Details') : 'Add New Reservation' }}
                        </div>
                        <div class="ml-0.5 text-sm font-medium text-gray-500 dark:text-gray-400">{{ getStepDescription() }}</div>
                    </div>
                </div>
                
                <!-- Buttons - Under Title -->
                <div class="flex items-center justify-between gap-2">
                    <button mat-stroked-button 
                            type="button"
                            [routerLink]="['/reservation']"
                            class="min-w-0">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:arrow-left'"></mat-icon>
                        <span class="ml-2">Back to Reservations</span>
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <!-- Edit Button (show when in view mode but not in edit mode) -->
                        <button *ngIf="isViewMode && !editMode"
                                mat-flat-button 
                                type="button"
                                (click)="toggleEditMode(true)"
                                class="bg-blue-600 text-white hover:bg-blue-700">
                            <mat-icon class="icon-size-5" [svgIcon]="'heroicons_solid:pencil-square'"></mat-icon>
                            <span class="ml-2">Edit</span>
                        </button>
                        
                        <!-- Cancel Button (show when in edit mode) -->
                        <button *ngIf="isViewMode && editMode"
                                mat-stroked-button 
                                type="button"
                                (click)="toggleEditMode(false)">
                            <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                            <span class="ml-2">Cancel</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress Bar and Steps -->
            <div class="px-6 md:px-8 py-4 border-b">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm font-medium text-gray-900 dark:text-white">Step {{ currentStep }} of {{ totalSteps }}</span>
                    <span class="text-sm text-gray-500 dark:text-gray-400">{{ Math.round(getProgressPercentage()) }}%</span>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-6">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                         [style.width.%]="getProgressPercentage()"></div>
                </div>
                
                <!-- Steps Navigation -->
                <div class="flex justify-between">
                    <div *ngFor="let step of steps" 
                         class="flex flex-col items-center"
                         [class.opacity-50]="step.number > currentStep"
                         [class.cursor-not-allowed]="step.number > currentStep"
                         [class.cursor-default]="step.number <= currentStep">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mb-2 transition-all duration-200"
                             [class.bg-blue-600]="step.number === currentStep"
                             [class.bg-green-600]="step.number < currentStep"
                             [class.bg-gray-300]="step.number > currentStep"
                             [class.dark:bg-gray-600]="step.number > currentStep">
                            <mat-icon *ngIf="step.number < currentStep" 
                                      class="text-white text-sm" 
                                      [svgIcon]="'heroicons_outline:check'"></mat-icon>
                            <mat-icon *ngIf="step.number >= currentStep" 
                                      class="text-white text-sm" 
                                      [svgIcon]="step.icon"></mat-icon>
                        </div>
                        <div class="text-center">
                            <div class="text-xs font-medium text-gray-900 dark:text-white">{{ step.title }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 hidden md:block">{{ step.description }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step Content -->
            <div class="flex-auto overflow-y-auto p-6 md:px-8">
                
                <!-- Step 1: Global Info -->
                <div *ngIf="currentStep === 1" class="space-y-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">{{ getStepTitle() }}</h2>
                    </div>
                    
                    <form [formGroup]="reservationForm">
                        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                            <div class="text-2xl font-semibold mb-6">Reservation Information</div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                
                                <!-- Property Selection -->
                                <div class="w-full">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                        Property 
                                        <span class="text-red-500">*</span>
                                    </label>
                                    
                                    <!-- Search Input with Add Button -->
                                    <div class="relative" #propertyDropdownContainer>
                                        <div class="flex gap-2 items-start">
                                            <mat-form-field [ngClass]="formFieldHelpers" class="flex-1">
                                                <input matInput 
                                                       type="text"
                                                       [(ngModel)]="propertySearchTerm"
                                                       [ngModelOptions]="{standalone: true}"
                                                       [disabled]="isReadOnly() || isPropertyTenantReadOnly()"
                                                       (ngModelChange)="filterProperties()"
                                                       (focus)="!(isReadOnly() || isPropertyTenantReadOnly()) ? showPropertyDropdown = true : onInputClick()"
                                                       (click)="!(isReadOnly() || isPropertyTenantReadOnly()) ? showPropertyDropdown = true : onInputClick(); $event.stopPropagation()"
                                                       placeholder="Type to search properties..."
                                                       autocomplete="off">
                                                <mat-icon matPrefix class="text-gray-400">search</mat-icon>
                                            </mat-form-field>
                                            
                                            <!-- Add New Property Button (inline) -->
                                            <button *ngIf="!(isReadOnly() || isPropertyTenantReadOnly())" 
                                                    mat-flat-button 
                                                    type="button"
                                                    (click)="openAddPropertyDialog(); $event.stopPropagation()"
                                                    class="whitespace-nowrap bg-green-600 hover:bg-green-700 text-white"
                                                    style="height: 56px;">
                                                <mat-icon class="icon-size-5">add</mat-icon>
                                                <span class="ml-1">New</span>
                                            </button>
                                        </div>
                                        
                                        <!-- Dropdown -->
                                        <div *ngIf="!(isReadOnly() || isPropertyTenantReadOnly()) && showPropertyDropdown && filteredProperties && filteredProperties.length > 0" 
                                             class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto"
                                             (click)="$event.stopPropagation()">
                                            <div *ngFor="let property of filteredProperties" 
                                                 class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-200 dark:border-gray-700 last:border-b-0"
                                                 (click)="selectProperty(property)">
                                                <div class="font-medium text-gray-900 dark:text-white">
                                                    {{ property.name }}
                                                </div>
                                                <div class="text-sm text-gray-500 dark:text-gray-400 space-y-1">
                                                    <div *ngIf="property.identifier" class="flex items-center gap-1">
                                                        <mat-icon class="icon-size-3" [svgIcon]="'heroicons_outline:identification'"></mat-icon>
                                                        <span>{{ property.identifier }}</span>
                                                    </div>
                                                    <div *ngIf="property.address" class="flex items-center gap-1">
                                                        <mat-icon class="icon-size-3" [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                                                        <span>{{ property.address }}</span>
                                                    </div>
                                                    <div *ngIf="property.ownerName" class="flex items-center gap-1">
                                                        <mat-icon class="icon-size-3" [svgIcon]="'heroicons_outline:user'"></mat-icon>
                                                        <span>Owner: {{ property.ownerName }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Selected Property Display -->
                                    <div *ngIf="reservationForm.get('propertyId')?.value" class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <div class="font-semibold text-blue-900 dark:text-blue-100">
                                                        {{ getSelectedProperty()?.name }}
                                                    </div>
                                                    <mat-icon class="text-blue-600 icon-size-5" [svgIcon]="'heroicons_outline:check-circle'"></mat-icon>
                                                </div>
                                                <div class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                                                    <div *ngIf="getSelectedProperty()?.identifier" class="flex items-center gap-2">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:identification'"></mat-icon>
                                                        <span>{{ getSelectedProperty()?.identifier }}</span>
                                                    </div>
                                                    <div *ngIf="getSelectedProperty()?.address" class="flex items-center gap-2">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                                                        <span>{{ getSelectedProperty()?.address }}</span>
                                                    </div>
                                                    <div *ngIf="getSelectedProperty()?.ownerName" class="flex items-center gap-2">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:user'"></mat-icon>
                                                        <span>Owner: {{ getSelectedProperty()?.ownerName }}</span>
                                                    </div>
                                                </div>
                                                <!-- View Property Details Link -->
                                                <div *ngIf="isViewMode" class="mt-3">
                                                    <a [routerLink]="['/property', reservationForm.get('propertyId')?.value]"
                                                       class="inline-flex items-center gap-1 text-xs font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors"
                                                       (click)="$event.stopPropagation()">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:arrow-top-right-on-square'"></mat-icon>
                                                        <span>View Property Details</span>
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            <!-- Close Button -->
                                            <button *ngIf="!(isReadOnly() || isPropertyTenantReadOnly())" 
                                                    mat-icon-button 
                                                    type="button"
                                                    (click)="clearProperty()"
                                                    class="text-blue-600 hover:text-blue-800 -mt-2 -mr-2">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tenant Selection -->
                                <div class="w-full">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                        Tenant 
                                        <span class="text-red-500">*</span>
                                    </label>
                                    
                                    <!-- Search Input with Add Button -->
                                    <div class="relative" #tenantDropdownContainer>
                                        <div class="flex gap-2 items-start">
                                            <mat-form-field [ngClass]="formFieldHelpers" class="flex-1">
                                                <input matInput 
                                                       type="text"
                                                       [(ngModel)]="tenantSearchTerm"
                                                       [ngModelOptions]="{standalone: true}"
                                                       [disabled]="isReadOnly() || isPropertyTenantReadOnly()"
                                                       (ngModelChange)="filterTenants()"
                                                       (focus)="!(isReadOnly() || isPropertyTenantReadOnly()) ? showTenantDropdown = true : onInputClick()"
                                                       (click)="!(isReadOnly() || isPropertyTenantReadOnly()) ? showTenantDropdown = true : onInputClick(); $event.stopPropagation()"
                                                       placeholder="Type to search tenants..."
                                                       autocomplete="off">
                                                <mat-icon matPrefix class="text-gray-400">search</mat-icon>
                                            </mat-form-field>
                                            
                                            <!-- Add New Tenant Button (inline) -->
                                            <button *ngIf="!(isReadOnly() || isPropertyTenantReadOnly())" 
                                                    mat-flat-button 
                                                    type="button"
                                                    (click)="openAddTenantDialog(); $event.stopPropagation()"
                                                    class="whitespace-nowrap bg-green-600 hover:bg-green-700 text-white"
                                                    style="height: 56px;">
                                                <mat-icon class="icon-size-5">add</mat-icon>
                                                <span class="ml-1">New</span>
                                            </button>
                                        </div>
                                        
                                        <!-- Dropdown -->
                                        <div *ngIf="!(isReadOnly() || isPropertyTenantReadOnly()) && showTenantDropdown && filteredTenants && filteredTenants.length > 0" 
                                             class="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto"
                                             (click)="$event.stopPropagation()">
                                            <div *ngFor="let tenant of filteredTenants" 
                                                 class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-200 dark:border-gray-700 last:border-b-0"
                                                 (click)="selectTenant(tenant)">
                                                <div class="font-medium text-gray-900 dark:text-white">
                                                    {{ tenant.name }}
                                                </div>
                                                <div class="text-sm text-gray-500 dark:text-gray-400 space-y-1">
                                                    <div *ngIf="tenant.identifier" class="flex items-center gap-1">
                                                        <mat-icon class="icon-size-3" [svgIcon]="'heroicons_outline:identification'"></mat-icon>
                                                        <span>{{ tenant.identifier }}</span>
                                                    </div>
                                                    <div *ngIf="tenant.email" class="flex items-center gap-1">
                                                        <mat-icon class="icon-size-3" [svgIcon]="'heroicons_outline:envelope'"></mat-icon>
                                                        <span>{{ tenant.email }}</span>
                                                    </div>
                                                    <div *ngIf="tenant.phones && tenant.phones.length > 0" class="flex items-center gap-1">
                                                        <mat-icon class="icon-size-3" [svgIcon]="'heroicons_outline:phone'"></mat-icon>
                                                        <span>{{ tenant.phones[0] }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Selected Tenant Display -->
                                    <div *ngIf="reservationForm.get('contactId')?.value" class="mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-lg">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <div class="font-semibold text-green-900 dark:text-green-100">
                                                        {{ getSelectedTenant()?.name }}
                                                    </div>
                                                    <mat-icon class="text-green-600 icon-size-5" [svgIcon]="'heroicons_outline:check-circle'"></mat-icon>
                                                </div>
                                                <div class="text-sm text-green-700 dark:text-green-300 space-y-1">
                                                    <div *ngIf="getSelectedTenant()?.identifier" class="flex items-center gap-2">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:identification'"></mat-icon>
                                                        <span>{{ getSelectedTenant()?.identifier }}</span>
                                                    </div>
                                                    <div *ngIf="getSelectedTenant()?.email" class="flex items-center gap-2">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:envelope'"></mat-icon>
                                                        <span>{{ getSelectedTenant()?.email }}</span>
                                                    </div>
                                                    <div *ngIf="getSelectedTenant()?.phones && getSelectedTenant()?.phones.length > 0" class="flex items-center gap-2">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:phone'"></mat-icon>
                                                        <span>{{ getSelectedTenant()?.phones[0] }}</span>
                                                    </div>
                                                </div>
                                                <!-- View Tenant Details Link -->
                                                <div *ngIf="isViewMode" class="mt-3">
                                                    <a [routerLink]="['/contacts', reservationForm.get('contactId')?.value]"
                                                       class="inline-flex items-center gap-1 text-xs font-medium text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 transition-colors"
                                                       (click)="$event.stopPropagation()">
                                                        <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:arrow-top-right-on-square'"></mat-icon>
                                                        <span>View Contact Details</span>
                                                    </a>
                                                </div>
                                            </div>
                                            
                                            <!-- Close Button -->
                                            <button *ngIf="!(isReadOnly() || isPropertyTenantReadOnly())" 
                                                    mat-icon-button 
                                                    type="button"
                                                    (click)="clearTenant()"
                                                    class="text-green-600 hover:text-green-800 -mt-2 -mr-2">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Durée Section -->
                                <div class="w-full md:col-span-2">
                                    <div class="text-lg font-semibold mb-4 mt-4">Durée</div>
                                </div>

                                <!-- Date Fields Row: Arrival, Departure, Nuits -->
                                <div class="w-full md:col-span-2">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <!-- Arrival Date -->
                                        <div class="w-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Arrivée <span class="text-red-500">*</span>
                                            </label>
                                            <mat-form-field [ngClass]="formFieldHelpers" class="w-full custom-date-field">
                                                <input matInput 
                                                       [matDatepicker]="arrivalPicker" 
                                                       formControlName="arrivalDate"
                                                       [readonly]="isReadOnly()"
                                                       (click)="onInputClick()"
                                                       placeholder="Sélectionner la date d'arrivée">
                                                <mat-datepicker-toggle matSuffix [for]="arrivalPicker" [disabled]="isReadOnly()"></mat-datepicker-toggle>
                                                <mat-datepicker #arrivalPicker></mat-datepicker>
                                            </mat-form-field>
                                        </div>

                                        <!-- Departure Date -->
                                        <div class="w-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Départ <span class="text-red-500">*</span>
                                            </label>
                                            <mat-form-field [ngClass]="formFieldHelpers" class="w-full custom-date-field">
                                                <input matInput 
                                                       [matDatepicker]="departurePicker" 
                                                       formControlName="departureDate"
                                                       [readonly]="isReadOnly()"
                                                       (click)="onInputClick()"
                                                       placeholder="Sélectionner la date de départ">
                                                <mat-datepicker-toggle matSuffix [for]="departurePicker" [disabled]="isReadOnly()"></mat-datepicker-toggle>
                                                <mat-datepicker #departurePicker></mat-datepicker>
                                            </mat-form-field>
                                        </div>

                                        <!-- Number of Nights (Calculated) -->
                                        <div class="w-full">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                Nuits
                                            </label>
                                            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700">
                                                <div class="text-2xl font-bold text-primary">{{ numberOfNights }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Total Amount -->
                                <div class="w-full">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Montant <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" 
                                           class="form-input"
                                           formControlName="totalAmount"
                                           [readonly]="isReadOnly()"
                                           (click)="onInputClick()"
                                           placeholder="Saisir le montant total">
                                </div>

                                <!-- Description -->
                                <div class="w-full">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Description
                                    </label>
                                    <textarea class="form-input"
                                              formControlName="description"
                                              [readonly]="isReadOnly()"
                                              (click)="onInputClick()"
                                              rows="3"
                                              placeholder="Saisir la description de la réservation"></textarea>
                                </div>

                            </div>
                        </div>
                    </form>
                </div>

                <!-- Step 2: Additional Info -->
                <div *ngIf="currentStep === 2" class="space-y-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">{{ getStepTitle() }}</h2>
                    </div>
                    
                    <form [formGroup]="additionalInfoForm">
                        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                            
                            <!-- Special Terms -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Conditions particulières
                                </label>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
                                    Saisir les conditions particulières. Ces informations sont reprises sur le bail.
                                </p>
                                <textarea class="form-input"
                                          formControlName="specialTerms"
                                          [readonly]="isReadOnly()"
                                          (click)="onInputClick()"
                                          rows="6"
                                          placeholder="Saisir les conditions particulières"></textarea>
                            </div>

                            <!-- Private Note -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Notes / Commentaires
                                </label>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
                                    Note privée
                                </p>
                                <textarea class="form-input"
                                          formControlName="privateNote"
                                          [readonly]="isReadOnly()"
                                          (click)="onInputClick()"
                                          rows="6"
                                          placeholder="Saisir des notes privées et commentaires"></textarea>
                            </div>

                        </div>
                    </form>
                </div>

                <!-- Step 3: Documents -->
                <div *ngIf="currentStep === 3" class="space-y-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">{{ getStepTitle() }}</h2>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                        
                        <!-- Upload Section (Edit Mode Only) -->
                        <div *ngIf="!isReadOnly()" class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">New Documents</h3>
                                <input #fileInput 
                                       type="file" 
                                       multiple 
                                       (change)="onFileSelected($event); fileInput.value = ''"
                                       class="hidden"
                                       accept="image/*, application/pdf, .doc, .docx, .xls, .xlsx, .txt">
                                <button mat-flat-button 
                                        color="primary" 
                                        type="button"
                                        (click)="fileInput.click()">
                                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:arrow-up-tray'"></mat-icon>
                                    <span class="ml-2">Upload Files</span>
                                </button>
                            </div>

                            <!-- Documents to Upload Queue -->
                            <div *ngIf="attachmentsToAdd.length > 0" class="mb-4">
                                <div class="text-sm font-medium mb-3 text-blue-700 dark:text-blue-300">Files to be uploaded when saving:</div>
                                <div class="grid grid-cols-1 gap-3">
                                    <div *ngFor="let doc of attachmentsToAdd; let i = index" 
                                         class="flex items-center gap-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700">
                                        <mat-icon class="icon-size-6 text-green-600" [svgIcon]="'heroicons_outline:document'"></mat-icon>
                                        <div class="flex-1 min-w-0">
                                            <div class="text-sm font-medium truncate">{{ doc.fileName }}</div>
                                            <div class="text-xs text-green-600">Ready to upload</div>
                                        </div>
                                        <button mat-icon-button
                                                type="button"
                                                (click)="removeDocumentFromQueue(i)">
                                            <mat-icon class="text-warn icon-size-4" [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div *ngIf="attachmentsToAdd.length === 0" class="text-sm text-blue-600 dark:text-blue-400 italic">
                                No files selected for upload. Click "Upload Files" to add attachments.
                            </div>
                        </div>

                        <!-- Existing Documents -->
                        <div *ngIf="!isReadOnly() || (attachments && attachments.length > 0)">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                    {{ !isReadOnly() ? 'Current Documents' : 'Documents' }}
                                </h3>
                            </div>

                            <!-- Documents List -->
                            <div *ngIf="attachments && attachments.length > 0" class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                                <div *ngFor="let doc of attachments; trackBy: trackByFn" 
                                     class="flex items-center gap-4 p-4 rounded-lg border transition-colors"
                                     [ngClass]="{
                                         'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700 opacity-50': !isReadOnly() && isDocumentMarkedForDeletion(doc.id),
                                         'bg-card border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800': isReadOnly() || !isDocumentMarkedForDeletion(doc.id),
                                         'cursor-pointer': isReadOnly()
                                     }"
                                     (click)="isReadOnly() ? viewAttachment(doc) : null">
                                    
                                    <mat-icon class="icon-size-8"
                                              [ngClass]="{
                                                  'text-red-600': !isReadOnly() && isDocumentMarkedForDeletion(doc.id),
                                                  'text-primary': isReadOnly() || !isDocumentMarkedForDeletion(doc.id)
                                              }"
                                              [svgIcon]="getFileIcon(doc.fileExtension)"></mat-icon>
                                    
                                    <div class="flex-1 min-w-0">
                                        <fuse-filename-display
                                            [filename]="doc.originalFileName || doc.fileName"
                                            [maxLength]="25"
                                            [truncateMode]="'middle'"
                                            [showExtension]="true"
                                            cssClass="text-sm font-semibold leading-relaxed">
                                        </fuse-filename-display>
                                        <div class="text-xs mt-1"
                                             [ngClass]="{
                                                 'text-red-600': !isReadOnly() && isDocumentMarkedForDeletion(doc.id),
                                                 'text-secondary': isReadOnly() || !isDocumentMarkedForDeletion(doc.id)
                                             }">
                                            <span *ngIf="!isReadOnly() && isDocumentMarkedForDeletion(doc.id)">Marked for deletion • </span>
                                            {{ formatFileSize(doc.fileSize) }} • {{ doc.createdAt | date:'short' }}
                                        </div>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="flex items-center gap-1">
                                        <!-- Edit Mode Actions -->
                                        <button *ngIf="!isReadOnly() && !isDocumentMarkedForDeletion(doc.id)"
                                                mat-icon-button
                                                type="button"
                                                (click)="$event.stopPropagation(); markDocumentForDeletion(doc.id)"
                                                matTooltip="Mark for deletion">
                                            <mat-icon class="text-warn icon-size-5" [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                                        </button>
                                        <button *ngIf="!isReadOnly() && isDocumentMarkedForDeletion(doc.id)"
                                                mat-icon-button
                                                type="button"
                                                (click)="$event.stopPropagation(); cancelDocumentDeletion(doc.id)"
                                                matTooltip="Cancel deletion">
                                            <mat-icon class="text-green-600 icon-size-5" [svgIcon]="'heroicons_outline:arrow-uturn-left'"></mat-icon>
                                        </button>
                                        <!-- View Mode Actions -->
                                        <mat-icon *ngIf="isReadOnly()" class="icon-size-5 text-hint" [svgIcon]="'heroicons_outline:eye'"></mat-icon>
                                    </div>
                                </div>
                            </div>

                            <!-- No Documents -->
                            <div *ngIf="!attachments || attachments.length === 0" 
                                 class="flex flex-col items-center justify-center py-16 text-center">
                                <mat-icon class="icon-size-24 text-hint mb-4" [svgIcon]="'heroicons_outline:document'"></mat-icon>
                                <div class="text-lg font-medium text-secondary">No attachments yet</div>
                                <div *ngIf="isReadOnly()" class="mt-2 text-sm text-hint">
                                    Click "Edit" to upload attachments for this reservation
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Step 4: Notifications -->
                <div *ngIf="currentStep === 4" class="space-y-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">{{ getStepTitle() }}</h2>
                    </div>
                    
                    <form [formGroup]="notificationsForm">
                        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                            <div class="text-2xl font-semibold mb-6">WhatsApp Notifications</div>
                            
                            <!-- Enable Notifications -->
                            <div class="mb-6">
                                <mat-checkbox formControlName="enableNotifications" 
                                              color="primary"
                                              [disabled]="isReadOnly()"
                                              (click)="onDisabledElementClick($event)">
                                    <span class="font-medium">Enable Notifications</span>
                                </mat-checkbox>
                                <p class="text-sm text-gray-500 mt-2 ml-8">
                                    Activate automatic WhatsApp notifications for this reservation
                                </p>
                            </div>

                            <div *ngIf="notificationsForm.get('enableNotifications')?.value" class="space-y-4 ml-8">
                                <!-- Entry Notification -->
                                <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                    <mat-checkbox formControlName="notificationWhatsappEntry" 
                                                  color="primary"
                                                  [disabled]="isReadOnly()"
                                                  (click)="onDisabledElementClick($event)">
                                        <span class="font-medium">Send notification when tenant enters</span>
                                    </mat-checkbox>
                                    <p class="text-sm text-gray-500 mt-2 ml-8">
                                        A WhatsApp message will be sent to the tenant on their arrival date
                                    </p>
                                </div>

                                <!-- Exit Notification -->
                                <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                    <mat-checkbox formControlName="notificationWhatsappExit" 
                                                  color="primary"
                                                  [disabled]="isReadOnly()"
                                                  (click)="onDisabledElementClick($event)">
                                        <span class="font-medium">Send notification when tenant should leave</span>
                                    </mat-checkbox>
                                    <p class="text-sm text-gray-500 mt-2 ml-8">
                                        A WhatsApp message will be sent to the tenant on their departure date
                                    </p>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between pt-8 border-t border-gray-200 dark:border-gray-700 mt-8">
                    <!-- View Mode Buttons (Read-only) -->
                    <div *ngIf="isViewMode && !editMode" class="flex justify-between w-full">
                        <button type="button" 
                                mat-stroked-button
                                (click)="previousStep()"
                                [disabled]="currentStep === 1">
                            Previous
                        </button>
                        
                        <button type="button" 
                                mat-stroked-button
                                (click)="nextStep()"
                                *ngIf="currentStep < totalSteps">
                            Next
                        </button>
                    </div>
                    
                    <!-- Create/Edit Mode Buttons -->
                    <ng-container *ngIf="!isViewMode || editMode">
                        <button type="button" 
                                mat-stroked-button
                                (click)="previousStep()"
                                [disabled]="currentStep === 1 || isLoading">
                            Previous
                        </button>
                        
                        <button type="button" 
                                mat-flat-button
                                color="primary"
                                (click)="nextStep()"
                                [disabled]="!isCurrentStepValid() || isLoading"
                                class="flex items-center gap-2">
                            <mat-icon *ngIf="isLoading && currentStep === totalSteps" 
                                      class="icon-size-5 animate-spin text-white" 
                                      [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
                            <span *ngIf="isLoading && currentStep === totalSteps">{{ isEditMode ? 'Updating Reservation...' : 'Creating Reservation...' }}</span>
                            <span *ngIf="!isLoading || currentStep !== totalSteps">{{ currentStep === totalSteps ? (isEditMode ? 'Update Reservation' : 'Create Reservation') : 'Next' }}</span>
                        </button>
                    </ng-container>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Document Viewer -->
<app-document-viewer
    [documentType]="selectedDocumentType"
    [documentUrl]="selectedDocumentUrl"
    [documentName]="selectedDocumentName"
    [originalDocumentUrl]="originalDocumentUrl"
    [fileSize]="selectedFileSize"
    [isOpen]="isDocumentViewerOpen"
    (close)="closeDocumentViewer()">
</app-document-viewer>

<!-- PDF Viewer -->
<app-pdf-viewer
    [pdfUrl]="selectedPdfUrl"
    [pdfName]="selectedPdfName"
    [fileSize]="selectedPdfSize"
    [isOpen]="isPdfViewerOpen"
    (close)="closePdfViewer()">
</app-pdf-viewer>

<!-- Image Viewer -->
<app-image-viewer
    [imageUrl]="selectedImageUrl"
    [imageName]="selectedImageName"
    [fileSize]="selectedImageSize"
    [images]="selectedImages"
    [currentIndex]="selectedImageIndex"
    [isOpen]="isImageViewerOpen"
    (close)="closeImageViewer()"
    (imageChanged)="onImageChanged($event)">
</app-image-viewer>
