<div class="task-dialog flex flex-col w-full">
    <mat-dialog-content class="flex flex-col flex-auto -m-6 p-6">

        <div class="dialog-header">
            <div>
                <h2 class="title">
                    {{ mode === 'create' ? 'Add Task' : 'Edit Task' }}
                </h2>
                <p class="subtitle">
                    Plan and assign work for your team, linked to contacts or properties.
                </p>
            </div>
            <button mat-icon-button (click)="close()" [disabled]="isSaving">
                <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
            </button>
        </div>

        <form class="task-form" [formGroup]="form" [class.loading]="isLoadingTask">

            <div class="grid gap-4 lg:grid-cols-2">
                <mat-form-field [ngClass]="formFieldHelpers" class="col-span-full">
                    <mat-label>Task Title</mat-label>
                    <input matInput formControlName="title">
                    <mat-icon matPrefix [svgIcon]="'heroicons_outline:clipboard-document'"></mat-icon>
                    <mat-error *ngIf="form.get('title')?.hasError('required')">Title is required</mat-error>
                    <mat-error *ngIf="form.get('title')?.hasError('maxlength')">Maximum 150 characters</mat-error>
                </mat-form-field>

                <mat-form-field [ngClass]="formFieldHelpers">
                    <mat-label>Assign To</mat-label>
                    <mat-select formControlName="assignedUserId" required>
                        <mat-option *ngFor="let member of teamMembers" [value]="member.id">
                            <div class="flex flex-col">
                                <span class="font-medium">{{ member.name }}</span>
                                <span class="text-xs text-secondary" *ngIf="member.email">{{ member.email }}</span>
                            </div>
                        </mat-option>
                    </mat-select>
                    <mat-icon matPrefix [svgIcon]="'heroicons_outline:user-circle'"></mat-icon>
                    <mat-error *ngIf="form.get('assignedUserId')?.hasError('required')">Assigned user is required</mat-error>
                </mat-form-field>

                <mat-form-field [ngClass]="formFieldHelpers">
                    <mat-label>Priority</mat-label>
                    <mat-select formControlName="priority" required [compareWith]="compareValues">
                        <mat-option *ngFor="let priority of priorities" [value]="priority.value">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full" [ngClass]="'bg-' + priority.color + '-500'"></span>
                                <span>{{ priority.label }}</span>
                            </div>
                        </mat-option>
                    </mat-select>
                    <mat-icon matPrefix [svgIcon]="'heroicons_outline:flag'"></mat-icon>
                </mat-form-field>

                <mat-form-field [ngClass]="formFieldHelpers">
                    <mat-label>Scheduled Date</mat-label>
                    <input matInput [matDatepicker]="datePicker" formControlName="scheduledDate" [min]="minDate">
                    <mat-datepicker-toggle matSuffix [for]="datePicker"></mat-datepicker-toggle>
                    <mat-datepicker #datePicker></mat-datepicker>
                    <mat-icon matPrefix [svgIcon]="'heroicons_outline:calendar-days'"></mat-icon>
                    <mat-error *ngIf="form.get('scheduledDate')?.hasError('required')">Date is required</mat-error>
                </mat-form-field>
            </div>

            <mat-divider></mat-divider>

            <div class="assignment-section">
                <div class="section-header">
                    <div>
                        <div class="section-title">Link To</div>
                        <div class="section-subtitle">Associate this task with a contact or property for better context.</div>
                    </div>
                </div>

                <mat-button-toggle-group formControlName="assignmentType" class="assignment-toggle">
                    <mat-button-toggle value="none">
                        <mat-icon class="icon-size-4 mr-2" [svgIcon]="'heroicons_outline:minus-circle'"></mat-icon>
                        None
                    </mat-button-toggle>
                    <mat-button-toggle value="contact">
                        <mat-icon class="icon-size-4 mr-2" [svgIcon]="'heroicons_outline:user-group'"></mat-icon>
                        Contact
                    </mat-button-toggle>
                    <mat-button-toggle value="property">
                        <mat-icon class="icon-size-4 mr-2" [svgIcon]="'heroicons_outline:building-office-2'"></mat-icon>
                        Property
                    </mat-button-toggle>
                </mat-button-toggle-group>

            </div>

            <!-- Contact Searchable Dropdown -->
            <div class="relative" *ngIf="assignmentType === 'contact'">
                <mat-form-field [ngClass]="formFieldHelpers" class="w-full">
                    <mat-label>Select Contact</mat-label>
                    <input matInput type="text"
                           [value]="isEditingContact ? contactSearchTerm : getSelectedContactName()"
                           (input)="onContactInput($event)"
                           (focus)="onContactFocus()"
                           (blur)="onContactBlur()"
                           autocomplete="off">
                    <mat-icon matPrefix [svgIcon]="'heroicons_outline:user-group'"></mat-icon>
                    <button mat-icon-button matSuffix *ngIf="form.get('contactId')?.value"
                            (mousedown)="clearContactSelection(); $event.preventDefault(); $event.stopPropagation()"
                            tabindex="-1">
                        <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                    </button>
                </mat-form-field>

                <div *ngIf="showContactDropdown"
                     class="absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-72 overflow-y-auto">
                    <div *ngFor="let contact of filteredContacts"
                         class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 border-b border-gray-200 dark:border-gray-700 last:border-b-0"
                         (mousedown)="selectContact(contact.id)">
                        <div class="font-medium text-gray-900 dark:text-white">
                            {{ contact.isACompany ? contact.companyName : (contact.firstName + ' ' + contact.lastName) }}
                        </div>
                        <div class="text-sm text-secondary" *ngIf="contact.email">{{ contact.email }}</div>
                    </div>
                    <div *ngIf="filteredContacts.length === 0" class="px-4 py-3 text-secondary flex items-center gap-2">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:magnifying-glass'"></mat-icon>
                        <span>No contacts found</span>
                    </div>
                </div>
            </div>

            <!-- Property Searchable Dropdown -->
            <div class="relative" *ngIf="assignmentType === 'property'">
                <mat-form-field [ngClass]="formFieldHelpers" class="w-full">
                    <mat-label>Select Property</mat-label>
                    <input matInput type="text"
                           [value]="isEditingProperty ? propertySearchTerm : getSelectedPropertyName()"
                           (input)="onPropertyInput($event)"
                           (focus)="onPropertyFocus()"
                           (blur)="onPropertyBlur()"
                           autocomplete="off">
                    <mat-icon matPrefix [svgIcon]="'heroicons_outline:building-office-2'"></mat-icon>
                    <button mat-icon-button matSuffix *ngIf="form.get('propertyId')?.value"
                            (mousedown)="clearPropertySelection(); $event.preventDefault(); $event.stopPropagation()"
                            tabindex="-1">
                        <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                    </button>
                </mat-form-field>

                <div *ngIf="showPropertyDropdown"
                     class="absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-72 overflow-y-auto">
                    <div *ngFor="let property of filteredProperties"
                         class="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 border-b border-gray-200 dark:border-gray-700 last:border-b-0"
                         (mousedown)="selectProperty(property.id)">
                        <div class="font-medium text-gray-900 dark:text-white">
                            {{ property.name || property.identifier || 'Unnamed property' }}
                        </div>
                        <div class="text-sm text-secondary" *ngIf="property.address">{{ property.address }}</div>
                    </div>
                    <div *ngIf="filteredProperties.length === 0" class="px-4 py-3 text-secondary flex items-center gap-2">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:magnifying-glass'"></mat-icon>
                        <span>No properties found</span>
                    </div>
                </div>
            </div>

            <mat-form-field [ngClass]="formFieldHelpers" class="col-span-full">
                <mat-label>Description</mat-label>
                <textarea matInput formControlName="description" rows="4"></textarea>
                <mat-icon matPrefix [svgIcon]="'heroicons_outline:document-text'"></mat-icon>
                <mat-hint align="start">Give your assignee all the context they need to complete this task.</mat-hint>
                <mat-error *ngIf="form.get('description')?.hasError('maxlength')">Maximum 5000 characters</mat-error>
            </mat-form-field>
        </form>

        <div class="loading-overlay" *ngIf="isLoadingTask">
            <mat-progress-spinner diameter="42" mode="indeterminate"></mat-progress-spinner>
        </div>
    </mat-dialog-content>

    <mat-dialog-actions class="dialog-actions">
        <button mat-stroked-button (click)="close()" [disabled]="isSaving">Cancel</button>
        <button mat-flat-button color="primary" (click)="save()" [disabled]="isSaving || form.invalid">
            <mat-progress-spinner *ngIf="isSaving" [diameter]="18" mode="indeterminate"></mat-progress-spinner>
            <span class="ml-2">{{ mode === 'create' ? 'Create Task' : 'Update Task' }}</span>
        </button>
    </mat-dialog-actions>
</div>

