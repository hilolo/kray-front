<div class="absolute inset-0 flex flex-col min-w-0 overflow-hidden">
    <div class="flex flex-col h-full bg-card dark:bg-transparent">
        <!-- Main -->
        <div class="flex flex-col flex-auto overflow-hidden">
            <!-- Header -->
            <div class="py-6 px-6 md:px-8 border-b flex-shrink-0">
                <!-- Buttons -->
                <div class="flex items-center justify-between gap-2">
                    <button mat-stroked-button 
                            type="button"
                            (click)="cancel()"
                            class="min-w-0">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:arrow-left'"></mat-icon>
                        <span class="ml-2">Back</span>
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <button mat-stroked-button 
                                type="button"
                                (click)="cancel()">
                            <span>Cancel</span>
                        </button>
                        <button mat-flat-button 
                                type="button"
                                [color]="'primary'"
                                [disabled]="contactForm.invalid"
                                (click)="saveContact()">
                            <span>Save</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Form Content -->
            <div class="flex-auto overflow-y-auto">
                <div class="flex flex-1 overflow-hidden">
                    <form [formGroup]="contactForm" class="flex flex-1">
                        
                        <!-- Left Sidebar - Profile Information -->
                        <div class="w-80 lg:w-80 md:w-72 sm:w-64 bg-card border-r border-gray-200 dark:border-gray-700 flex flex-col hidden lg:flex">
                            
                            <!-- Profile Section -->
                            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                <!-- Avatar -->
                                <div class="flex flex-col items-center mb-6">
                                    <div class="relative w-24 h-24 mb-4">
                                        <div class="w-full h-full rounded-full overflow-hidden bg-gray-100 dark:bg-gray-800 flex items-center justify-center border-2 border-gray-300 dark:border-gray-600">
                                            <ng-container *ngIf="avatarUrl">
                                                <img
                                                    class="object-cover w-full h-full"
                                                    [src]="avatarUrl"
                                                    alt="Contact avatar"/>
                                            </ng-container>
                                            <ng-container *ngIf="!avatarUrl">
                                                <div class="flex flex-col items-center justify-center text-center p-2">
                                                    <mat-icon class="icon-size-8 text-hint" [svgIcon]="'heroicons_outline:user-circle'"></mat-icon>
                                                    <div class="mt-1 text-xs text-secondary">Aucune photo</div>
                                                </div>
                                            </ng-container>
                                        </div>
                                    </div>

                                    <!-- Contact Type -->
                                    <div class="text-center mb-4">
                                        <p class="text-sm text-gray-500 dark:text-gray-400">
                                            {{ displayTitle }}
                                        </p>
                                    </div>

                                    <!-- Avatar Upload Section -->
                                    <input
                                        #avatarFileInput
                                        type="file"
                                        accept="image/jpeg, image/png, image/gif, image/webp"
                                        class="hidden"
                                        (change)="uploadAvatar(avatarFileInput.files)"/>
                                    
                                    <div *ngIf="!avatarUrl" class="flex flex-col items-center gap-2">
                                        <button
                                            mat-flat-button
                                            color="primary"
                                            size="small"
                                            type="button"
                                            (click)="avatarFileInput.click()">
                                            <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:camera'"></mat-icon>
                                            <span class="ml-1 text-xs">Télécharger une photo</span>
                                        </button>
                                        <div class="text-xs text-secondary text-center">JPEG, PNG, GIF ou WebP (Max 1Mo)</div>
                                    </div>

                                    <div *ngIf="avatarUrl" class="flex gap-2">
                                        <button
                                            mat-stroked-button
                                            size="small"
                                            type="button"
                                            (click)="avatarFileInput.click()">
                                            <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
                                            <span class="ml-1 text-xs">Change</span>
                                        </button>
                                        <button
                                            mat-stroked-button
                                            size="small"
                                            type="button"
                                            (click)="removeAvatar()">
                                            <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                                            <span class="ml-1 text-xs">Remove</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Info Cards -->
                            <div class="flex-1 p-6 space-y-4">
                                
                                <!-- Company Toggle -->
                                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Afficher comme une entreprise ?
                                        </div>
                                        <mat-slide-toggle
                                            [formControlName]="'isACompany'"
                                            color="primary">
                                        </mat-slide-toggle>
                                    </div>
                                </div>

                                <!-- Email Card -->
                                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                                    <div class="flex items-center mb-2">
                                        <mat-icon class="icon-size-5 text-primary mr-2" [svgIcon]="'heroicons_outline:envelope'"></mat-icon>
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Email</span>
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">
                                        {{ contactForm.get('email')?.value || 'No email provided' }}
                                    </div>
                                </div>

                                <!-- Phone Numbers Card -->
                                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                                    <div class="flex items-center mb-2">
                                        <mat-icon class="icon-size-5 text-primary mr-2" [svgIcon]="'heroicons_outline:phone'"></mat-icon>
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Phone Numbers</span>
                                    </div>
                                    <div class="space-y-1">
                                        <ng-container *ngFor="let phoneGroup of phonesFormArray.controls; let i = index">
                                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                                {{ phoneGroup.get('phone')?.value || 'No phone provided' }}
                                            </div>
                                        </ng-container>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Content Area -->
                        <div class="flex-1 flex flex-col overflow-hidden">
                            
                            <!-- Mobile Profile Summary (visible on small screens) -->
                            <div class="lg:hidden bg-card border-b border-gray-200 dark:border-gray-700 p-4">
                                <div class="flex items-center space-x-4">
                                    <div class="relative w-12 h-12">
                                        <div class="w-full h-full rounded-full overflow-hidden bg-gray-100 dark:bg-gray-800 flex items-center justify-center border-2 border-gray-300 dark:border-gray-600">
                                            <ng-container *ngIf="avatarUrl">
                                                <img
                                                    class="object-cover w-full h-full"
                                                    [src]="avatarUrl"
                                                    alt="Contact avatar"/>
                                            </ng-container>
                                            <ng-container *ngIf="!avatarUrl">
                                                <mat-icon class="icon-size-6 text-hint" [svgIcon]="'heroicons_outline:user-circle'"></mat-icon>
                                            </ng-container>
                                        </div>
                                    </div>
                                    
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-sm font-semibold text-gray-900 dark:text-white truncate">
                                            <ng-container *ngIf="!contactForm.get('isACompany')?.value">
                                                {{ contactForm.get('firstName')?.value }} {{ contactForm.get('lastName')?.value }}
                                            </ng-container>
                                            <ng-container *ngIf="contactForm.get('isACompany')?.value">
                                                {{ contactForm.get('companyName')?.value }}
                                            </ng-container>
                                        </h3>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                                            {{ contactForm.get('email')?.value || 'No email provided' }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tabs -->
                            <mat-tab-group class="flex flex-col flex-1" animationDuration="200ms">
                                
                                <!-- Personal Information Tab -->
                                <mat-tab label="Informations Personnelles">
                                    <div class="flex-1 overflow-y-auto p-4 lg:p-6">
                                        
                                        <!-- Name fields (shown when NOT a company) -->
                                        <div *ngIf="!contactForm.get('isACompany')?.value" class="mb-8">
                                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Personal Information</h3>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                <mat-form-field class="w-full">
                                                    <mat-label>Prénom*</mat-label>
                                                    <input
                                                        matInput
                                                        [formControlName]="'firstName'"
                                                        placeholder="Tapez le nom ici"/>
                                                    <mat-error *ngIf="contactForm.get('firstName')?.hasError('required')">
                                                        First name is required
                                                    </mat-error>
                                                </mat-form-field>

                                                <mat-form-field class="w-full">
                                                    <mat-label>Nom*</mat-label>
                                                    <input
                                                        matInput
                                                        [formControlName]="'lastName'"
                                                        placeholder="Tapez le nom ici"/>
                                                    <mat-error *ngIf="contactForm.get('lastName')?.hasError('required')">
                                                        Last name is required
                                                    </mat-error>
                                                </mat-form-field>

                                                <mat-form-field class="w-full sm:col-span-2">
                                                    <mat-label>Identifiant*</mat-label>
                                                    <input
                                                        matInput
                                                        [formControlName]="'identifier'"
                                                        placeholder="Entrer l'identifiant"/>
                                                    <mat-error *ngIf="contactForm.get('identifier')?.hasError('required')">
                                                        Identifier is required
                                                    </mat-error>
                                                </mat-form-field>
                                            </div>
                                        </div>

                                        <!-- Company fields (shown when IS a company) -->
                                        <div *ngIf="contactForm.get('isACompany')?.value" class="mb-8">
                                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Company Information</h3>
                                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                                <mat-form-field class="w-full">
                                                    <mat-label>Nom de l'entreprise*</mat-label>
                                                    <input
                                                        matInput
                                                        [formControlName]="'companyName'"
                                                        placeholder="Tapez le nom ici"/>
                                                    <mat-error *ngIf="contactForm.get('companyName')?.hasError('required')">
                                                        Company name is required
                                                    </mat-error>
                                                </mat-form-field>

                                                <mat-form-field class="w-full">
                                                    <mat-label>ICE</mat-label>
                                                    <input
                                                        matInput
                                                        [formControlName]="'ice'"
                                                        placeholder="Entrer l'ICE"/>
                                                </mat-form-field>

                                                <mat-form-field class="w-full">
                                                    <mat-label>RC</mat-label>
                                                    <input
                                                        matInput
                                                        [formControlName]="'rc'"
                                                        placeholder="Entrer le RC"/>
                                                </mat-form-field>

                                                <mat-form-field class="w-full sm:col-span-3">
                                                    <mat-label>Identifiant*</mat-label>
                                                    <input
                                                        matInput
                                                        [formControlName]="'identifier'"
                                                        placeholder="Entrer l'identifiant"/>
                                                    <mat-error *ngIf="contactForm.get('identifier')?.hasError('required')">
                                                        Identifier is required
                                                    </mat-error>
                                                </mat-form-field>
                                            </div>
                                        </div>

                                        <!-- Contact Details -->
                                        <div class="mb-8">
                                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Contact Details</h3>
                                            
                                            <!-- Email -->
                                            <div class="mb-6">
                                                <mat-form-field class="w-full">
                                                    <mat-label>Adresse email</mat-label>
                                                    <input
                                                        matInput
                                                        type="email"
                                                        [formControlName]="'email'"
                                                        placeholder="Ajouter l'email ici"/>
                                                    <mat-error *ngIf="contactForm.get('email')?.hasError('email')">
                                                        Invalid email address
                                                    </mat-error>
                                                </mat-form-field>
                                            </div>

                                            <!-- Phone Numbers -->
                                            <div>
                                                <div class="flex items-center justify-between mb-4">
                                                    <h4 class="text-md font-medium text-gray-700 dark:text-gray-300">Phone Numbers</h4>
                                                    <button
                                                        mat-stroked-button
                                                        size="small"
                                                        type="button"
                                                        (click)="addPhoneField()">
                                                        <mat-icon class="icon-size-4 text-green-600" [svgIcon]="'heroicons_outline:plus'"></mat-icon>
                                                        <span class="ml-1 text-xs text-green-600">Add Phone</span>
                                                    </button>
                                                </div>
                                                
                                                <ng-container formArrayName="phones">
                                                    <ng-container *ngFor="let phoneGroup of phonesFormArray.controls; let i = index; let first = first;">
                                                        <div [formGroupName]="i" class="flex items-center gap-4 mb-3">
                                                            <mat-form-field class="flex-1">
                                                                <mat-label>{{ first ? 'Numéro de téléphone' : 'Additional Phone' }}</mat-label>
                                                                <input
                                                                    matInput
                                                                    [formControlName]="'phone'"
                                                                    placeholder="Ajouter le numéro de téléphone"/>
                                                            </mat-form-field>
                                                            <button
                                                                *ngIf="!first"
                                                                mat-icon-button
                                                                type="button"
                                                                (click)="removePhoneField(i)">
                                                                <mat-icon class="text-warn icon-size-5" [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                                                            </button>
                                                        </div>
                                                    </ng-container>
                                                </ng-container>
                                            </div>
                                        </div>
                                    </div>
                                </mat-tab>

                                <!-- Documents Tab -->
                                <mat-tab label="Pièces jointes">
                                    <div class="flex flex-col h-full overflow-hidden p-4 lg:p-6">
                                        
                                        <!-- Upload Section -->
                                        <div class="mb-8 flex-shrink-0">
                                            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6 border border-blue-200 dark:border-blue-700">
                                                <div class="flex items-center justify-between mb-4">
                                                    <div class="flex items-center">
                                                        <mat-icon class="icon-size-6 text-blue-600 mr-2" [svgIcon]="'heroicons_outline:arrow-up-tray'"></mat-icon>
                                                        <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100">Upload Documents</h3>
                                                    </div>
                                                    <input
                                                        #documentFileInput
                                                        type="file"
                                                        multiple
                                                        accept="image/*, application/pdf, .doc, .docx, .xls, .xlsx, .txt"
                                                        class="hidden"
                                                        (change)="uploadDocuments(documentFileInput.files); documentFileInput.value = ''"/>
                                                    <button
                                                        mat-flat-button
                                                        color="primary"
                                                        type="button"
                                                        (click)="documentFileInput.click()">
                                                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:arrow-up-tray'"></mat-icon>
                                                        <span class="ml-2">Upload Files</span>
                                                    </button>
                                                </div>

                                                <!-- Documents to Upload Queue -->
                                                <div *ngIf="attachmentsToAdd.length > 0" class="mb-4">
                                                    <div class="text-sm font-medium mb-3 text-blue-700 dark:text-blue-300">Files to be uploaded when saving:</div>
                                                    <div class="grid grid-cols-1 gap-4">
                                                        <div *ngFor="let doc of attachmentsToAdd; let i = index" 
                                                             class="flex items-center gap-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700">
                                                            <mat-icon class="icon-size-6 text-green-600" [svgIcon]="'heroicons_outline:document'"></mat-icon>
                                                            <div class="flex-1 min-w-0">
                                                                <div class="text-sm font-medium truncate">{{ doc.fileName }}</div>
                                                                <div class="text-xs text-green-600">Ready to upload</div>
                                                            </div>
                                                            <button
                                                                mat-icon-button
                                                                type="button"
                                                                (click)="removeDocumentFromQueue(i)">
                                                                <mat-icon class="text-warn icon-size-4" [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div *ngIf="attachmentsToAdd.length === 0" class="text-sm text-blue-600 dark:text-blue-400 italic">
                                                    No files selected for upload. Click "Upload Files" to add attachments.
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Existing Documents -->
                                        <div *ngIf="contact?.attachments && contact.attachments.length > 0" class="flex flex-col flex-1 min-h-0">
                                            <div class="flex items-center justify-between mb-6 flex-shrink-0">
                                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                                    Current Documents
                                                </h3>
                                            </div>

                                            <!-- Documents List -->
                                            <div class="flex-1 overflow-y-auto pr-2">
                                                <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                                                    <div *ngFor="let doc of contact.attachments; trackBy: trackByFn" 
                                                         class="flex items-center gap-4 p-4 rounded-lg border transition-colors"
                                                         [ngClass]="{
                                                             'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700 opacity-50': isDocumentMarkedForDeletion(doc.id),
                                                             'bg-card border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800': !isDocumentMarkedForDeletion(doc.id)
                                                         }">
                                                        
                                                        <mat-icon class="icon-size-8"
                                                                  [ngClass]="{
                                                                      'text-red-600': isDocumentMarkedForDeletion(doc.id),
                                                                      'text-primary': !isDocumentMarkedForDeletion(doc.id)
                                                                  }"
                                                                  [svgIcon]="getFileIcon(doc.fileExtension)"></mat-icon>
                                                        
                                                        <div class="flex-1 min-w-0">
                                                            <div class="text-sm font-semibold truncate">{{ doc.originalFileName || doc.fileName }}</div>
                                                            <div class="text-xs mt-1"
                                                                 [ngClass]="{
                                                                     'text-red-600': isDocumentMarkedForDeletion(doc.id),
                                                                     'text-secondary': !isDocumentMarkedForDeletion(doc.id)
                                                                 }">
                                                                <span *ngIf="isDocumentMarkedForDeletion(doc.id)">Marked for deletion • </span>
                                                                {{ formatFileSize(doc.fileSize) }} • {{ doc.createdAt | date:'short' }}
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Actions -->
                                                        <div class="flex items-center gap-1">
                                                            <button *ngIf="!isDocumentMarkedForDeletion(doc.id)"
                                                                    mat-icon-button
                                                                    type="button"
                                                                    (click)="markDocumentForDeletion(doc.id)"
                                                                    matTooltip="Mark for deletion">
                                                                <mat-icon class="text-warn icon-size-5" [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                                                            </button>
                                                            <button *ngIf="isDocumentMarkedForDeletion(doc.id)"
                                                                    mat-icon-button
                                                                    type="button"
                                                                    (click)="cancelDocumentDeletion(doc.id)"
                                                                    matTooltip="Cancel deletion">
                                                                <mat-icon class="text-green-600 icon-size-5" [svgIcon]="'heroicons_outline:arrow-uturn-left'"></mat-icon>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- No Documents -->
                                        <div *ngIf="!contact?.attachments || contact.attachments.length === 0" 
                                             class="flex flex-col items-center justify-center py-16 text-center">
                                            <mat-icon class="icon-size-24 text-hint mb-4" [svgIcon]="'heroicons_outline:document'"></mat-icon>
                                            <div class="text-lg font-medium text-secondary">No attachments yet</div>
                                        </div>
                                    </div>
                                </mat-tab>

                            </mat-tab-group>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



