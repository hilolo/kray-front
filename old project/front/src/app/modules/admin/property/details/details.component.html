<div class="flex flex-col min-w-0 w-full">
    <div *ngIf="!isLoadingProperty; else loadingState" class="flex flex-col h-full bg-card dark:bg-transparent w-full max-w-full lg:max-w-[80%] mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="flex flex-col flex-shrink-0 py-6 px-6 md:px-8 border-b">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                <div class="flex flex-col gap-4">
                    <div class="flex flex-wrap items-center gap-3">
                        <button mat-stroked-button color="primary" (click)="goBack()">
                            <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:arrow-left'"></mat-icon>
                            Back to list
                        </button>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wider bg-slate-100 text-slate-700 dark:bg-gray-700 dark:text-gray-200" *ngIf="property?.identifier">
                            {{ property?.identifier }}
                        </span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wider bg-primary-50 text-primary-600 dark:bg-primary-900/40 dark:text-primary-200" *ngIf="property?.category !== undefined">
                            {{ getPropertyCategoryLabel(property?.category) }}
                        </span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wider bg-slate-100 text-slate-700 dark:bg-gray-700 dark:text-gray-200" *ngIf="property?.typeProperty">
                            {{ property?.typeProperty }}
                        </span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wider bg-slate-100 text-slate-700 dark:bg-gray-700 dark:text-gray-200" *ngIf="property?.furnished">
                            Furnished
                        </span>
                    </div>

                    <div class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white leading-tight break-words">
                        {{ property?.name || property?.identifier || 'Property details' }}
                    </div>

                    <div class="flex flex-wrap items-center gap-2 text-sm text-secondary">
                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                        <span>{{ property?.address || 'Address unavailable' }}</span>
                        <span *ngIf="property?.city" class="text-gray-400">•</span>
                        <span *ngIf="property?.city">{{ property?.city }}</span>
                    </div>
                </div>

                <div class="flex flex-col items-end gap-4 w-[360px]">
                    <div class="rounded-2xl px-6 py-5 border border-primary-100/60 dark:border-primary-900/30 bg-white dark:bg-gray-900 shadow-md shadow-primary-900/10 w-full">
                        <div class="text-xs uppercase tracking-[0.35em] text-primary-500/80 dark:text-primary-200/80 font-semibold">Price</div>
                        <div class="text-3xl font-bold text-primary-600 dark:text-primary-300">{{ property?.price | pricePaymentType:property?.typePaiment }}</div>
                        <div class="mt-3 inline-flex items-center gap-2 px-3 py-1 rounded-lg bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 text-xs font-semibold tracking-wider"
                             *ngIf="property?.isShared">
                            <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:user-group'"></mat-icon>
                            Shared property
                        </div>
                    </div>

                    <button mat-flat-button color="primary" class="px-6 py-3 rounded-xl font-semibold shadow-lg shadow-primary-500/25 w-full"
                            (click)="editProperty()">
                        <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:pencil-square'"></mat-icon>
                        Edit property
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-auto min-h-0 p-6 md:p-8">
            <div class="grid gap-6 xl:grid-cols-[40%_60%] items-start">
                        <!-- Left column -->
                        <div class="space-y-6">
                            <section class="rounded-3xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm shadow-gray-200/60 dark:shadow-black/30 overflow-hidden max-w-full">
                        <div class="relative w-full aspect-[4/3] bg-gray-100 dark:bg-gray-800 flex items-center justify-center cursor-pointer overflow-hidden max-w-full"
                             [class.cursor-default]="!hasGallery"
                             (click)="hasGallery && openImageViewer(activeImageIndex)">
                            <ng-container *ngIf="hasGallery; else galleryPlaceholder">
                                <img [ngSrc]="mainImageUrl!" fill alt="Property image" class="object-cover transition-transform duration-500">
                                <div class="absolute top-4 left-4 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/60 text-white text-xs font-semibold backdrop-blur z-10" *ngIf="galleryImages.length">
                                    <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:photo'"></mat-icon>
                                    <span>{{ galleryImages.length }} {{ galleryImages.length === 1 ? 'image' : 'images' }}</span>
                                </div>
                                <button type="button" class="absolute top-4 right-4 shadow-lg z-10 gallery-zoom-btn" mat-mini-fab color="primary" (click)="openImageViewer(activeImageIndex); $event.stopPropagation()">
                                    <mat-icon [svgIcon]="'heroicons_outline:magnifying-glass-plus'"></mat-icon>
                                </button>
                                <button type="button" class="absolute top-1/2 left-2 sm:left-4 -translate-y-1/2 z-10 gallery-nav-btn gallery-nav-btn--prev"
                                        *ngIf="galleryImages.length > 1"
                                        (click)="previousImage($event)">
                                    <mat-icon [svgIcon]="'heroicons_outline:chevron-left'"></mat-icon>
                                </button>
                                <button type="button" class="absolute top-1/2 right-2 sm:right-4 -translate-y-1/2 z-10 gallery-nav-btn gallery-nav-btn--next"
                                        *ngIf="galleryImages.length > 1"
                                        (click)="nextImage($event)">
                                    <mat-icon [svgIcon]="'heroicons_outline:chevron-right'"></mat-icon>
                                </button>
                            </ng-container>
                        </div>

                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3 p-3 sm:p-4 bg-gray-50 dark:bg-gray-900/60" *ngIf="galleryImages.length > 1">
                            <button type="button"
                                    class="relative w-full aspect-[4/3] rounded-xl overflow-hidden border-2 border-transparent transition-all duration-200 bg-gray-200 dark:bg-gray-700"
                                    [ngClass]="{'border-primary-500 shadow-lg shadow-primary-500/25': activeImageIndex === i}"
                                    (click)="selectImage(i)"
                                    *ngFor="let attachment of galleryImages; trackBy: trackById; let i = index">
                                <img [ngSrc]="getImageUrl(attachment.url)!" fill alt="Property thumbnail" class="object-cover">
                            </button>
                        </div>
                    </section>

                    <section class="rounded-3xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm shadow-gray-200/60 dark:shadow-black/30 p-6">
                        <div class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Snapshot</div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="flex items-start gap-3 p-4 rounded-2xl bg-slate-50 dark:bg-gray-900/70 border border-slate-100 dark:border-gray-800">
                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:square-2-stack'"></mat-icon>
                                <div>
                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">Surface</div>
                                    <div class="text-base font-semibold text-gray-900 dark:text-gray-100">{{ formatArea(property?.area) }}</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 p-4 rounded-2xl bg-slate-50 dark:bg-gray-900/70 border border-slate-100 dark:border-gray-800">
                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:home'"></mat-icon>
                                <div>
                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">Rooms</div>
                                    <div class="text-base font-semibold text-gray-900 dark:text-gray-100">{{ property?.pieces || 0 }}</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 p-4 rounded-2xl bg-slate-50 dark:bg-gray-900/70 border border-slate-100 dark:border-gray-800">
                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:home-modern'"></mat-icon>
                                <div>
                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">Bathrooms</div>
                                    <div class="text-base font-semibold text-gray-900 dark:text-gray-100">{{ property?.bathrooms || 0 }}</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 p-4 rounded-2xl bg-slate-50 dark:bg-gray-900/70 border border-slate-100 dark:border-gray-800">
                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:clock'"></mat-icon>
                                <div>
                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">Created on</div>
                                    <div class="text-base font-semibold text-gray-900 dark:text-gray-100">{{ formatDate(property?.createdAt) }}</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="rounded-3xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm shadow-gray-200/60 dark:shadow-black/30 p-6 flex flex-col gap-5">
                        <div class="flex items-center justify-between">
                            <div class="text-lg font-semibold text-gray-900 dark:text-white">Owner</div>
                            <button mat-button color="primary" *ngIf="property?.contactId" (click)="viewOwner()">View contact</button>
                        </div>
                        <ng-container *ngIf="!ownerContactLoading; else ownerLoading">
                            <div class="flex items-center gap-4">
                                <div class="grid place-items-center w-14 h-14 rounded-full bg-primary-100 text-primary-600 dark:bg-primary-900/40 dark:text-primary-200 text-xl font-bold overflow-hidden">
                                    <ng-container *ngIf="ownerAvatarUrl; else ownerInitial">
                                        <img [src]="ownerAvatarUrl" alt="Owner avatar" class="w-full h-full object-cover">
                                    </ng-container>
                                    <ng-template #ownerInitial>
                                        <span>{{ ownerDisplayName.charAt(0) | uppercase }}</span>
                                    </ng-template>
                                </div>
                                <div class="flex flex-col">
                                    <div class="text-base font-semibold">{{ ownerDisplayName }}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400" *ngIf="ownerIdentifier">
                                        Reference • {{ ownerIdentifier }}
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 text-sm text-gray-500 dark:text-gray-400" *ngIf="hasOwnerDetails">
                                <div class="inline-flex items-center gap-2" *ngIf="ownerEmail">
                                    <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:envelope'"></mat-icon>
                                    <span>{{ ownerEmail }}</span>
                                </div>
                                <div class="inline-flex items-center gap-2" *ngIf="ownerPhone">
                                    <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:phone'"></mat-icon>
                                    <span>{{ ownerPhone }}</span>
                                </div>
                                <div class="inline-flex items-center gap-2" *ngIf="ownerAddress">
                                    <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                                    <span>{{ ownerAddress }}</span>
                                </div>
                            </div>
                        </ng-container>
                    </section>

                    <section class="rounded-3xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm shadow-gray-200/60 dark:shadow-black/30 p-6" *ngIf="property?.description">
                        <div class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Description</div>
                        <p class="leading-relaxed text-gray-700 dark:text-gray-300 whitespace-pre-line">
                            {{ property?.description }}
                        </p>
                    </section>

                    <section class="rounded-3xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm shadow-gray-200/60 dark:shadow-black/30 p-6" *ngIf="property?.keys && property.keys.length > 0">
                        <div class="text-xl font-semibold text-gray-900 dark:text-white mb-6">Keys</div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div *ngFor="let key of property.keys" 
                                 class="flex items-start gap-5 p-6 rounded-2xl bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border-2 border-amber-200 dark:border-amber-800/50 hover:shadow-lg hover:scale-[1.02] transition-all duration-200">
                                <div class="flex-shrink-0 w-16 h-16 rounded-xl bg-amber-100 dark:bg-amber-900/40 flex items-center justify-center shadow-sm">
                                    <mat-icon class="icon-size-8 text-amber-600 dark:text-amber-300" 
                                              svgIcon="heroicons_outline:key"></mat-icon>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-lg font-bold text-gray-900 dark:text-white mb-2">{{ key.name }}</div>
                                    <div class="text-base text-gray-700 dark:text-gray-300 leading-relaxed" *ngIf="key.description">
                                        {{ key.description }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="rounded-3xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm shadow-gray-200/60 dark:shadow-black/30 p-6" *ngIf="features.length || equipment.length">
                        <div class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Highlights</div>
                        <div class="flex flex-col gap-6">
                            <div *ngIf="features.length">
                                <div class="text-sm font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-300 mb-2">Features</div>
                                <mat-chip-set class="flex flex-wrap gap-2">
                                    <mat-chip *ngFor="let feature of features; trackBy: trackById" class="!bg-slate-100 !text-slate-700 dark:!bg-gray-800 dark:!text-gray-200 !font-medium !px-3 !py-1 !rounded-full !text-xs">
                                        {{ feature }}
                                    </mat-chip>
                                </mat-chip-set>
                            </div>
                            <div *ngIf="equipment.length">
                                <div class="text-sm font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-300 mb-2">Equipment</div>
                                <mat-chip-set class="flex flex-wrap gap-2">
                                    <mat-chip *ngFor="let item of equipment; trackBy: trackById" class="!bg-primary-50 !text-primary-600 dark:!bg-primary-900/40 dark:!text-primary-200 !font-medium !px-3 !py-1 !rounded-full !text-xs">
                                        {{ item }}
                                    </mat-chip>
                                </mat-chip-set>
                            </div>
                        </div>
                    </section>
                        </div>

                        <!-- Right column -->
                        <div class="space-y-6">
                            <section class="rounded-3xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm shadow-gray-200/60 dark:shadow-black/30 p-6">
                        <mat-tab-group class="w-full" animationDuration="200ms" [selectedIndex]="getDefaultTabIndex()">
                            <mat-tab label="Leases" *ngIf="showLeasesTab">
                                <div class="pt-6">
                                    <ng-container *ngIf="!isLoadingLeases; else leasesLoading">
                                        <ng-container *ngIf="!hasLeasingError; else leasesError">
                                            <ng-container *ngIf="leases.length; else leasesEmpty">
                                                <div class="space-y-4">
                                                    <div class="rounded-2xl border border-slate-100 dark:border-gray-800 bg-slate-50 dark:bg-gray-900/70 px-5 py-4 flex flex-col gap-4" *ngFor="let lease of leases; trackBy: trackByLease">
                                                        <div class="flex items-start justify-between gap-4">
                                                            <div class="flex-1">
                                                                <div class="text-base font-semibold">{{ lease.tenantName || 'Unnamed tenant' }}</div>
                                                                <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">{{ formatDate(lease.tenancyStart) }} → {{ formatDate(lease.tenancyEnd) }}</div>
                                                            </div>
                                                            <div class="flex items-center gap-2">
                                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold" [ngClass]="getLeasingStatusChipClass(lease.status)">
                                                                    {{ getLeasingStatusLabel(lease.status) }}
                                                                </span>
                                                                <button mat-icon-button 
                                                                        color="primary" 
                                                                        class="flex-shrink-0"
                                                                        (click)="viewLease(lease)"
                                                                        matTooltip="View lease details">
                                                                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:eye'"></mat-icon>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 dark:text-gray-300">
                                                            <div>
                                                                <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">Rent</div>
                                                                <div class="font-semibold">{{ formatAmount(lease.rentPrice) }}</div>
                                                            </div>
                                                            <div>
                                                                <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">Payment</div>
                                                                <div class="font-semibold">{{ getPaymentTypeLabel(lease.paymentType) }}</div>
                                                            </div>
                                                            <div>
                                                                <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400">Method</div>
                                                                <div class="font-semibold">{{ getPaymentMethodLabel(lease.paymentMethod) }}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </ng-container>
                                    </ng-container>
                                </div>
                            </mat-tab>

                            <mat-tab label="Reservations" *ngIf="showReservationsTab">
                                <div class="pt-6">
                                    <ng-container *ngIf="!isLoadingReservations; else reservationsLoading">
                                        <ng-container *ngIf="!hasReservationError; else reservationsError">
                                            <!-- Print Button - Top of Calendar -->
                                            <div class="flex justify-end mb-4 no-print">
                                                <button type="button"
                                                        mat-stroked-button
                                                        color="primary"
                                                        (click)="printCalendarAndReservations()">
                                                    <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:printer'"></mat-icon>
                                                    Print
                                                </button>
                                            </div>
                                            
                                            <!-- Calendar View -->
                                            <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden print-calendar-section">
                                                <!-- Calendar Header -->
                                                <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                                                    <button type="button" 
                                                            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors no-print"
                                                            (click)="previousMonth()">
                                                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:chevron-left'"></mat-icon>
                                                    </button>
                                                    
                                                    <div class="flex items-center">
                                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ getMonthYearLabel() }}</h3>
                                                    </div>
                                                    
                                                    <button type="button"
                                                            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors no-print"
                                                            (click)="nextMonth()">
                                                        <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:chevron-right'"></mat-icon>
                                                    </button>
                                                </div>

                                                <!-- Calendar Grid -->
                                                <div class="p-4">
                                                    <!-- Days of week header -->
                                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                                        <div class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2">L</div>
                                                        <div class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2">M</div>
                                                        <div class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2">M</div>
                                                        <div class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2">J</div>
                                                        <div class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2">V</div>
                                                        <div class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2">S</div>
                                                        <div class="text-center text-xs font-semibold text-gray-500 dark:text-gray-400 py-2">D</div>
                                                    </div>

                                                    <!-- Calendar days -->
                                                    <div class="grid grid-cols-7 gap-1">
                                                        <div *ngFor="let day of calendarDays; trackBy: trackByDate"
                                                             class="aspect-square flex flex-col items-center justify-center rounded-lg text-sm transition-all relative"
                                                             [ngClass]="getDayStatusClass(day)"
                                                             [matTooltip]="getDayTooltip(day)">
                                                            <span class="text-xs font-medium relative z-10">{{ day.date.getDate() }}</span>
                                                            <div class="flex gap-0.5 mt-1 relative z-10" *ngIf="day.reservations.length > 0">
                                                                <div *ngFor="let res of day.reservations.slice(0, 3)" 
                                                                     class="w-1.5 h-1.5 rounded-full"
                                                                     [ngClass]="getReservationDotColor(res.status)"></div>
                                                                <div *ngIf="day.reservations.length > 3" 
                                                                     class="w-1.5 h-1.5 rounded-full"
                                                                     [ngClass]="getReservationDotColor(day.reservations[0]?.status)">+</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Legend -->
                                                <div class="px-4 pb-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                                                    <div class="flex items-center gap-4 text-xs flex-wrap">
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-4 h-4 rounded bg-green-100 dark:bg-green-900/40 border border-green-400 dark:border-green-700"></div>
                                                            <span class="text-gray-600 dark:text-gray-400">Available</span>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-4 h-4 rounded bg-yellow-400 dark:bg-yellow-600 border border-yellow-500 dark:border-yellow-500"></div>
                                                            <span class="text-gray-600 dark:text-gray-400">Pending</span>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-4 h-4 rounded bg-pink-300 dark:bg-pink-900/50 border border-pink-500 dark:border-pink-500"></div>
                                                            <span class="text-gray-600 dark:text-gray-400">Reserved</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Reservations List -->
                                            <div class="mt-6 print-reservations-section">
                                                <ng-container *ngIf="reservations?.length > 0; else reservationsEmptyInline">
                                                    <div class="flex items-center justify-between mb-4">
                                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Reservations</h3>
                                                        <span class="text-sm text-gray-500 dark:text-gray-400">{{ reservations.length }} {{ reservations.length === 1 ? 'reservation' : 'reservations' }}</span>
                                                    </div>
                                                    <div class="space-y-4">
                                                        <div class="rounded-2xl border border-slate-100 dark:border-gray-800 bg-slate-50 dark:bg-gray-900/70 px-5 py-4 flex flex-col gap-4" *ngFor="let reservation of reservations; trackBy: trackByReservation">
                                                            <div class="flex items-start justify-between gap-4">
                                                                <div class="flex items-center gap-3 flex-1">
                                                                    <div class="w-12 h-12 rounded-full bg-primary-100 text-primary-600 dark:bg-primary-900/40 dark:text-primary-200 font-semibold grid place-items-center overflow-hidden flex-shrink-0">
                                                                        <ng-container *ngIf="reservation.contactAvatarUrl; else reservationInitial">
                                                                            <img [src]="reservation.contactAvatarUrl" alt="{{ reservation.contactName || 'Guest' }}" class="w-full h-full object-cover">
                                                                        </ng-container>
                                                                        <ng-template #reservationInitial>
                                                                            <span class="text-base">{{ (reservation.contactName?.charAt(0) || 'G') | uppercase }}</span>
                                                                        </ng-template>
                                                                    </div>
                                                                    <div class="flex-1 min-w-0">
                                                                        <div class="text-base font-semibold text-gray-900 dark:text-gray-100">{{ reservation.contactName || 'Guest' }}</div>
                                                                        <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide mt-1">{{ formatDate(reservation.startDate) }} → {{ formatDate(reservation.endDate) }}</div>
                                                                    </div>
                                                                </div>
                                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold flex-shrink-0" [ngClass]="getReservationStatusBadge(reservation.status)">
                                                                    {{ getReservationStatusLabel(reservation.status) }}
                                                                </span>
                                                            </div>
                                                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm text-gray-600 dark:text-gray-300">
                                                                <div>
                                                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-1">Start Date</div>
                                                                    <div class="font-semibold">{{ formatDate(reservation.startDate) }}</div>
                                                                </div>
                                                                <div>
                                                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-1">End Date</div>
                                                                    <div class="font-semibold">{{ formatDate(reservation.endDate) }}</div>
                                                                </div>
                                                                <div>
                                                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-1">Duration</div>
                                                                    <div class="font-semibold">{{ getReservationDuration(reservation) }}</div>
                                                                </div>
                                                                <div *ngIf="reservation.totalAmount !== null && reservation.totalAmount !== undefined">
                                                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-1">Amount</div>
                                                                    <div class="font-semibold">{{ formatAmount(reservation.totalAmount) }}</div>
                                                                </div>
                                                                <div *ngIf="reservation.contactEmail">
                                                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-1">Email</div>
                                                                    <div class="font-semibold truncate">{{ reservation.contactEmail }}</div>
                                                                </div>
                                                                <div *ngIf="reservation.contactPhone">
                                                                    <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-1">Phone</div>
                                                                    <div class="font-semibold">{{ reservation.contactPhone }}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-container>
                                                <ng-template #reservationsEmptyInline>
                                                    <div class="flex flex-col items-center justify-center p-10 text-center bg-gray-50 dark:bg-gray-800/60 rounded-2xl ring-1 ring-inset ring-gray-200 dark:ring-gray-700">
                                                        <mat-icon class="icon-size-10 text-gray-300 dark:text-gray-600" [svgIcon]="'heroicons_outline:calendar'"></mat-icon>
                                                        <div class="font-semibold text-gray-600 dark:text-gray-300 mt-4">No reservations recorded.</div>
                                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Future bookings will automatically appear here.</p>
                                                    </div>
                                                </ng-template>
                                            </div>
                                        </ng-container>
                                    </ng-container>
                                </div>
                            </mat-tab>

                            <mat-tab label="Maintenance">
                                <div class="pt-6">
                                    <ng-container *ngIf="hasMaintenanceRequests; else maintenanceEmpty">
                                        <div class="space-y-4">
                                            <div class="rounded-2xl border border-slate-100 dark:border-gray-800 bg-slate-50 dark:bg-gray-900/70 px-5 py-4 flex flex-col gap-4" *ngFor="let maintenance of maintenanceRequests; trackBy: trackByMaintenance">
                                                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="text-base font-semibold text-gray-900 dark:text-white truncate">
                                                            {{ maintenance.subject || 'Maintenance request' }}
                                                        </div>
                                                        <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400 mt-1 flex items-center gap-2">
                                                            <mat-icon class="icon-size-4 text-gray-400 dark:text-gray-500" [svgIcon]="'heroicons_outline:calendar'"></mat-icon>
                                                            <span>{{ formatDateTime(maintenance.scheduledDateTime) }}</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex flex-wrap items-center gap-2 md:justify-end">
                                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold" [ngClass]="getMaintenancePriorityBadge(maintenance.priority)">
                                                            {{ getMaintenancePriorityLabelText(maintenance.priority) }}
                                                        </span>
                                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold" [ngClass]="getMaintenanceStatusBadge(maintenance.status)">
                                                            {{ getMaintenanceStatusLabelText(maintenance.status) }}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-line" *ngIf="maintenance.description">
                                                    {{ maintenance.description }}
                                                </div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 dark:text-gray-300">
                                                    <div *ngIf="maintenance.contactName || maintenance.contactEmail || maintenance.contactPhone">
                                                        <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-1">Service provider</div>
                                                        <div class="font-semibold text-gray-900 dark:text-gray-200" *ngIf="maintenance.contactName">
                                                            {{ maintenance.contactName }}
                                                        </div>
                                                        <div class="flex items-center gap-2" *ngIf="maintenance.contactEmail">
                                                            <mat-icon class="icon-size-4 text-gray-400 dark:text-gray-500" [svgIcon]="'heroicons_outline:envelope'"></mat-icon>
                                                            <span class="truncate">{{ maintenance.contactEmail }}</span>
                                                        </div>
                                                        <div class="flex items-center gap-2" *ngIf="maintenance.contactPhone">
                                                            <mat-icon class="icon-size-4 text-gray-400 dark:text-gray-500" [svgIcon]="'heroicons_outline:phone'"></mat-icon>
                                                            <span>{{ maintenance.contactPhone }}</span>
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div class="text-xs uppercase tracking-widest text-gray-500 dark:text-gray-400 mb-1">Planned for</div>
                                                        <div class="font-semibold text-gray-900 dark:text-gray-200">
                                                            {{ formatDateTime(maintenance.scheduledDateTime) }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </ng-container>
                                    <ng-template #maintenanceEmpty>
                                        <div class="flex flex-col items-center justify-center p-10 text-center bg-gray-50 dark:bg-gray-800/60 rounded-2xl ring-1 ring-inset ring-gray-200 dark:ring-gray-700">
                                            <mat-icon class="icon-size-10 text-gray-300 dark:text-gray-600" [svgIcon]="'heroicons_outline:wrench-screwdriver'"></mat-icon>
                                            <div class="font-semibold text-gray-600 dark:text-gray-300 mt-4">No maintenance scheduled.</div>
                                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Add maintenance requests from the maintenance module to see them here.</p>
                                        </div>
                                    </ng-template>
                                </div>
                            </mat-tab>

                            <mat-tab label="Finance">
                                <div class="pt-6 flex flex-col gap-6">
                                    <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400 bg-slate-50 dark:bg-gray-900/70 border border-slate-100 dark:border-gray-800 rounded-2xl px-4 py-3">
                                        <mat-icon class="icon-size-6" [svgIcon]="'heroicons_outline:information-circle'"></mat-icon>
                                        <span>Finance insights will appear automatically once transactions are recorded for this property.</span>
                                    </div>
                                </div>
                            </mat-tab>
                        </mat-tab-group>
                            </section>

                            <section class="rounded-3xl border border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm shadow-gray-200/60 dark:shadow-black/30 p-6 flex flex-col gap-4">
                                <div class="flex items-center justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="text-lg font-semibold text-gray-900 dark:text-white">Public visibility</div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                            Allow this property to appear on public pages.
                                        </p>
                                    </div>
                                    <mat-slide-toggle
                                        color="primary"
                                        [checked]="property?.isPublic"
                                        [disabled]="isUpdatingVisibility"
                                        (change)="onVisibilityToggle('isPublic', $event)">
                                    </mat-slide-toggle>
                                </div>
                                <mat-divider class="border-gray-100 dark:border-gray-800"></mat-divider>
                                <div class="flex items-center justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-gray-900 dark:text-white">Show address publicly</div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" [ngClass]="{'opacity-70': !property?.isPublic}">
                                            Make the full address visible on public pages.
                                        </p>
                                    </div>
                                    <mat-slide-toggle
                                        color="primary"
                                        [checked]="property?.isPublicAdresse"
                                        [disabled]="isUpdatingVisibility || !property?.isPublic"
                                        (change)="onVisibilityToggle('isPublicAdresse', $event)">
                                    </mat-slide-toggle>
                                </div>
                                <mat-divider class="border-gray-100 dark:border-gray-800"></mat-divider>
                                <div class="public-link-row flex flex-col sm:flex-row gap-2 items-start sm:items-center">
                                    <div class="public-link-field flex-1 w-full sm:w-auto"
                                         [class.public-link-field--empty]="!publicLink || !property?.isPublic"
                                         [class.public-link-field--disabled]="!property?.isPublic">
                                        <div class="public-link-field__icon-wrapper" [class.public-link-field__icon-wrapper--inactive]="!property?.isPublic || !publicLink">
                                            <mat-icon class="public-link-field__icon" [svgIcon]="publicLink && property?.isPublic ? 'heroicons_outline:link' : 'heroicons_outline:lock-closed'"></mat-icon>
                                        </div>
                                      
                                    </div>
                                    <div class="public-link-actions flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                                        <button mat-stroked-button
                                                color="primary"
                                                class="public-link-actions__button"
                                                (click)="openPublicLink()"
                                                [disabled]="!publicLink || !property?.isPublic">
                                            <mat-icon svgIcon="heroicons_outline:arrow-top-right-on-square"></mat-icon>
                                            <span>Open in new tab</span>
                                        </button>
                                        <button mat-stroked-button
                                                color="primary"
                                                class="public-link-actions__button"
                                                (click)="copyPublicLink()"
                                                [disabled]="!publicLink || !canCopy || !property?.isPublic">
                                            <mat-icon svgIcon="heroicons_outline:clipboard-document"></mat-icon>
                                            <span>Copy link</span>
                                        </button>
                                        <button mat-stroked-button
                                                color="primary"
                                                class="public-link-actions__button"
                                                (click)="sharePublicLinkViaWhatsApp()"
                                                [disabled]="!publicLink || !property?.isPublic">
                                            <mat-icon svgIcon="heroicons_outline:chat-bubble-left-ellipsis"></mat-icon>
                                            <span> Send via WhatsApp</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-xs text-amber-600 dark:text-amber-300" *ngIf="property && !property.isPublic">
                                    This property is currently private. Enable public visibility to allow external visitors to use the link.
                                </div>
                            </section>
                        </div>
                    </div>
            </div>
        </div>
    </div>

<app-image-viewer
    [isOpen]="isImageViewerOpen"
    [images]="viewerImages"
    [currentIndex]="viewerIndex"
    (close)="closeImageViewer()"
    (imageChanged)="onViewerImageChanged($event)">
</app-image-viewer>

<ng-template #loadingState>
    <div class="flex flex-col h-full bg-card dark:bg-transparent">
        <div class="flex items-center justify-center h-full">
            <mat-progress-spinner diameter="56" mode="indeterminate"></mat-progress-spinner>
        </div>
    </div>
</ng-template>

<ng-template #galleryPlaceholder>
    <div class="flex flex-col items-center justify-center gap-2 text-center text-sm text-gray-500 dark:text-gray-400 px-6">
        <mat-icon class="icon-size-12 text-gray-300 dark:text-gray-600" [svgIcon]="'heroicons_outline:photo'"></mat-icon>
        <div class="font-semibold text-gray-600 dark:text-gray-300">No images yet</div>
        <p class="text-xs">Add images to showcase this property to your clients.</p>
    </div>
</ng-template>

<ng-template #leasesLoading>
    <div class="flex items-center justify-center min-h-[200px]">
        <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
    </div>
</ng-template>

<ng-template #leasesEmpty>
    <div class="flex flex-col items-center justify-center p-10 text-center bg-gray-50 dark:bg-gray-800/60 rounded-2xl ring-1 ring-inset ring-gray-200 dark:ring-gray-700">
        <mat-icon class="icon-size-10 text-gray-300 dark:text-gray-600" [svgIcon]="'heroicons_outline:queue-list'"></mat-icon>
        <div class="font-semibold text-gray-600 dark:text-gray-300 mt-4">No leases attached yet.</div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Create a lease to track rent, charges and tenants.</p>
    </div>
</ng-template>

<ng-template #leasesError>
    <div class="flex flex-col items-center justify-center p-10 text-center bg-red-50 dark:bg-red-900/20 rounded-2xl ring-1 ring-inset ring-red-200 dark:ring-red-800">
        <mat-icon class="icon-size-10 text-red-500 dark:text-red-400" [svgIcon]="'heroicons_outline:exclamation-triangle'"></mat-icon>
        <div class="font-semibold text-red-600 dark:text-red-300 mt-4">We could not load the leases associated with this property.</div>
    </div>
</ng-template>

<ng-template #reservationsLoading>
    <div class="flex items-center justify-center min-h-[200px]">
        <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
    </div>
</ng-template>

<ng-template #reservationsEmpty>
    <div class="flex flex-col items-center justify-center p-10 text-center bg-gray-50 dark:bg-gray-800/60 rounded-2xl ring-1 ring-inset ring-gray-200 dark:ring-gray-700">
        <mat-icon class="icon-size-10 text-gray-300 dark:text-gray-600" [svgIcon]="'heroicons_outline:calendar'"></mat-icon>
        <div class="font-semibold text-gray-600 dark:text-gray-300 mt-4">No reservations recorded.</div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Future bookings will automatically appear here.</p>
    </div>
</ng-template>

<ng-template #reservationsError>
    <div class="flex flex-col items-center justify-center p-10 text-center bg-red-50 dark:bg-red-900/20 rounded-2xl ring-1 ring-inset ring-red-200 dark:ring-red-800">
        <mat-icon class="icon-size-10 text-red-500 dark:text-red-400" [svgIcon]="'heroicons_outline:exclamation-triangle'"></mat-icon>
        <div class="font-semibold text-red-600 dark:text-red-300 mt-4">We could not load reservations for this property.</div>
    </div>
</ng-template>

<ng-template #ownerLoading>
    <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400">
        <mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
        <span>Loading owner information…</span>
    </div>
</ng-template>

