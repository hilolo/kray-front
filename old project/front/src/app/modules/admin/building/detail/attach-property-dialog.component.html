<div class="flex flex-col max-h-[90vh]">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b">
        <div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Attach Existing Property</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Select a property to attach to this building</p>
        </div>
        <button mat-icon-button (click)="close()" [disabled]="isAttaching">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <!-- Search Bar -->
    <div class="p-6 border-b bg-gray-50 dark:bg-gray-800">
        <mat-form-field [ngClass]="formFieldHelpers" class="w-full">
            <mat-label>Search properties</mat-label>
            <input matInput 
                   type="text"
                   [(ngModel)]="searchTerm"
                   (ngModelChange)="filterProperties()"
                   placeholder="Search by name, reference, or address..."
                   autocomplete="off">
            <mat-icon matPrefix class="text-gray-400">search</mat-icon>
        </mat-form-field>
    </div>

    <!-- Content -->
    <div class="flex-auto overflow-hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full">
            <!-- Left: Property List -->
            <div class="flex flex-col border-r border-gray-200 dark:border-gray-700">
                <div class="p-4 border-b bg-gray-50 dark:bg-gray-800">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                            Available Properties
                        </h3>
                        <span class="text-sm text-gray-500 dark:text-gray-400">
                            {{ filteredProperties.length }} properties
                        </span>
                    </div>
                </div>

                <!-- Loading State -->
                <div *ngIf="isLoading" class="flex-auto flex items-center justify-center p-8">
                    <div class="text-center">
                        <mat-spinner diameter="40" class="mx-auto mb-4"></mat-spinner>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Loading properties...</p>
                    </div>
                </div>

                <!-- Empty State -->
                <div *ngIf="!isLoading && filteredProperties.length === 0" 
                     class="flex-auto flex items-center justify-center p-8">
                    <div class="text-center">
                        <mat-icon class="text-6xl text-gray-400 mb-4">home_work</mat-icon>
                        <p class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Properties Found</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {{ searchTerm ? 'Try adjusting your search terms' : 'All properties are already assigned to buildings' }}
                        </p>
                    </div>
                </div>

                <!-- Property List -->
                <div *ngIf="!isLoading && filteredProperties.length > 0" 
                     class="flex-auto overflow-y-auto">
                    <div *ngFor="let property of filteredProperties" 
                         [ngClass]="{
                            'p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors': true,
                            'bg-blue-50 dark:bg-blue-900/20': selectedProperty?.id === property.id
                         }"
                         (click)="selectProperty(property)">
                        
                        <div class="flex items-start gap-4">
                            <!-- Property Image -->
                            <div class="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden bg-gray-200 dark:bg-gray-700">
                                <img *ngIf="property.defaultAttachmentUrl" 
                                     [src]="property.defaultAttachmentUrl" 
                                     [alt]="property.name"
                                     class="w-full h-full object-cover">
                                <div *ngIf="!property.defaultAttachmentUrl" 
                                     class="w-full h-full flex items-center justify-center">
                                    <mat-icon class="text-gray-400">image</mat-icon>
                                </div>
                            </div>

                            <!-- Property Info -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-2 mb-1">
                                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white truncate">
                                        {{ property.name || 'Unnamed Property' }}
                                    </h4>
                                    <span class="text-xs font-medium text-blue-600 dark:text-blue-400 whitespace-nowrap">
                                        {{ property.identifier }}
                                    </span>
                                </div>
                                
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-2 line-clamp-1">
                                    <mat-icon class="icon-size-3 align-middle mr-1">location_on</mat-icon>
                                    {{ property.address }}
                                </p>
                                
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                        {{ getPropertyCategory(property) }}
                                    </span>
                                    <span class="text-xs text-gray-600 dark:text-gray-400">
                                        {{ formatPriceWithType(property) }}
                                    </span>
                                </div>
                            </div>

                            <!-- Selection Indicator -->
                            <div *ngIf="selectedProperty?.id === property.id" 
                                 class="flex-shrink-0">
                                <mat-icon class="text-blue-600 dark:text-blue-400">check_circle</mat-icon>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Property Details -->
            <div class="flex flex-col overflow-hidden">
                <!-- No Selection State -->
                <div *ngIf="!selectedProperty" class="flex-auto flex items-center justify-center p-8">
                    <div class="text-center">
                        <mat-icon class="text-6xl text-gray-400 mb-4">arrow_back</mat-icon>
                        <p class="text-lg font-medium text-gray-900 dark:text-white mb-2">Select a Property</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            Click on a property from the list to view details
                        </p>
                    </div>
                </div>

                <!-- Property Details -->
                <div *ngIf="selectedProperty" class="flex flex-col h-full">
                    <div class="p-4 border-b bg-gray-50 dark:bg-gray-800">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Property Details</h3>
                            <button mat-icon-button (click)="clearSelection()" [disabled]="isAttaching">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                    </div>

                    <div class="flex-auto overflow-y-auto p-6">
                        <!-- Property Image -->
                        <div *ngIf="selectedProperty.defaultAttachmentUrl" class="mb-6">
                            <img [src]="selectedProperty.defaultAttachmentUrl" 
                                 [alt]="selectedProperty.name"
                                 class="w-full h-48 object-cover rounded-lg">
                        </div>

                        <!-- Basic Information -->
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-1">
                                    {{ selectedProperty.name || 'Unnamed Property' }}
                                </h4>
                                <p class="text-sm font-medium text-blue-600 dark:text-blue-400">
                                    {{ selectedProperty.identifier }}
                                </p>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Category</p>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">
                                        {{ getPropertyCategory(selectedProperty) }}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Type</p>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">
                                        {{ getPropertyType(selectedProperty) }}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Price / Payment Type</p>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">
                                        {{ formatPriceWithType(selectedProperty) }}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">City</p>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">
                                        {{ selectedProperty.city || 'Non défini' }}
                                    </p>
                                </div>
                            </div>

                            <div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Address</p>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">
                                    {{ selectedProperty.address || 'Non défini' }}
                                </p>
                            </div>

                            <!-- Property Details -->
                            <div class="grid grid-cols-3 gap-4">
                                <div *ngIf="selectedProperty.area" class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <mat-icon class="text-gray-400 mb-1">square_foot</mat-icon>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedProperty.area }} m²</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Area</p>
                                </div>
                                <div *ngIf="selectedProperty.pieces" class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <mat-icon class="text-gray-400 mb-1">bed</mat-icon>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedProperty.pieces }}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Rooms</p>
                                </div>
                                <div *ngIf="selectedProperty.bathrooms" class="text-center p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <mat-icon class="text-gray-400 mb-1">bathtub</mat-icon>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedProperty.bathrooms }}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Bathrooms</p>
                                </div>
                            </div>

                            <!-- Features -->
                            <div *ngIf="selectedProperty.features && selectedProperty.features.length > 0">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Features</p>
                                <div class="flex flex-wrap gap-2">
                                    <span *ngFor="let feature of selectedProperty.features" 
                                          class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                        {{ feature }}
                                    </span>
                                </div>
                            </div>

                            <!-- Equipment -->
                            <div *ngIf="selectedProperty.equipment && selectedProperty.equipment.length > 0">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Equipment</p>
                                <div class="flex flex-wrap gap-2">
                                    <span *ngFor="let item of selectedProperty.equipment" 
                                          class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                        {{ item }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-between p-6 border-t bg-gray-50 dark:bg-gray-800">
        <div class="text-sm text-gray-600 dark:text-gray-400">
            <span *ngIf="selectedProperty">Selected: <strong>{{ selectedProperty.name || selectedProperty.identifier }}</strong></span>
            <span *ngIf="!selectedProperty">No property selected</span>
        </div>
        <div class="flex gap-4">
            <button mat-stroked-button (click)="close()" [disabled]="isAttaching">
                Cancel
            </button>
            <button mat-flat-button 
                    color="primary"
                    (click)="attachProperty()"
                    [disabled]="!selectedProperty || isAttaching">
                <mat-icon *ngIf="isAttaching" class="animate-spin mr-2">refresh</mat-icon>
                <span>{{ isAttaching ? 'Attaching...' : 'Attach Property' }}</span>
            </button>
        </div>
    </div>
</div>

