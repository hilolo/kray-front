<div class="absolute inset-0 flex flex-col min-w-0 overflow-hidden">

    <div class="flex flex-col h-full bg-card dark:bg-transparent">

        <!-- Header -->
        <div class="flex flex-col py-6 px-6 md:px-8 border-b">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-4xl font-extrabold tracking-tight leading-none">
                        <ng-container *ngIf="isEditMode && !editingMode">{{ building?.name || 'Building Details' }}</ng-container>
                        <ng-container *ngIf="isEditMode && editingMode">Edit Building</ng-container>
                        <ng-container *ngIf="!isEditMode">Add Building</ng-container>
                    </div>
                    <div class="ml-0.5 font-medium text-secondary mt-1">
                        <ng-container *ngIf="isEditMode && !editingMode">View building details and properties</ng-container>
                        <ng-container *ngIf="isEditMode && editingMode">Update building information</ng-container>
                        <ng-container *ngIf="!isEditMode">Create a new building</ng-container>
                    </div>
                </div>
                
                <!-- Back button -->
                <button mat-stroked-button [routerLink]="['/building']">
                    <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:arrow-left'"></mat-icon>
                    <span>Back to Buildings</span>
                </button>
            </div>
        </div>

        <!-- Content with Two Columns -->
        <div class="flex-auto overflow-y-auto p-6 md:p-8">
            
            <!-- View Mode: Two columns with Building info on left and Properties on right -->
            <div *ngIf="isEditMode && !editingMode" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Column - Building Details (1/3 width) -->
                <div class="lg:col-span-1">
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden sticky top-6">
                        
                        <!-- Building Image -->
                        <div class="relative h-64 overflow-hidden bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800">
                            <ng-container *ngIf="currentImageUrl; else buildingIconLarge">
                                <img [src]="currentImageUrl" 
                                     [alt]="building?.name"
                                     class="w-full h-full object-cover" />
                            </ng-container>
                            <ng-template #buildingIconLarge>
                                <div class="w-full h-full flex items-center justify-center">
                                    <mat-icon class="icon-size-24 text-gray-300 dark:text-gray-600" 
                                        [svgIcon]="'heroicons_outline:building-office-2'">
                                    </mat-icon>
                                </div>
                            </ng-template>
                            
                            <!-- Property Count Badge -->
                            <div class="absolute top-4 right-4 px-3 py-1.5 bg-primary-600/90 dark:bg-primary-500/90 text-white rounded-full text-sm font-semibold shadow-lg backdrop-blur-sm">
                                <mat-icon class="icon-size-4 inline-block mr-1 -mt-0.5" [svgIcon]="'heroicons_solid:home'"></mat-icon>
                                {{ buildingProperties.length }} {{ buildingProperties.length === 1 ? 'Propriété' : 'Propriétés' }}
                            </div>
                        </div>
                        
                        <!-- Building Information -->
                        <div class="p-6">
                            <!-- Building Name -->
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">{{ building?.name }}</h2>
                            
                            <!-- Building Details -->
                            <div class="space-y-4">
                                <!-- Address -->
                                <div class="flex items-start gap-3 pb-4 border-b border-gray-200 dark:border-gray-700">
                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                                    <div class="flex-1">
                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wide">Address</div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ building?.address || 'N/A' }}</div>
                                    </div>
                                </div>
                                
                                <!-- City -->
                                <div class="flex items-start gap-3 pb-4 border-b border-gray-200 dark:border-gray-700">
                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:map'"></mat-icon>
                                    <div class="flex-1">
                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wide">City</div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ building?.city || 'N/A' }}</div>
                                    </div>
                                </div>
                                
                                <!-- Year Built -->
                                <div class="flex items-start gap-3 pb-4 border-b border-gray-200 dark:border-gray-700">
                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:calendar'"></mat-icon>
                                    <div class="flex-1">
                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wide">Year Built</div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ building?.year || 'N/A' }}</div>
                                    </div>
                                </div>
                                
                                <!-- Number of Floors -->
                                <div class="flex items-start gap-3 pb-4 border-b border-gray-200 dark:border-gray-700">
                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:building-office'"></mat-icon>
                                    <div class="flex-1">
                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wide">Floors</div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ building?.floor || 0 }} {{ (building?.floor || 0) === 1 ? 'floor' : 'floors' }}</div>
                                    </div>
                                </div>
                                
                                <!-- Description -->
                                <div *ngIf="building?.description" class="flex items-start gap-3">
                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:document-text'"></mat-icon>
                                    <div class="flex-1">
                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wide">Description</div>
                                        <div class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">{{ building?.description }}</div>
                                    </div>
                                </div>
                                
                                <!-- Created Date -->
                                <div *ngIf="building?.createdAt" class="flex items-start gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-gray-400" [svgIcon]="'heroicons_outline:clock'"></mat-icon>
                                    <div class="flex-1">
                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wide">Created</div>
                                        <div class="text-xs text-gray-600 dark:text-gray-400">{{ building?.createdAt | date:'medium' }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700 space-y-3">
                                <button mat-flat-button color="primary" type="button" class="w-full" (click)="enableEditMode()">
                                    <mat-icon class="icon-size-5 mr-2 text-white" [svgIcon]="'heroicons_outline:pencil'"></mat-icon>
                                    <span>Edit Building</span>
                                </button>
                                
                                <button mat-stroked-button type="button" class="w-full" [routerLink]="['/building']">
                                    <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:arrow-left'"></mat-icon>
                                    <span>Back to List</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Properties List (2/3 width) -->
                <div class="lg:col-span-2">
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <div class="text-2xl font-semibold text-gray-900 dark:text-white">Properties</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">{{ buildingProperties.length }} {{ buildingProperties.length === 1 ? 'propriété' : 'propriétés' }} dans ce bâtiment</div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex items-center gap-2">
                                <button mat-flat-button color="primary" type="button" (click)="openAddPropertyDialog()">
                                    <mat-icon class="icon-size-5 mr-2 text-white" [svgIcon]="'heroicons_outline:plus-circle'"></mat-icon>
                                    <span>Add Property</span>
                                </button>
                                
                                <button mat-stroked-button type="button" (click)="openAttachPropertyDialog()">
                                    <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:link'"></mat-icon>
                                    <span>Attach</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Loading State -->
                        <div *ngIf="loadingProperties" class="flex items-center justify-center py-12">
                            <mat-icon class="icon-size-8 animate-spin text-primary-600" [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
                            <span class="ml-3 text-secondary">Loading properties...</span>
                        </div>
                        
                        <!-- Properties List -->
                        <ng-container *ngIf="!loadingProperties">
                            <div *ngIf="buildingProperties.length > 0; else noPropertiesView" class="space-y-4">
                                <div *ngFor="let property of buildingProperties; trackBy: trackByFn"
                                     class="bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300 hover:shadow-lg">
                                    
                                    <!-- Property Header (Always Visible) -->
                                    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                                        <div class="flex items-start gap-4">
                                            <!-- Property Image -->
                                            <div class="flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800">
                                                <ng-container *ngIf="property.defaultAttachmentUrl; else propertyIconSmall">
                                                    <img [src]="property.defaultAttachmentUrl" 
                                                        [alt]="property.name"
                                                        class="w-full h-full object-cover" />
                                                </ng-container>
                                                <ng-template #propertyIconSmall>
                                                    <div class="w-full h-full flex items-center justify-center">
                                                        <mat-icon class="icon-size-8 text-gray-300 dark:text-gray-600" 
                                                            [svgIcon]="'heroicons_outline:home'">
                                                        </mat-icon>
                                                    </div>
                                                </ng-template>
                                            </div>
                                            
                                            <!-- Property Basic Info -->
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-start justify-between gap-2">
                                                    <div class="flex-1 min-w-0">
                                                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-1 truncate">
                                                            {{ property.name }}
                                                        </h4>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                                                            <span class="font-medium">{{ property.identifier }}</span>
                                                            <span *ngIf="property.typeProperty"> • {{ property.typeProperty }}</span>
                                                        </div>
                                                        <div class="flex items-center gap-4 text-xs text-gray-600 dark:text-gray-400">
                                                            <div *ngIf="property.area" class="flex items-center gap-1">
                                                                <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:squares-2x2'"></mat-icon>
                                                                <span>{{ property.area }} m²</span>
                                                            </div>
                                                            <div *ngIf="property.pieces" class="flex items-center gap-1">
                                                                <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:home'"></mat-icon>
                                                                <span>{{ property.pieces }} rooms</span>
                                                            </div>
                                                            <div *ngIf="property.bathrooms" class="flex items-center gap-1">
                                                                <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:home-modern'"></mat-icon>
                                                                <span>{{ property.bathrooms }} {{ property.bathrooms === 1 ? 'bath' : 'baths' }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Price -->
                                                    <div class="flex-shrink-0 text-right">
                                                        <div class="font-bold text-primary-600 dark:text-primary-400 text-lg mb-2">
                                                            {{ property.price | pricePaymentType:property.typePaiment }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Action Buttons -->
                                        <div class="flex items-center justify-end gap-2 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                            <button mat-stroked-button
                                                    type="button"
                                                    (click)="togglePropertyDetails(property.id, $event)"
                                                    class="flex items-center gap-2">
                                                <mat-icon class="icon-size-5" 
                                                    [svgIcon]="isPropertyExpanded(property.id) ? 'heroicons_outline:chevron-up' : 'heroicons_outline:chevron-down'">
                                                </mat-icon>
                                                <span>{{ isPropertyExpanded(property.id) ? 'Hide Details' : 'Show Details' }}</span>
                                            </button>
                                            
                                            <button mat-stroked-button
                                                    type="button"
                                                    (click)="viewPropertyDetail(property.id); $event.stopPropagation()"
                                                    class="flex items-center gap-2">
                                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:arrow-top-right-on-square'"></mat-icon>
                                                <span>View Full</span>
                                            </button>
                                            
                                            <button mat-icon-button
                                                    type="button"
                                                    (click)="removePropertyFromBuilding(property, $event)"
                                                    matTooltip="Remove from building"
                                                    color="warn">
                                                <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Property Details (Collapsible) -->
                                    <div *ngIf="isPropertyExpanded(property.id)" 
                                         class="p-4 bg-gray-50 dark:bg-gray-900/50 border-t border-gray-200 dark:border-gray-700">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <!-- Left Column -->
                                            <div class="space-y-4">
                                                <!-- Address -->
                                                <div *ngIf="property.address" class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Address</div>
                                                        <div class="text-sm text-gray-900 dark:text-white">{{ property.address }}</div>
                                                    </div>
                                                </div>
                                        
                                                <!-- City -->
                                                <div *ngIf="property.city" class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:map'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">City</div>
                                                        <div class="text-sm text-gray-900 dark:text-white">{{ property.city }}</div>
                                                    </div>
                                                </div>
                                        
                                                <!-- Type Property -->
                                                <div *ngIf="property.typeProperty" class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:tag'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Type</div>
                                                        <div class="text-sm text-gray-900 dark:text-white">{{ property.typeProperty }}</div>
                                                    </div>
                                                </div>
                                        
                                                <!-- Category -->
                                                <div *ngIf="property.category" class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:folder'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Category</div>
                                                        <div class="text-sm text-gray-900 dark:text-white">
                                                            <span *ngIf="property.category === 'Location' || property.category === 0">Location</span>
                                                            <span *ngIf="property.category === 'Vente' || property.category === 1">Vente</span>
                                                            <span *ngIf="property.category === 'LocationVacances' || property.category === 2">Location Vacances</span>
                                                            <span *ngIf="!property.category || (property.category !== 'Location' && property.category !== 'Vente' && property.category !== 'LocationVacances' && property.category !== 0 && property.category !== 1 && property.category !== 2)">{{ property.category }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <!-- Furnished -->
                                                <div class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:home-modern'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Furnished</div>
                                                        <div class="text-sm text-gray-900 dark:text-white">
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                                  [class.bg-green-100]="property.furnished"
                                                                  [class.text-green-800]="property.furnished"
                                                                  [class.bg-gray-100]="!property.furnished"
                                                                  [class.text-gray-800]="!property.furnished">
                                                                {{ property.furnished ? 'Yes' : 'No' }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        
                                            <!-- Right Column -->
                                            <div class="space-y-4">
                                                <!-- Area -->
                                                <div *ngIf="property.area" class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:squares-2x2'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Area</div>
                                                        <div class="text-sm text-gray-900 dark:text-white">{{ property.area }} m²</div>
                                                    </div>
                                                </div>
                                        
                                                <!-- Pieces -->
                                                <div *ngIf="property.pieces" class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:home'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Rooms</div>
                                                        <div class="text-sm text-gray-900 dark:text-white">{{ property.pieces }}</div>
                                                    </div>
                                                </div>
                                        
                                                <!-- Bathrooms -->
                                                <div *ngIf="property.bathrooms" class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:home-modern'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Bathrooms</div>
                                                        <div class="text-sm text-gray-900 dark:text-white">{{ property.bathrooms }}</div>
                                                    </div>
                                                </div>
                                        
                                                <!-- Price -->
                                                <div class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:currency-dollar'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Price</div>
                                                        <div class="text-lg font-bold text-primary-600 dark:text-primary-400">
                                                            {{ property.price | pricePaymentType:property.typePaiment }}
                                                        </div>
                                                    </div>
                                                </div>
                                        
                                                <!-- Description -->
                                                <div *ngIf="property.description" class="flex items-start gap-3">
                                                    <mat-icon class="icon-size-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" [svgIcon]="'heroicons_outline:document-text'"></mat-icon>
                                                    <div class="flex-1">
                                                        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Description</div>
                                                        <div class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">{{ property.description }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Features & Equipment -->
                                        <div *ngIf="(property.features && property.features.length > 0) || (property.equipment && property.equipment.length > 0)" 
                                             class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <!-- Features -->
                                                <div *ngIf="property.features && property.features.length > 0">
                                                    <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-3">Features</div>
                                                    <div class="flex flex-wrap gap-2">
                                                        <span *ngFor="let feature of property.features" 
                                                              class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">
                                                            {{ feature }}
                                                        </span>
                                                    </div>
                                                </div>
                                        
                                                <!-- Equipment -->
                                                <div *ngIf="property.equipment && property.equipment.length > 0">
                                                    <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-3">Equipment</div>
                                                    <div class="flex flex-wrap gap-2">
                                                        <span *ngFor="let equipment of property.equipment" 
                                                              class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300">
                                                            {{ equipment }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- No Properties Message -->
                            <ng-template #noPropertiesView>
                                <div class="flex flex-col items-center justify-center py-12 text-center">
                                    <mat-icon class="icon-size-16 text-gray-300 dark:text-gray-600 mb-4" 
                                        [svgIcon]="'heroicons_outline:home'">
                                    </mat-icon>
                                    <div class="text-lg font-medium text-secondary">No properties yet</div>
                                    <div class="text-sm text-secondary mt-2 mb-4">Start by adding properties to this building</div>
                                    <div class="flex gap-2">
                                        <button mat-flat-button color="primary" type="button" (click)="openAddPropertyDialog()">
                                            <mat-icon class="icon-size-5 mr-2 text-white" [svgIcon]="'heroicons_outline:plus-circle'"></mat-icon>
                                            <span>Add Property</span>
                                        </button>
                                        <button mat-stroked-button type="button" (click)="openAttachPropertyDialog()">
                                            <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:link'"></mat-icon>
                                            <span>Attach Existing</span>
                                        </button>
                                    </div>
                                </div>
                            </ng-template>
                        </ng-container>
                    </div>
                </div>
            </div>
            
            <!-- Edit Mode or Add Mode: Form Layout -->
            <div *ngIf="!isEditMode || editingMode" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Column - Building Form (2/3 width) -->
                <div class="lg:col-span-2">
                    <form [formGroup]="buildingForm">
                        
                        <!-- Building Information Section -->
                        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                            <div class="text-2xl font-semibold mb-6">Building Information</div>
                            
                            <!-- Building Image Upload Section -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">
                                    <mat-icon class="icon-size-5 align-middle mr-1" [svgIcon]="'heroicons_outline:photo'"></mat-icon>
                                    Building Image
                                </label>
                                
                                <!-- Hidden file input -->
                                <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" class="hidden">
                                
                                <!-- Image Display Area -->
                                <div class="flex flex-col md:flex-row gap-4">
                                    <!-- Image Preview Container -->
                                    <div class="flex-shrink-0">
                                        <div class="relative w-full md:w-80 h-64 rounded-xl overflow-hidden border-2 transition-all duration-200"
                                             [class.border-blue-500]="imagePreview"
                                             [class.border-gray-300]="!imagePreview && !currentImageUrl"
                                             [class.border-green-500]="!imagePreview && currentImageUrl"
                                             [class.dark:border-blue-400]="imagePreview"
                                             [class.dark:border-gray-600]="!imagePreview && !currentImageUrl"
                                             [class.dark:border-green-400]="!imagePreview && currentImageUrl">
                                            
                                            <!-- Image Display -->
                                            <div *ngIf="imagePreview || currentImageUrl" class="w-full h-full">
                                                <img [src]="imagePreview || currentImageUrl" 
                                                     alt="Building Image" 
                                                     class="w-full h-full object-cover">
                                                
                                                <!-- Image Badge -->
                                                <div class="absolute top-3 left-3">
                                                    <span *ngIf="imagePreview" 
                                                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-500 text-white shadow-lg">
                                                        <mat-icon class="icon-size-4 mr-1" [svgIcon]="'heroicons_outline:cloud-arrow-up'"></mat-icon>
                                                        New Upload
                                                    </span>
                                                    <span *ngIf="!imagePreview && currentImageUrl" 
                                                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-500 text-white shadow-lg">
                                                        <mat-icon class="icon-size-4 mr-1" [svgIcon]="'heroicons_outline:check-circle'"></mat-icon>
                                                        Current Image
                                                    </span>
                                                </div>
                                                
                                                <!-- Remove Button -->
                                                <button *ngIf="imagePreview" 
                                                        type="button" 
                                                        (click)="removeImage()" 
                                                        class="absolute top-3 right-3 p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors shadow-lg">
                                                    <mat-icon class="icon-size-5" [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                                                </button>
                                            </div>
                                            
                                            <!-- Placeholder when no image -->
                                            <div *ngIf="!imagePreview && !currentImageUrl" 
                                                 class="w-full h-full flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-700">
                                                <mat-icon class="icon-size-16 text-gray-400 dark:text-gray-500 mb-3" 
                                                          [svgIcon]="'heroicons_outline:photo'"></mat-icon>
                                                <p class="text-sm text-gray-500 dark:text-gray-400 font-medium">No image uploaded</p>
                                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Click below to upload</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Upload Controls -->
                                    <div class="flex flex-col justify-center gap-4">
                                        <div class="space-y-3">
                                            <button type="button" 
                                                    mat-raised-button 
                                                    color="primary" 
                                                    (click)="selectImage()"
                                                    class="w-full md:w-auto">
                                                <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:cloud-arrow-up'"></mat-icon>
                                                {{ imagePreview || currentImageUrl ? 'Change Image' : 'Upload Image' }}
                                            </button>
                                            
                                            <button *ngIf="imagePreview && currentImageUrl" 
                                                    type="button" 
                                                    mat-stroked-button 
                                                    (click)="removeImage()"
                                                    class="w-full md:w-auto">
                                                <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:arrow-uturn-left'"></mat-icon>
                                                Restore Original
                                            </button>
                                        </div>
                                        
                                        <div class="space-y-2 text-sm">
                                            <div class="flex items-start gap-2 text-gray-600 dark:text-gray-400">
                                                <mat-icon class="icon-size-4 mt-0.5" [svgIcon]="'heroicons_outline:information-circle'"></mat-icon>
                                                <div>
                                                    <p class="font-medium">Image Guidelines:</p>
                                                    <ul class="list-disc list-inside mt-1 text-xs space-y-1">
                                                        <li>Maximum file size: 3 MB</li>
                                                        <li>Supported formats: JPG, PNG, GIF, WebP</li>
                                                        <li>Recommended size: 800x600px or larger</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                
                                <!-- Name -->
                                <mat-form-field class="w-full md:col-span-2">
                                    <mat-label>Building Name</mat-label>
                                    <input matInput formControlName="name" placeholder="Enter building name" required>
                                    <mat-icon matPrefix class="icon-size-5" [svgIcon]="'heroicons_outline:building-office-2'"></mat-icon>
                                    <mat-error *ngIf="buildingForm.get('name').hasError('required')">
                                        Name is required
                                    </mat-error>
                                </mat-form-field>

                                <!-- Address -->
                                <mat-form-field class="w-full md:col-span-2">
                                    <mat-label>Address</mat-label>
                                    <input matInput formControlName="address" placeholder="Enter address" required>
                                    <mat-icon matPrefix class="icon-size-5" [svgIcon]="'heroicons_outline:map-pin'"></mat-icon>
                                    <mat-error *ngIf="buildingForm.get('address').hasError('required')">
                                        Address is required
                                    </mat-error>
                                </mat-form-field>

                                <!-- City Select -->
                                <mat-form-field class="w-full md:col-span-2">
                                    <mat-label>City</mat-label>
                                    <mat-select formControlName="city" placeholder="Select city">
                                        <mat-option *ngFor="let city of cities" [value]="city">
                                            {{ city }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-icon matPrefix class="icon-size-5" [svgIcon]="'heroicons_outline:map'"></mat-icon>
                                </mat-form-field>

                                <!-- Year -->
                                <mat-form-field class="w-full">
                                    <mat-label>Year Built</mat-label>
                                    <input matInput type="number" formControlName="year" placeholder="Enter year">
                                    <mat-icon matPrefix class="icon-size-5" [svgIcon]="'heroicons_outline:calendar'"></mat-icon>
                                </mat-form-field>

                                <!-- Floors -->
                                <mat-form-field class="w-full">
                                    <mat-label>Number of Floors</mat-label>
                                    <input matInput type="number" formControlName="floor" placeholder="Enter number of floors">
                                    <mat-icon matPrefix class="icon-size-5" [svgIcon]="'heroicons_outline:building-office'"></mat-icon>
                                </mat-form-field>

                                <!-- Description -->
                                <mat-form-field class="w-full md:col-span-2">
                                    <mat-label>Description</mat-label>
                                    <textarea matInput formControlName="description" rows="4" placeholder="Enter building description"></textarea>
                                    <mat-icon matPrefix class="icon-size-5" [svgIcon]="'heroicons_outline:document-text'"></mat-icon>
                                </mat-form-field>
                            </div>

                            <!-- Actions -->
                            <div class="flex items-center justify-end gap-4 mt-6 pt-6 border-t">
                                <button mat-stroked-button type="button" (click)="cancelEdit()" [disabled]="isLoading">
                                    Cancel
                                </button>
                                <button mat-flat-button color="primary" type="button" (click)="saveBuilding()" [disabled]="isLoading || buildingForm.invalid">
                                    <mat-icon *ngIf="isLoading" class="icon-size-5 mr-2 animate-spin text-white" [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
                                    <span>{{ (isEditMode && editingMode) ? 'Update' : 'Create' }} Building</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Right Column - Properties List (1/3 width) - Only in edit/add mode -->
                <div class="lg:col-span-1" *ngIf="editingMode">
                    <div class="bg-white dark:bg-gray-800 shadow rounded-lg sticky top-6">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <div class="text-xl font-semibold text-gray-900 dark:text-white">Properties</div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">{{ buildingProperties.length }} {{ buildingProperties.length === 1 ? 'Property' : 'Properties' }}</div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="space-y-3 mb-6">
                                <button 
                                    mat-flat-button 
                                    color="primary" 
                                    type="button"
                                    class="w-full"
                                    (click)="openAddPropertyDialog()"
                                    [disabled]="!isEditMode">
                                    <mat-icon class="icon-size-5 mr-2 text-white" [svgIcon]="'heroicons_outline:plus-circle'"></mat-icon>
                                    <span>Create New</span>
                                </button>
                                
                                <button 
                                    mat-stroked-button 
                                    type="button"
                                    class="w-full"
                                    (click)="openAttachPropertyDialog()"
                                    [disabled]="!isEditMode">
                                    <mat-icon class="icon-size-5 mr-2" [svgIcon]="'heroicons_outline:link'"></mat-icon>
                                    <span>Attach Existing</span>
                                </button>
                            </div>
                            
                            <div *ngIf="!isEditMode" class="text-sm text-secondary text-center p-3 mb-6 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
                                <mat-icon class="icon-size-5 align-middle mr-1" [svgIcon]="'heroicons_outline:information-circle'"></mat-icon>
                                Save building first
                            </div>
                            
                            <!-- Properties List -->
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                                <!-- Loading State -->
                                <div *ngIf="loadingProperties" class="flex items-center justify-center py-8">
                                    <mat-icon class="icon-size-6 animate-spin text-primary-600" [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
                                </div>
                                
                                <!-- Properties List -->
                                <ng-container *ngIf="!loadingProperties">
                                    <div *ngIf="buildingProperties.length > 0; else noPropertiesSidebar" class="space-y-2 max-h-[400px] overflow-y-auto">
                                        <div *ngFor="let property of buildingProperties; trackBy: trackByFn"
                                             class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-900 rounded-lg hover:bg-primary-50 dark:hover:bg-gray-700 cursor-pointer transition-all"
                                             (click)="viewPropertyDetail(property.id)">
                                            
                                            <!-- Property Image/Icon -->
                                            <div class="flex-shrink-0">
                                                <div class="w-10 h-10 rounded overflow-hidden bg-gray-200 dark:bg-gray-800">
                                                    <ng-container *ngIf="property.defaultAttachmentUrl; else propertyIconTiny">
                                                        <img [src]="property.defaultAttachmentUrl" 
                                                            [alt]="property.name"
                                                            class="w-full h-full object-cover" />
                                                    </ng-container>
                                                    <ng-template #propertyIconTiny>
                                                        <div class="w-full h-full flex items-center justify-center">
                                                            <mat-icon class="icon-size-4 text-primary-600 dark:text-primary-400" 
                                                                [svgIcon]="'heroicons_outline:home'">
                                                            </mat-icon>
                                                        </div>
                                                    </ng-template>
                                                </div>
                                            </div>
                                            
                                            <div class="flex-1 min-w-0">
                                                <div class="font-medium text-xs text-gray-900 dark:text-white truncate">{{ property.name }}</div>
                                                <div class="text-xs text-primary-600 dark:text-primary-400 font-semibold">
                                                    {{ property.price | pricePaymentType:property.typePaiment }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- No Properties -->
                                    <ng-template #noPropertiesSidebar>
                                        <div class="flex flex-col items-center justify-center py-6 text-center">
                                            <mat-icon class="icon-size-10 text-gray-300 dark:text-gray-600 mb-2" 
                                                [svgIcon]="'heroicons_outline:home'">
                                            </mat-icon>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">No properties in this building</div>
                                        </div>
                                    </ng-template>
                                </ng-container>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>
</div>
