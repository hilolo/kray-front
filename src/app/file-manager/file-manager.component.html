<z-page zTitle="File Manager">
  <div class="space-y-6">
      <!-- Header with Search and Actions -->
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <!-- Search Input with Storage Indicator -->
        <div class="flex items-center gap-3 flex-1 max-w-2xl">
          <div class="relative flex-1 max-w-md">
            <z-icon zType="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground" zSize="sm" />
            <input
              z-input
              type="text"
              placeholder="Search files and folders..."
              [value]="searchTerm()"
              (input)="onSearchChange($event)"
              class="pl-9 w-full"
            />
          </div>
          <!-- Storage Usage Indicator and Reset Button -->
          <div class="flex items-center gap-2">
            @if (storageUsage()) {
              <div class="flex items-center gap-1.5 px-2 py-1.5 rounded-md border bg-background dark:bg-muted/50 border-border">
                <z-circular-progress
                  [progress]="storageUsagePercentage()"
                  [zType]="storageUsageType()"
                  zSize="sm"
                  [showLabel]="false"
                  class="flex-shrink-0 !w-8 !h-8"
                />
                <div class="flex flex-col">
                  <span class="text-[11px] font-medium leading-none text-foreground">{{ storageUsageText() }}</span>
                  <span class="text-[9px] text-muted-foreground leading-none mt-0.5">{{ storageUsagePercentage() }}% used</span>
                </div>
              </div>
            }
            <!-- Reset button -->
            @if (hasSearchTerm()) {
              <z-button 
                zType="outline" 
                zSize="sm" 
                class="gap-1.5 text-destructive border-destructive hover:bg-destructive hover:text-destructive-foreground"
                (click)="clearSearch()"
              >
                <z-icon zType="x" zSize="sm" />
                <span>Reset</span>
              </z-button>
            }
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex items-center gap-2" style="overflow: visible;">
          <z-button zType="ghost" zSize="default" (click)="refresh()" [disabled]="isLoading()">
            <z-icon zType="refresh-cw" class="mr-2" [class.animate-spin]="isLoading()" />
            Refresh
          </z-button>
          <z-button zType="ghost" zSize="default" (click)="selectAllFiles()" [disabled]="isLoading()">
            Select All
          </z-button>
          @if (hasSelectedFiles()) {
            <z-button zType="ghost" zSize="default" (click)="deselectAllFiles()" [disabled]="isLoading()">
              Deselect All
            </z-button>
          }
          <z-button zType="default" zSize="default" (click)="uploadFile()" [disabled]="isLoading() || isUploading()">
            <z-icon zType="upload" class="mr-2" [class.animate-spin]="isUploading()" />
            @if (isUploading()) {
              Uploading...
            } @else {
              Upload File(s)
            }
          </z-button>
          <z-button zType="default" zSize="default" (click)="createNewFolder()" [disabled]="isLoading()">
            <z-icon zType="folder-plus" class="mr-2" />
            New Folder
          </z-button>
          @if (hasSelectedFiles()) {
            <z-button zType="destructive" zSize="default" (click)="deleteSelectedFiles()" [disabled]="isLoading() || isDeleting()">
              <z-icon zType="x" class="mr-2" [class.animate-spin]="isDeleting()" />
              @if (isDeleting()) {
                Deleting...
              } @else {
                Delete ({{ selectedFileIds().size }})
              }
            </z-button>
          }
        </div>
      </div>

      <!-- Current Path Breadcrumb -->
      <div class="flex items-center gap-2">
        @if (canNavigateBack()) {
          <z-button zType="ghost" zSize="sm" (click)="navigateBack()" [disabled]="isLoading()">
            <z-icon zType="chevron-left" class="mr-1" />
            Back
          </z-button>
        }
        <z-breadcrumb>
          <z-breadcrumb-list>
            @for (segment of pathSegments(); track segment.root ?? 'root'; let i = $index) {
              <z-breadcrumb-item>
                @if (i === pathSegments().length - 1) {
                  <z-breadcrumb-page>
                    {{ segment.label }}
                  </z-breadcrumb-page>
                } @else {
                  <z-breadcrumb-link [zLink]="currentRoutePath()" (click)="navigateToPath(segment.root, $event)">
                    {{ segment.label }}
                  </z-breadcrumb-link>
                }
              </z-breadcrumb-item>
              @if (i < pathSegments().length - 1) {
                <z-breadcrumb-separator />
              }
            }
          </z-breadcrumb-list>
        </z-breadcrumb>
      </div>

      <!-- Folders Section -->
      @if (filteredFolders().length > 0) {
        <div class="space-y-4">
          <h2 class="text-lg font-semibold">Folders</h2>
          <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3">
            @for (folder of filteredFolders(); track folder.id) {
              <z-card 
                class="cursor-pointer hover:shadow-md transition-shadow relative group"
                [class.border-primary]="selectedItem()?.id === folder.id && selectedItem()?.type === 'folder'"
                [class.border-dashed]="folder.isTemporary"
                [class.border-2]="folder.isTemporary"
                [class.border-muted-foreground/50]="folder.isTemporary"
                [class.opacity-75]="folder.isTemporary"
                [class.bg-muted/30]="folder.isTemporary"
                (click)="navigateToFolder(folder)"
              >
                <div class="flex flex-col items-center gap-2 p-3">
                  <!-- Temporary Badge -->
                  @if (folder.isTemporary) {
                    <div class="absolute top-2 left-2 z-10">
                      <span class="inline-flex items-center gap-1 px-1.5 py-0.5 text-[10px] font-medium bg-yellow-500/20 text-yellow-700 dark:text-yellow-400 rounded border border-yellow-500/30">
                        <z-icon zType="folder-plus" class="!w-3 !h-3" zSize="sm" />
                        temporary
                      </span>
                    </div>
                  }
                  
                  <!-- Info Icon -->
                  <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <z-icon zType="info" class="text-primary" zSize="sm" />
                  </div>
                  
                  <!-- Folder Icon -->
                  <z-icon 
                    [zType]="folder.isTemporary ? 'folder-plus' : 'folder'" 
                    [class.text-muted-foreground]="!folder.isTemporary"
                    [class.text-yellow-600]="folder.isTemporary"
                    [class.dark:text-yellow-400]="folder.isTemporary"
                    class="!w-10 !h-10" 
                    zSize="xl" 
                  />
                  
                  <!-- Folder Name -->
                  <div class="text-center w-full">
                    <h3 class="font-medium text-xs truncate" [class.text-muted-foreground]="folder.isTemporary">
                      {{ folder.name }}
                    </h3>
                    @if (folder.isTemporary) {
                      <p class="text-[10px] text-muted-foreground mt-0.5">Empty folder</p>
                    }
                  </div>
                </div>
              </z-card>
            }
          </div>
        </div>
      }

      <!-- Files Section -->
      @if (filteredFiles().length > 0) {
        <div class="space-y-4">
          <h2 class="text-lg font-semibold">Files</h2>
          <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3">
            @for (file of filteredFiles(); track file.id) {
              <z-card 
                class="hover:shadow-md transition-shadow relative"
                [class.border-primary]="isFileSelected(file.id)"
              >
                <div class="flex flex-col items-center gap-2 p-3">
                  <!-- Checkbox -->
                  <div class="absolute top-2 left-2 z-10" (click)="$event.stopPropagation()">
                    <z-checkbox
                      [ngModel]="isFileSelected(file.id)"
                      (checkChange)="toggleFileSelection(file.id, $event)"
                    />
                  </div>
                  
                  <!-- File Icon with Extension Badge -->
                  <div class="relative cursor-pointer flex items-center justify-center mb-2" (click)="file.url ? openFile(file.url, file.name, file.size || 0) : selectItem(file)">
                    <div class="relative">
                      <z-icon [zType]="getFileIconType(file.extension)" class="text-muted-foreground !w-12 !h-12" zSize="xl" />
                      <div 
                        class="absolute -bottom-1 -right-1 px-1.5 py-0.5 text-[10px] font-medium text-white rounded shadow-sm min-w-[28px] text-center z-10"
                        [class]="getExtensionColor(file.extension)"
                      >
                        {{ file.extension.toUpperCase() }}
                      </div>
                    </div>
                  </div>
                  
                  <!-- File Name -->
                  <div class="text-center w-full cursor-pointer" (click)="file.url ? openFile(file.url, file.name, file.size || 0) : selectItem(file)">
                    <p class="text-xs font-medium truncate" [title]="file.name">{{ file.name }}</p>
                  </div>
                </div>
              </z-card>
            }
          </div>
        </div>
      }

      <!-- Loading State -->
      @if (isLoading()) {
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <z-icon zType="loader-circle" class="text-muted-foreground mb-4 animate-spin" zSize="lg" />
          <h3 class="text-lg font-semibold mb-2">Loading...</h3>
        </div>
      }

      <!-- Empty State -->
      @if (isCurrentFolderEmpty()) {
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <z-icon 
            [zType]="isCurrentFolderTemporary() ? 'folder-plus' : 'folder'" 
            [class.text-muted-foreground]="!isCurrentFolderTemporary()"
            [class.text-yellow-600]="isCurrentFolderTemporary()"
            [class.dark:text-yellow-400]="isCurrentFolderTemporary()"
            class="mb-4" 
            zSize="lg" 
          />
          <h3 class="text-lg font-semibold mb-2">
            @if (isCurrentFolderTemporary()) {
              Temporary Folder - No Data
            } @else {
              {{ searchTerm() ? 'No results found' : 'No files or folders' }}
            }
          </h3>
          <p class="text-sm text-muted-foreground">
            @if (isCurrentFolderTemporary()) {
              This is a temporary folder. Upload files to save it permanently.
            } @else {
              {{ searchTerm() ? 'Try adjusting your search terms' : 'This folder is empty' }}
            }
          </p>
          @if (!searchTerm() && currentRoot()) {
            <p class="text-xs text-muted-foreground mt-2">
              Upload files or create a new folder to get started
            </p>
          }
        </div>
      }
    </div>

  <!-- File Viewer -->
  <z-file-viewer
    [isOpen]="fileViewerOpen()"
    [fileUrl]="fileViewerUrl()"
    [fileName]="fileViewerName()"
    [fileSize]="fileViewerSize()"
    [images]="fileViewerImages()"
    [currentIndex]="fileViewerCurrentIndex()"
    (close)="fileViewerOpen.set(false)"
    (imageChanged)="onImageChanged($event)"
  />
</z-page>

