<z-page [zTitle]="'collaboration.title' | translate">
  <div class="flex flex-col h-full min-h-0 relative">
    <!-- Back button -->
    <div class="mb-6">
      <z-button zType="outline" zSize="default" class="gap-2" (click)="backToApp()">
        <z-icon zType="chevron-left" zSize="sm" />
        {{ 'collaboration.backToApp' | translate }}
      </z-button>
    </div>

    <!-- Header Section: Type Switcher and Filters -->
    <div class="mb-6 flex-shrink-0">
      <div class="flex flex-col gap-4">
        <!-- Type Switcher Tabs and Filter Buttons Row -->
        <div class="flex flex-wrap gap-3 items-center justify-between">
          <!-- Filter Buttons (Left Side) -->
          <div class="flex flex-wrap gap-3 items-center">
          <!-- Category Filter -->
          <div class="w-full sm:w-[200px]">
            <z-combobox
              [options]="categoryOptions()"
              [value]="selectedCategory() !== null ? selectedCategory()!.toString() : null"
              [placeholder]="'collaboration.filters.category' | translate"
              [emptyText]="'collaboration.filters.noCategory' | translate"
              [searchable]="false"
              (zValueChange)="onCategoryChange($event)"
              class="w-full"
            />
          </div>

          <!-- Price Filter Button -->
          <div class="relative">
            <z-button 
              zType="outline" 
              zSize="default" 
              class="gap-2 min-w-[140px] justify-between"
              (click)="togglePricePanel()"
            >
              <span>{{ getPriceLabel() }}</span>
              <z-icon zType="chevron-down" zSize="sm" [class.rotate-180]="isPricePanelOpen()" class="transition-transform" />
            </z-button>
            
            <!-- Price Panel -->
            @if (isPricePanelOpen()) {
              <div class="absolute top-full left-0 mt-2 bg-card border border-border rounded-lg shadow-lg p-4 z-50 min-w-[400px]">
                <div class="flex items-center gap-3">
                  <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.minPrice' | translate }}</label>
                    <z-combobox
                      [options]="priceOptions()"
                      [value]="minPrice() || ''"
                      [placeholder]="'collaboration.filters.indifferent' | translate"
                      [searchable]="false"
                      (zValueChange)="onMinPriceChange($event)"
                      class="w-full"
                    />
                  </div>
                  <span class="text-muted-foreground mt-6">-</span>
                  <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.maxPrice' | translate }}</label>
                    <z-combobox
                      [options]="priceOptions()"
                      [value]="maxPrice() || ''"
                      [placeholder]="'collaboration.filters.indifferent' | translate"
                      [searchable]="false"
                      (zValueChange)="onMaxPriceChange($event)"
                      class="w-full"
                    />
                  </div>
                </div>
              </div>
            }
          </div>

          <!-- Surface Filter Button -->
          <div class="relative">
            <z-button 
              zType="outline" 
              zSize="default" 
              class="gap-2 min-w-[140px] justify-between"
              (click)="toggleSurfacePanel()"
            >
              <span>{{ getSurfaceLabel() }}</span>
              <z-icon zType="chevron-down" zSize="sm" [class.rotate-180]="isSurfacePanelOpen()" class="transition-transform" />
            </z-button>
            
            <!-- Surface Panel -->
            @if (isSurfacePanelOpen()) {
              <div class="absolute top-full left-0 mt-2 bg-card border border-border rounded-lg shadow-lg p-4 z-50 min-w-[400px]">
                <div class="flex items-center gap-3">
                  <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.minSurface' | translate }}</label>
                    <z-combobox
                      [options]="surfaceOptions()"
                      [value]="minArea() || ''"
                      [placeholder]="'collaboration.filters.indifferent' | translate"
                      [searchable]="false"
                      (zValueChange)="onMinAreaChange($event)"
                      class="w-full"
                    />
                  </div>
                  <span class="text-muted-foreground mt-6">-</span>
                  <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.maxSurface' | translate }}</label>
                    <z-combobox
                      [options]="surfaceOptions()"
                      [value]="maxArea() || ''"
                      [placeholder]="'collaboration.filters.indifferent' | translate"
                      [searchable]="false"
                      (zValueChange)="onMaxAreaChange($event)"
                      class="w-full"
                    />
                  </div>
                </div>
              </div>
            }
          </div>

          <!-- Bedrooms Filter Button -->
          <div class="relative">
            <z-button 
              zType="outline" 
              zSize="default" 
              class="gap-2 min-w-[140px] justify-between"
              (click)="toggleBedroomsPanel()"
            >
              <span>{{ getBedroomsLabel() }}</span>
              <z-icon zType="chevron-down" zSize="sm" [class.rotate-180]="isBedroomsPanelOpen()" class="transition-transform" />
            </z-button>
            
            <!-- Bedrooms Panel -->
            @if (isBedroomsPanelOpen()) {
              <div class="absolute top-full left-0 mt-2 bg-card border border-border rounded-lg shadow-lg p-4 z-50 min-w-[200px]">
                <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.bedrooms' | translate }}</label>
                <z-combobox
                  [options]="bedroomsOptions()"
                  [value]="selectedBedrooms() || ''"
                  [placeholder]="'collaboration.filters.indifferent' | translate"
                  [searchable]="false"
                  (zValueChange)="onBedroomsChange($event)"
                  class="w-full"
                />
              </div>
            }
          </div>

          <!-- Reset Button -->
          @if (hasActiveFilters()) {
            <z-button zType="outline" zSize="default" class="gap-2" (click)="onResetFilters()">
              <z-icon zType="x" zSize="sm" />
              <span>{{ 'common.reset' | translate }}</span>
            </z-button>
          }
          </div>

          <!-- My shared button + Type Switcher Tabs (Right Side) - Mes partagés on top, then Biens | Demandes -->
          <div class="flex flex-col gap-2 items-end">
            <z-button zType="outline" zSize="default" class="gap-2" (click)="openMySharedPanel()">
              <z-icon zType="users" zSize="sm" />
              {{ 'collaboration.myShared' | translate }}
            </z-button>
            <div class="flex items-center bg-muted rounded-lg p-1">
              <button
                type="button"
                (click)="onViewTypeChange('properties')"
                class="px-4 py-2 text-sm font-medium rounded-md transition-colors"
                [class.bg-orange-600]="selectedViewType() === 'properties'"
                [class.text-white]="selectedViewType() === 'properties'"
                [class.dark:bg-orange-500]="selectedViewType() === 'properties'"
                [class.shadow-sm]="selectedViewType() === 'properties'"
                [class.text-muted-foreground]="selectedViewType() !== 'properties'"
                [class.hover:text-foreground]="selectedViewType() !== 'properties'"
              >
                <div class="flex items-center gap-2">
                  <z-icon zType="house" zSize="sm" />
                  <span>{{ 'collaboration.types.properties' | translate }}</span>
                </div>
              </button>
              <button
                type="button"
                (click)="onViewTypeChange('requests')"
                class="px-4 py-2 text-sm font-medium rounded-md transition-colors"
                [class.bg-emerald-600]="selectedViewType() === 'requests'"
                [class.text-white]="selectedViewType() === 'requests'"
                [class.dark:bg-emerald-500]="selectedViewType() === 'requests'"
                [class.shadow-sm]="selectedViewType() === 'requests'"
                [class.text-muted-foreground]="selectedViewType() !== 'requests'"
                [class.hover:text-foreground]="selectedViewType() !== 'requests'"
              >
                <div class="flex items-center gap-2">
                  <z-icon zType="file-text" zSize="sm" />
                  <span>{{ 'collaboration.types.requests' | translate }}</span>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Properties/Requests Grid -->
    <div class="flex-1 min-h-0 overflow-y-auto mb-6">
      @if (isLoadingCurrentTab()) {
        <div class="flex items-center justify-center min-h-[400px]">
          <div class="text-center space-y-4">
            <z-icon zType="loader-circle" class="w-8 h-8 animate-spin mx-auto text-primary" />
            <p class="text-sm text-muted-foreground">{{ 'common.loading' | translate }}</p>
          </div>
        </div>
      } @else if (!hasData()) {
        <div class="flex items-center justify-center min-h-[400px]">
          <div class="text-center">
            <p class="text-muted-foreground">{{ emptyMessage() }}</p>
          </div>
        </div>
      } @else {
        <!-- Properties View -->
        @if (selectedViewType() === 'properties') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            @for (property of filteredProperties(); track property.id) {
              <app-collaboration-property-card
                [property]="property"
                [currentImageIndex]="getCurrentImageIndex(property.id)"
                [images]="getPropertyImages(property)"
                (previousImage)="onPreviousImage($event)"
                (nextImage)="onNextImage($event)"
                (viewProperty)="onViewPropertyFromCard($event)"
                (contactCall)="callCompany($event)"
                (contactWhatsApp)="contactViaWhatsApp($event)"
              />
            }
          </div>
        }
        
        <!-- Requests View -->
        @if (selectedViewType() === 'requests') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            @for (request of filteredRequests(); track request.id) {
              <app-collaboration-request-card
                [request]="request"
                (contactCall)="callRequestCompany($event)"
              />
            }
          </div>
        }
      }
    </div>

    <!-- Custom Pagination - At the bottom -->
    @if (hasData()) {
      <div class="flex-shrink-0 pt-4 pb-2 border-t border-border flex flex-col gap-3 items-center justify-between sm:flex-row">
        <!-- Results Info -->
        <div class="text-sm text-muted-foreground whitespace-nowrap">
          {{ paginatedInfo().start }} - {{ paginatedInfo().end }} {{ 'collaboration.of' | translate }} {{ paginatedInfo().total }} {{ 'collaboration.results' | translate }} | {{ 'collaboration.page' | translate }} {{ currentPage() }} {{ 'collaboration.of' | translate }} {{ totalPages() }}
        </div>
        
        <!-- Page Navigation -->
        <div class="flex items-center gap-2">
          <!-- Previous Button -->
          <button
            type="button"
            [disabled]="currentPage() === 1"
            (click)="previousPage()"
            class="p-2 rounded-md border border-border disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition-colors"
            [class.text-primary]="currentPage() > 1"
            [class.text-muted-foreground]="currentPage() === 1"
          >
            <z-icon zType="chevron-left" zSize="sm" />
          </button>
          
          <!-- Page Numbers -->
          @for (pageNum of getVisiblePageNumbers(); track pageNum) {
            <button
              type="button"
              (click)="goToPage(pageNum)"
              class="min-w-[2.5rem] h-10 px-3 rounded-md text-sm font-medium transition-colors"
              [class.bg-primary]="pageNum === currentPage()"
              [class.text-primary-foreground]="pageNum === currentPage()"
              [class.bg-background]="pageNum !== currentPage()"
              [class.text-foreground]="pageNum !== currentPage()"
              [class.border]="pageNum !== currentPage()"
              [class.border-border]="pageNum !== currentPage()"
              [class.hover:bg-muted]="pageNum !== currentPage()"
            >
              {{ pageNum }}
            </button>
          }
          
          <!-- Next Button -->
          <button
            type="button"
            [disabled]="currentPage() === totalPages()"
            (click)="nextPage()"
            class="p-2 rounded-md border border-border disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition-colors"
            [class.text-primary]="currentPage() < totalPages()"
            [class.text-muted-foreground]="currentPage() === totalPages()"
          >
            <z-icon zType="chevron-right" zSize="sm" />
          </button>
        </div>
      </div>
    }

    <!-- Backdrop when panel open -->
    @if (isMySharedPanelOpen()) {
      <button
        type="button"
        class="fixed inset-0 bg-black/20 z-40 transition-opacity"
        [attr.aria-label]="'common.close' | translate"
        (click)="closeMySharedPanel()"
      ></button>
    }
    <!-- My shared panel (slide from right) -->
    <div
      class="fixed top-0 right-0 bottom-0 w-full max-w-md bg-card border-l border-border shadow-lg z-50 flex flex-col transition-transform duration-300 ease-out"
      [class.translate-x-0]="isMySharedPanelOpen()"
      [class.translate-x-full]="!isMySharedPanelOpen()"
    >
      <div class="flex-shrink-0 p-4 border-b border-border flex items-center justify-between">
        <h3 class="text-lg font-semibold">
          @if (selectedViewType() === 'properties') {
            {{ 'collaboration.mySharedProperties' | translate }}
          } @else {
            {{ 'collaboration.mySharedRequests' | translate }}
          }
        </h3>
        <button
          type="button"
          (click)="closeMySharedPanel()"
          class="p-2 rounded-md hover:bg-muted transition-colors"
          [attr.aria-label]="'common.close' | translate"
        >
          <z-icon zType="x" zSize="sm" />
        </button>
      </div>
      <div class="flex-1 min-h-0 overflow-y-auto p-4">
        @if (selectedViewType() === 'properties') {
          @if (isLoadingMyShared()) {
            <div class="flex items-center justify-center py-12">
              <z-icon zType="loader-circle" class="w-8 h-8 animate-spin text-primary" />
            </div>
          } @else if (mySharedProperties().length === 0) {
            <p class="text-sm text-muted-foreground text-center py-8">{{ 'collaboration.mySharedEmpty' | translate }}</p>
          } @else {
            <ul class="space-y-3">
              @for (property of mySharedProperties(); track property.id) {
                <li class="rounded-lg border border-border bg-background overflow-hidden">
                  <div class="p-3 space-y-2">
                    <div class="flex items-start justify-between gap-2">
                      <div class="min-w-0 flex-1">
                        <p class="font-semibold text-sm text-orange-600 dark:text-orange-500">{{ getPropertyDisplayLabel(property) }}</p>
                        @if (property.identifier) {
                          <p class="text-xs text-muted-foreground">{{ property.identifier }}</p>
                        }
                      </div>
                      <z-button
                        zType="outline"
                        zSize="sm"
                        class="flex-shrink-0 text-destructive hover:bg-destructive/10 hover:border-destructive/50 text-xs"
                        (click)="onDisablePropertyCollaboration(property.id)"
                      >
                        <z-icon zType="ban" zSize="sm" class="mr-1" />
                        {{ 'collaboration.disableCollaboration' | translate }}
                      </z-button>
                    </div>
                    @if (property.city) {
                      <div class="flex items-center gap-1.5 text-xs text-muted-foreground">
                        <z-icon zType="map-pin" zSize="sm" class="flex-shrink-0 w-3 h-3" />
                        <span>{{ property.city }}</span>
                      </div>
                    }
                    <div class="flex flex-wrap gap-3 text-xs">
                      @if (property.area > 0) {
                        <span class="flex items-center gap-1">
                          <z-icon zType="file" zSize="sm" class="w-3 h-3 text-muted-foreground" />
                          {{ property.area }} m²
                        </span>
                      }
                      @if (property.pieces > 0) {
                        <span class="flex items-center gap-1">
                          <z-icon zType="house" zSize="sm" class="w-3 h-3 text-muted-foreground" />
                          {{ property.pieces }} {{ property.pieces === 1 ? ('collaboration.piece' | translate) : ('collaboration.pieces' | translate) }}
                        </span>
                      }
                      @if (property.price > 0) {
                        <span class="font-medium">{{ property.price | number:'1.0-0' }} DH</span>
                      }
                    </div>
                    @if (property.description) {
                      <p class="text-xs text-muted-foreground line-clamp-2">{{ property.description }}</p>
                    }
                  </div>
                </li>
              }
            </ul>
          }
        } @else {
          @if (mySharedRequests().length === 0) {
            <p class="text-sm text-muted-foreground text-center py-8">{{ 'collaboration.mySharedEmpty' | translate }}</p>
          } @else {
            <ul class="space-y-3">
              @for (request of mySharedRequests(); track request.id) {
                <li class="rounded-lg border border-border bg-background overflow-hidden">
                  <div class="p-3 space-y-2">
                    <div class="flex items-start justify-between gap-2">
                      <div class="min-w-0 flex-1">
                        @if (getRequestLocationLabel(request)) {
                          <p class="font-semibold text-sm text-emerald-600 dark:text-emerald-500">
                            {{ getRequestLocationLabel(request) }}
                          </p>
                        }
                        <p class="text-xs text-muted-foreground">{{ getRequestCategoryLabel(request) }}</p>
                      </div>
                      <z-button
                        zType="outline"
                        zSize="sm"
                        class="flex-shrink-0 text-destructive hover:bg-destructive/10 hover:border-destructive/50 text-xs"
                        (click)="onDisableRequestCollaboration(request.id)"
                      >
                        <z-icon zType="ban" zSize="sm" class="mr-1" />
                        {{ 'collaboration.disableCollaboration' | translate }}
                      </z-button>
                    </div>
                    @if (request.budget > 0) {
                      <p class="text-sm font-medium">{{ request.budget | number:'1.0-0' }} DH</p>
                    }
                    <div class="flex flex-wrap gap-3 text-xs text-muted-foreground">
                      @if (request.surface > 0) {
                        <span class="flex items-center gap-1">
                          <z-icon zType="file" zSize="sm" class="w-3 h-3" />
                          {{ request.surface }} m²
                        </span>
                      }
                      @if (request.pieces > 0) {
                        <span class="flex items-center gap-1">
                          <z-icon zType="house" zSize="sm" class="w-3 h-3" />
                          {{ request.pieces }} {{ request.pieces === 1 ? ('collaboration.piece' | translate) : ('collaboration.pieces' | translate) }}
                        </span>
                      }
                      @if (request.bathrooms > 0) {
                        <span class="flex items-center gap-1">
                          <z-icon zType="layers" zSize="sm" class="w-3 h-3" />
                          {{ request.bathrooms }} {{ 'collaboration.bathroom' | translate }}
                        </span>
                      }
                      @if (request.isFurnished) {
                        <span class="flex items-center gap-1">
                          <z-icon zType="check" zSize="sm" class="w-3 h-3" />
                          {{ 'property.detail.furnished' | translate }}
                        </span>
                      }
                    </div>
                    @if (request.description) {
                      <p class="text-xs text-muted-foreground line-clamp-2">{{ request.description }}</p>
                    }
                  </div>
                </li>
              }
            </ul>
          }
        }
      </div>
    </div>
  </div>
</z-page>
