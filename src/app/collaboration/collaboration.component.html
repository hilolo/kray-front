<z-page [zTitle]="'collaboration.title' | translate">
  <div class="flex flex-col h-full min-h-0">
    <!-- Back button section -->
    <div class="mb-6">
      <z-button zType="outline" zSize="default" class="gap-2" (click)="backToApp()">
        <z-icon zType="chevron-left" zSize="sm" />
        {{ 'collaboration.backToApp' | translate }}
      </z-button>
    </div>


    <!-- Header Section: Type Switcher and Filters -->
    <div class="mb-6 flex-shrink-0">
      <div class="flex flex-col gap-4">
        <!-- Type Switcher Tabs and Filter Buttons Row -->
        <div class="flex flex-wrap gap-3 items-center justify-between">
          <!-- Filter Buttons (Left Side) -->
          <div class="flex flex-wrap gap-3 items-center">
          <!-- Category Filter -->
          <div class="w-full sm:w-[200px]">
            <z-combobox
              [options]="categoryOptions()"
              [value]="selectedCategory() !== null ? selectedCategory()!.toString() : null"
              [placeholder]="'collaboration.filters.category' | translate"
              [emptyText]="'collaboration.filters.noCategory' | translate"
              [searchable]="false"
              (zValueChange)="onCategoryChange($event)"
              class="w-full"
            />
          </div>

          <!-- Price Filter Button -->
          <div class="relative">
            <z-button 
              zType="outline" 
              zSize="default" 
              class="gap-2 min-w-[140px] justify-between"
              (click)="togglePricePanel()"
            >
              <span>{{ getPriceLabel() }}</span>
              <z-icon zType="chevron-down" zSize="sm" [class.rotate-180]="isPricePanelOpen()" class="transition-transform" />
            </z-button>
            
            <!-- Price Panel -->
            @if (isPricePanelOpen()) {
              <div class="absolute top-full left-0 mt-2 bg-card border border-border rounded-lg shadow-lg p-4 z-50 min-w-[400px]">
                <div class="flex items-center gap-3">
                  <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.minPrice' | translate }}</label>
                    <z-combobox
                      [options]="priceOptions()"
                      [value]="minPrice() || ''"
                      [placeholder]="'collaboration.filters.indifferent' | translate"
                      [searchable]="false"
                      (zValueChange)="onMinPriceChange($event)"
                      class="w-full"
                    />
                  </div>
                  <span class="text-muted-foreground mt-6">-</span>
                  <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.maxPrice' | translate }}</label>
                    <z-combobox
                      [options]="priceOptions()"
                      [value]="maxPrice() || ''"
                      [placeholder]="'collaboration.filters.indifferent' | translate"
                      [searchable]="false"
                      (zValueChange)="onMaxPriceChange($event)"
                      class="w-full"
                    />
                  </div>
                </div>
              </div>
            }
          </div>

          <!-- Surface Filter Button -->
          <div class="relative">
            <z-button 
              zType="outline" 
              zSize="default" 
              class="gap-2 min-w-[140px] justify-between"
              (click)="toggleSurfacePanel()"
            >
              <span>{{ getSurfaceLabel() }}</span>
              <z-icon zType="chevron-down" zSize="sm" [class.rotate-180]="isSurfacePanelOpen()" class="transition-transform" />
            </z-button>
            
            <!-- Surface Panel -->
            @if (isSurfacePanelOpen()) {
              <div class="absolute top-full left-0 mt-2 bg-card border border-border rounded-lg shadow-lg p-4 z-50 min-w-[400px]">
                <div class="flex items-center gap-3">
                  <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.minSurface' | translate }}</label>
                    <z-combobox
                      [options]="surfaceOptions()"
                      [value]="minArea() || ''"
                      [placeholder]="'collaboration.filters.indifferent' | translate"
                      [searchable]="false"
                      (zValueChange)="onMinAreaChange($event)"
                      class="w-full"
                    />
                  </div>
                  <span class="text-muted-foreground mt-6">-</span>
                  <div class="flex-1">
                    <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.maxSurface' | translate }}</label>
                    <z-combobox
                      [options]="surfaceOptions()"
                      [value]="maxArea() || ''"
                      [placeholder]="'collaboration.filters.indifferent' | translate"
                      [searchable]="false"
                      (zValueChange)="onMaxAreaChange($event)"
                      class="w-full"
                    />
                  </div>
                </div>
              </div>
            }
          </div>

          <!-- Bedrooms Filter Button -->
          <div class="relative">
            <z-button 
              zType="outline" 
              zSize="default" 
              class="gap-2 min-w-[140px] justify-between"
              (click)="toggleBedroomsPanel()"
            >
              <span>{{ getBedroomsLabel() }}</span>
              <z-icon zType="chevron-down" zSize="sm" [class.rotate-180]="isBedroomsPanelOpen()" class="transition-transform" />
            </z-button>
            
            <!-- Bedrooms Panel -->
            @if (isBedroomsPanelOpen()) {
              <div class="absolute top-full left-0 mt-2 bg-card border border-border rounded-lg shadow-lg p-4 z-50 min-w-[200px]">
                <label class="block text-sm font-semibold mb-2">{{ 'collaboration.filters.bedrooms' | translate }}</label>
                <z-combobox
                  [options]="bedroomsOptions()"
                  [value]="selectedBedrooms() || ''"
                  [placeholder]="'collaboration.filters.indifferent' | translate"
                  [searchable]="false"
                  (zValueChange)="onBedroomsChange($event)"
                  class="w-full"
                />
              </div>
            }
          </div>

          <!-- Reset Button -->
          @if (hasActiveFilters()) {
            <z-button zType="outline" zSize="default" class="gap-2" (click)="onResetFilters()">
              <z-icon zType="x" zSize="sm" />
              <span>{{ 'common.reset' | translate }}</span>
            </z-button>
          }
          </div>

          <!-- Type Switcher Tabs (Right Side) - Bien left, Demande right with colors -->
          <div class="flex items-center bg-muted rounded-lg p-1">
            <button
              type="button"
              (click)="onViewTypeChange('properties')"
              class="px-4 py-2 text-sm font-medium rounded-md transition-colors"
              [class.bg-orange-600]="selectedViewType() === 'properties'"
              [class.text-white]="selectedViewType() === 'properties'"
              [class.dark:bg-orange-500]="selectedViewType() === 'properties'"
              [class.shadow-sm]="selectedViewType() === 'properties'"
              [class.text-muted-foreground]="selectedViewType() !== 'properties'"
              [class.hover:text-foreground]="selectedViewType() !== 'properties'"
            >
              <div class="flex items-center gap-2">
                <z-icon zType="house" zSize="sm" />
                <span>{{ 'collaboration.types.properties' | translate }}</span>
              </div>
            </button>
            <button
              type="button"
              (click)="onViewTypeChange('requests')"
              class="px-4 py-2 text-sm font-medium rounded-md transition-colors"
              [class.bg-emerald-600]="selectedViewType() === 'requests'"
              [class.text-white]="selectedViewType() === 'requests'"
              [class.dark:bg-emerald-500]="selectedViewType() === 'requests'"
              [class.shadow-sm]="selectedViewType() === 'requests'"
              [class.text-muted-foreground]="selectedViewType() !== 'requests'"
              [class.hover:text-foreground]="selectedViewType() !== 'requests'"
            >
              <div class="flex items-center gap-2">
                <z-icon zType="file-text" zSize="sm" />
                <span>{{ 'collaboration.types.requests' | translate }}</span>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Properties/Requests Grid -->
    <div class="flex-1 min-h-0 overflow-y-auto mb-6">
      @if (isLoadingCurrentTab()) {
        <div class="flex items-center justify-center min-h-[400px]">
          <div class="text-center space-y-4">
            <z-icon zType="loader-circle" class="w-8 h-8 animate-spin mx-auto text-primary" />
            <p class="text-sm text-muted-foreground">{{ 'common.loading' | translate }}</p>
          </div>
        </div>
      } @else if (!hasData()) {
        <div class="flex items-center justify-center min-h-[400px]">
          <div class="text-center">
            <p class="text-muted-foreground">{{ emptyMessage() }}</p>
          </div>
        </div>
      } @else {
        <!-- Properties View -->
        @if (selectedViewType() === 'properties') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            @for (property of filteredProperties(); track property.id) {
              <app-collaboration-property-card
                [property]="property"
                [currentImageIndex]="getCurrentImageIndex(property.id)"
                [images]="getPropertyImages(property)"
                (previousImage)="onPreviousImage($event)"
                (nextImage)="onNextImage($event)"
                (viewProperty)="onViewPropertyFromCard($event)"
                (contactCall)="callCompany($event)"
                (contactWhatsApp)="contactViaWhatsApp($event)"
              />
            }
          </div>
        }
        
        <!-- Requests View -->
        @if (selectedViewType() === 'requests') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            @for (request of filteredRequests(); track request.id) {
              <app-collaboration-request-card
                [request]="request"
                (contactCall)="callRequestCompany($event)"
                (contactWhatsApp)="contactRequestViaWhatsApp($event)"
              />
            }
          </div>
        }
      }
    </div>

    <!-- Custom Pagination - At the bottom -->
    @if (hasData()) {
      <div class="flex-shrink-0 pt-4 pb-2 border-t border-border flex flex-col gap-3 items-center justify-between sm:flex-row">
        <!-- Results Info -->
        <div class="text-sm text-muted-foreground whitespace-nowrap">
          {{ paginatedInfo().start }} - {{ paginatedInfo().end }} {{ 'collaboration.of' | translate }} {{ paginatedInfo().total }} {{ 'collaboration.results' | translate }} | {{ 'collaboration.page' | translate }} {{ currentPage() }} {{ 'collaboration.of' | translate }} {{ totalPages() }}
        </div>
        
        <!-- Page Navigation -->
        <div class="flex items-center gap-2">
          <!-- Previous Button -->
          <button
            type="button"
            [disabled]="currentPage() === 1"
            (click)="previousPage()"
            class="p-2 rounded-md border border-border disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition-colors"
            [class.text-primary]="currentPage() > 1"
            [class.text-muted-foreground]="currentPage() === 1"
          >
            <z-icon zType="chevron-left" zSize="sm" />
          </button>
          
          <!-- Page Numbers -->
          @for (pageNum of getVisiblePageNumbers(); track pageNum) {
            <button
              type="button"
              (click)="goToPage(pageNum)"
              class="min-w-[2.5rem] h-10 px-3 rounded-md text-sm font-medium transition-colors"
              [class.bg-primary]="pageNum === currentPage()"
              [class.text-primary-foreground]="pageNum === currentPage()"
              [class.bg-background]="pageNum !== currentPage()"
              [class.text-foreground]="pageNum !== currentPage()"
              [class.border]="pageNum !== currentPage()"
              [class.border-border]="pageNum !== currentPage()"
              [class.hover:bg-muted]="pageNum !== currentPage()"
            >
              {{ pageNum }}
            </button>
          }
          
          <!-- Next Button -->
          <button
            type="button"
            [disabled]="currentPage() === totalPages()"
            (click)="nextPage()"
            class="p-2 rounded-md border border-border disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition-colors"
            [class.text-primary]="currentPage() < totalPages()"
            [class.text-muted-foreground]="currentPage() === totalPages()"
          >
            <z-icon zType="chevron-right" zSize="sm" />
          </button>
        </div>
      </div>
    }
  </div>
</z-page>
