<z-page zTitle="Transactions">
  <div class="flex flex-col h-full min-h-0">
    <!-- Header Section -->
    <div class="space-y-6 pb-6 flex-shrink-0">
      <!-- Revenue/Expense Toggle and Status Legend - Top Row -->
      <div class="flex flex-col sm:flex-row justify-between items-center sm:items-start w-full gap-4">
        <!-- Revenue/Expense Toggle - Left/Center -->
        <div class="flex-1 flex justify-center items-center w-full sm:w-auto">
          <div class="inline-flex items-center gap-1 border rounded-lg p-1 bg-muted/50 shadow-sm">
            <z-button
              [zType]="selectedType() === TransactionType.Revenue ? 'default' : 'ghost'"
              zSize="sm"
              (click)="onTypeChange(TransactionType.Revenue)"
              [class.!bg-green-100]="selectedType() === TransactionType.Revenue"
              [class.hover:!bg-green-200]="selectedType() === TransactionType.Revenue"
              [class.!text-green-600]="selectedType() === TransactionType.Revenue"
              [class.border-green-200]="selectedType() === TransactionType.Revenue"
              [class.hover:border-green-300]="selectedType() === TransactionType.Revenue"
              [class.dark:!bg-green-900/30]="selectedType() === TransactionType.Revenue"
              [class.dark:hover:!bg-green-900/50]="selectedType() === TransactionType.Revenue"
              [class.dark:!text-green-400]="selectedType() === TransactionType.Revenue"
              [class.dark:border-green-800/50]="selectedType() === TransactionType.Revenue"
              [class.dark:hover:border-green-800/70]="selectedType() === TransactionType.Revenue"
              [class.shadow-sm]="selectedType() === TransactionType.Revenue"
              class="rounded-md transition-all duration-200 min-w-[100px] justify-center"
            >
              <z-icon zType="plus" zSize="sm" class="mr-1.5" [class.!text-green-600]="selectedType() === TransactionType.Revenue" [class.dark:!text-green-400]="selectedType() === TransactionType.Revenue" />
              Revenue
            </z-button>
            <z-button
              [zType]="selectedType() === TransactionType.Expense ? 'default' : 'ghost'"
              zSize="sm"
              (click)="onTypeChange(TransactionType.Expense)"
              [class.bg-red-500]="selectedType() === TransactionType.Expense"
              [class.text-white]="selectedType() === TransactionType.Expense"
              [class.hover:bg-red-600]="selectedType() === TransactionType.Expense"
              [class.dark:bg-red-600]="selectedType() === TransactionType.Expense"
              [class.dark:hover:bg-red-700]="selectedType() === TransactionType.Expense"
              [class.border-red-500]="selectedType() === TransactionType.Expense"
              [class.shadow-sm]="selectedType() === TransactionType.Expense"
              class="rounded-md transition-all duration-200 min-w-[100px] justify-center"
            >
              <z-icon zType="minus" zSize="sm" class="mr-1.5" />
              Expense
            </z-button>
          </div>
        </div>

        <!-- Status Legend - Top Right -->
        <div class="flex-shrink-0 w-full sm:w-auto">
          <div class="inline-flex items-center gap-2 sm:gap-3 px-3 sm:px-4 py-2 border rounded-lg bg-muted/50 shadow-sm w-full sm:w-auto justify-center sm:justify-start">
            <!-- Pending Status -->
            <div class="flex items-center gap-1.5 sm:gap-2">
              <div class="w-3 h-3 rounded-full bg-yellow-500 dark:bg-yellow-600 border border-yellow-600 dark:border-yellow-500 flex-shrink-0"></div>
              <span class="text-xs sm:text-sm font-medium text-foreground">Pending</span>
            </div>
            <!-- Paid Revenue Status - Show only when Revenue is selected -->
            @if (selectedType() === TransactionType.Revenue) {
              <div class="flex items-center gap-1.5 sm:gap-2">
                <div class="w-3 h-3 rounded-full bg-green-500 dark:bg-green-600 border border-green-600 dark:border-green-500 flex-shrink-0"></div>
                <span class="text-xs sm:text-sm font-medium text-foreground">Paid Revenue</span>
              </div>
            }
            <!-- Paid Expense Status - Show only when Expense is selected -->
            @if (selectedType() === TransactionType.Expense) {
              <div class="flex items-center gap-1.5 sm:gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500 dark:bg-red-600 border border-red-600 dark:border-red-500 flex-shrink-0"></div>
                <span class="text-xs sm:text-sm font-medium text-foreground">Paid Expense</span>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Filter and Action Bar -->
      <div class="flex flex-col gap-4">
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
          <!-- Filters on left -->
          <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center flex-1 w-full">
            <!-- Filters group: Search, Property, Contact, and Revenue Types -->
            <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center flex-shrink-0 w-full sm:w-auto">
              <!-- Search input -->
              <div class="w-full sm:w-[200px]">
                <z-input-group [zPrefix]="searchIconTemplateRef()">
                  <input
                    z-input
                    type="text"
                    [ngModel]="searchQuery()"
                    (ngModelChange)="onSearchChange($event)"
                    name="searchQuery"
                    placeholder="Search transactions..."
                    class="w-full text-sm"
                  />
                </z-input-group>
                <ng-template #searchIconTemplate>
                  <z-icon zType="search" zSize="sm" class="text-muted-foreground" />
                </ng-template>
              </div>
              
              <!-- Property select -->
              <div class="w-full sm:w-[200px]">
                <z-combobox
                  #propertyCombobox
                  [options]="propertyOptions()"
                  [value]="selectedPropertyId()"
                  [placeholder]="'Select property...'"
                  [searchPlaceholder]="'Search properties...'"
                  [emptyText]="'No properties found'"
                  [searchable]="true"
                  [disabled]="isLoadingProperties()"
                  (zValueChange)="onPropertyChange($event)"
                  class="w-full text-sm"
                />
              </div>
              
              <!-- Contact select -->
              <div class="w-full sm:w-[200px]">
                <z-combobox
                  #contactCombobox
                  [options]="contactOptions()"
                  [value]="selectedContactId()"
                  [placeholder]="'Select contact...'"
                  [searchPlaceholder]="'Search contacts...'"
                  [emptyText]="'No contacts found'"
                  [searchable]="true"
                  [disabled]="isLoadingContacts()"
                  (zValueChange)="onContactChange($event)"
                  class="w-full text-sm"
                />
              </div>
              
              <!-- Status filter -->
              <div class="w-full sm:w-[200px]">
                <z-select
                  [zValue]="selectedStatus() !== null ? selectedStatus()!.toString() : 'all'"
                  [zLabel]="selectedStatus() !== null ? getStatusLabel(selectedStatus()!) : 'All Statuses'"
                  [zPlaceholder]="'Select status...'"
                  [zSize]="'default'"
                  class="w-full"
                  (zSelectionChange)="onStatusFilterChange($event)"
                >
                  @if (selectedStatus() !== null) {
                    <z-icon 
                      slot="selected-icon" 
                      [zType]="getStatusIcon(selectedStatus()!)" 
                      zSize="sm" 
                      [class]="getStatusIconColorClass(selectedStatus()!)" 
                    />
                  }
                  <z-select-item [zValue]="'all'">
                    <span>All Statuses</span>
                  </z-select-item>
                  @for (option of statusOptions; track option.value) {
                    <z-select-item [zValue]="option.value.toString()">
                      <div class="flex items-center gap-2">
                        <z-icon [zType]="getStatusIcon(option.value)" zSize="sm" [class]="getStatusIconColorClass(option.value)" />
                        <span>{{ option.label }}</span>
                      </div>
                    </z-select-item>
                  }
                </z-select>
              </div>
              
              <!-- Revenue Types Multi-Select -->
              @if (selectedType() === TransactionType.Revenue) {
                <div class="w-full sm:w-[200px]">
                  <z-select
                    [zValue]="selectedRevenueTypes().length > 0 ? selectedRevenueTypes()[0].toString() : ''"
                    [zLabel]="selectedRevenueTypesDisplay() || 'Select revenue types...'"
                    [zPlaceholder]="'Select revenue types...'"
                    [zSize]="'default'"
                    class="w-full"
                    (zSelectionChange)="onRevenueSelectChange($event)"
                  >
                    @for (option of revenueTypeOptions; track option.value) {
                      <z-select-item [zValue]="option.value.toString()" [class]="'cursor-default'" (click)="$event.preventDefault(); $event.stopPropagation(); toggleRevenueType(option.value)">
                        <div class="flex items-center gap-2 w-full pointer-events-none">
                          <z-checkbox
                            [ngModel]="selectedRevenueTypes().includes(option.value)"
                            (checkChange)="toggleRevenueType(option.value)"
                            (click)="$event.preventDefault(); $event.stopPropagation()"
                            class="pointer-events-auto"
                          />
                          <span class="flex-1">{{ option.label }}</span>
                        </div>
                      </z-select-item>
                    }
                  </z-select>
                </div>
              }
              
              <!-- Expense Types Multi-Select -->
              @if (selectedType() === TransactionType.Expense) {
                <div class="w-full sm:w-[200px]">
                  <z-select
                    [zValue]="selectedExpenseTypes().length > 0 ? selectedExpenseTypes()[0].toString() : ''"
                    [zLabel]="selectedExpenseTypesDisplay() || 'Select expense types...'"
                    [zPlaceholder]="'Select expense types...'"
                    [zSize]="'default'"
                    class="w-full"
                    (zSelectionChange)="onExpenseSelectChange($event)"
                  >
                    @for (option of expenseTypeOptions; track option.value) {
                      <z-select-item [zValue]="option.value.toString()" [class]="'cursor-default'" (click)="$event.preventDefault(); $event.stopPropagation(); toggleExpenseType(option.value)">
                        <div class="flex items-center gap-2 w-full pointer-events-none">
                          <z-checkbox
                            [ngModel]="selectedExpenseTypes().includes(option.value)"
                            (checkChange)="toggleExpenseType(option.value)"
                            (click)="$event.preventDefault(); $event.stopPropagation()"
                            class="pointer-events-auto"
                          />
                          <span class="flex-1">{{ option.label }}</span>
                        </div>
                      </z-select-item>
                    }
                  </z-select>
                </div>
              }
            </div>
          </div>
          <!-- Action buttons on right -->
          <div class="flex gap-2 items-center">
            @if (hasActiveFilters()) {
              <z-button 
                zType="destructive" 
                zSize="sm" 
                (click)="onClearFilters()"
                class="bg-red-500 hover:bg-red-600 text-white border-red-500 hover:border-red-600 dark:bg-red-600 dark:hover:bg-red-700 dark:border-red-600 dark:hover:border-red-700"
              >
                <z-icon zType="x" zSize="sm" class="mr-2" />
                Clear Filters
              </z-button>
            }
            <z-button 
              zType="default" 
              zSize="icon" 
              class="w-12 h-12 rounded-full bg-green-100 hover:bg-green-200 text-green-600 border-green-200 hover:border-green-300 dark:bg-green-900/30 dark:hover:bg-green-900/50 dark:text-green-400 dark:border-green-800/50 dark:hover:border-green-800/70 shadow-sm" 
              routerLink="/transaction/add/revenue"
              [title]="'Add Revenue'"
            >
              <z-icon zType="plus" zSize="xl" class="!size-6" />
            </z-button>
            <z-button 
              zType="destructive" 
              zSize="icon" 
              class="w-12 h-12 rounded-full bg-red-100 hover:bg-red-200 text-red-600 border-red-200 hover:border-red-300 dark:bg-red-900/30 dark:hover:bg-red-900/50 dark:text-red-400 dark:border-red-800/50 dark:hover:border-red-800/70 shadow-sm" 
              routerLink="/transaction/add/expense"
              [title]="'Add Expense'"
            >
              <z-icon zType="minus" zSize="xl" class="!size-6" />
            </z-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Datatable -->
    <div class="flex-1 min-h-0 overflow-y-auto pb-4 -mx-6 px-6">
      <z-datatable
        [zData]="filteredTransactions()"
        [zColumns]="columns()"
        [zViewMode]="'list'"
        [zSelectable]="false"
        [zEmptyMessage]="emptyMessage()"
        [zRowClass]="getRowClass"
      >
        <!-- Date Column Template -->
        <ng-template #dateCell let-row="row">
          <span>{{ formatDate(row.date) }}</span>
        </ng-template>

        <!-- Property Column Template -->
        <ng-template #propertyCell let-row="row">
          @if (row.propertyId) {
            <div class="flex flex-col gap-1">
              @if (row.propertyIdentifier) {
                <span class="font-semibold">{{ row.propertyIdentifier }}</span>
              } @else if (row.propertyName) {
                <span class="font-semibold">{{ row.propertyName }}</span>
              }
              @if (row.propertyAddress) {
                <span class="text-sm text-muted-foreground">{{ row.propertyAddress }}</span>
              }
              @if (row.ownerName) {
                <span class="text-sm text-muted-foreground">{{ row.ownerName }}</span>
              }
            </div>
          }
        </ng-template>

        <!-- Contact Column Template -->
        <ng-template #contactCell let-row="row">
          @if ((row.type === TransactionType.Revenue && row.revenueType === RevenueType.Autre) || 
               (row.type === TransactionType.Expense && row.expenseType === ExpenseType.Autre)) {
            <span>{{ row.otherContactName || 'N/A' }}</span>
          } @else if (row.contactName || row.contactIdentifier) {
            <div class="flex flex-col gap-1">
              @if (row.contactName && row.contactIdentifier) {
                <span class="font-semibold">{{ row.contactName }} ({{ row.contactIdentifier }})</span>
              } @else if (row.contactName) {
                <span class="font-semibold">{{ row.contactName }}</span>
              } @else if (row.contactIdentifier) {
                <span class="font-semibold">{{ row.contactIdentifier }}</span>
              }
            </div>
          } @else {
            <span>{{ row.otherContactName || 'N/A' }}</span>
          }
        </ng-template>

        <!-- Type of Transaction Column Template -->
        <ng-template #transactionTypeCell let-row="row">
          @if (getTransactionTypeLabel(row)) {
            <z-badge [zType]="'default'">
              {{ getTransactionTypeLabel(row) }}
            </z-badge>
          } @else {
            <span class="text-muted-foreground text-sm">-</span>
          }
        </ng-template>

        <!-- Amount Column Template -->
        <ng-template #amountCell let-row="row">
          <span class="font-semibold">{{ formatCurrency(row.totalAmount) }}</span>
        </ng-template>

        <!-- Status Column Template -->
        <ng-template #statusCell let-row="row">
          <z-select
            [zValue]="row.status.toString()"
            [zLabel]="getStatusLabel(row.status)"
            [zDisabled]="isUpdatingStatus(row.id)"
            [zSize]="'sm'"
            class="w-auto min-w-[100px] max-w-[120px]"
            (zSelectionChange)="onStatusDropdownChange(row, $event)"
          >
            <z-icon slot="selected-icon" [zType]="getStatusIcon(row.status)" zSize="sm" [class]="getStatusIconColorClass(row.status)" />
            <z-select-item [zValue]="TransactionStatus.Pending.toString()">
              <div class="flex items-center gap-2">
                <z-icon zType="clock" zSize="sm" class="text-yellow-600 dark:text-yellow-500" />
                <span>Pending</span>
              </div>
            </z-select-item>
            <z-select-item [zValue]="TransactionStatus.Overdue.toString()">
              <div class="flex items-center gap-2">
                <z-icon zType="triangle-alert" zSize="sm" class="text-red-600 dark:text-red-500" />
                <span>Overdue</span>
              </div>
            </z-select-item>
            <z-select-item [zValue]="TransactionStatus.Paid.toString()">
              <div class="flex items-center gap-2">
                <z-icon zType="circle-check" zSize="sm" class="text-green-600 dark:text-green-500" />
                <span>Paid</span>
              </div>
            </z-select-item>
          </z-select>
        </ng-template>

        <!-- Actions Column Template -->
        <ng-template #actionsCell let-row="row">
          <z-dropdown-menu>
            <z-button zType="ghost" zSize="icon" class="h-8 w-8" dropdown-trigger>
              <z-icon zType="ellipsis" zSize="sm" />
            </z-button>
            <z-dropdown-menu-item (click)="onView(row)">
              <z-icon zType="eye" zSize="sm" class="mr-2" />
              <span>View</span>
            </z-dropdown-menu-item>
            <z-dropdown-menu-item (click)="onEdit(row)">
              <z-icon zType="pencil" zSize="sm" class="mr-2" />
              <span>Edit</span>
            </z-dropdown-menu-item>
            @if (row.status === TransactionStatus.Paid) {
              <z-dropdown-menu-item (click)="onGenerateRentReceipt(row)">
                <z-icon zType="file-text" zSize="sm" class="mr-2" />
                <span>Rent Receipt</span>
              </z-dropdown-menu-item>
            }
            <z-divider class="my-1" />
            <z-dropdown-menu-item (click)="onDelete(row)" class="text-destructive focus:text-destructive">
              <z-icon zType="x" zSize="sm" class="mr-2" />
              <span>Delete</span>
            </z-dropdown-menu-item>
          </z-dropdown-menu>
        </ng-template>
      </z-datatable>
    </div>

    <!-- Pagination Footer -->
    <z-datatable-pagination
      [zCurrentPage]="currentPage()"
      [zTotalPages]="totalPages()"
      [zPageSize]="pageSize()"
      [zPageSizeOptions]="pageSizeOptions()"
      [zShow]="hasData()"
      (zPageChange)="onPageChange($event)"
      (zPageSizeChange)="onPageSizeChange($event)"
    />
  </div>
</z-page>
