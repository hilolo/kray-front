<div [class]="classes()">
  <!-- Navigation Header -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-4">
      <button
        z-button
        zType="ghost"
        zSize="icon"
        (click)="previousMonth()"
        aria-label="Previous month"
        class="h-8 w-8"
      >
        <z-icon zType="chevron-left" zSize="sm" />
      </button>

      <div class="flex items-center gap-2">
        <!-- Month Select -->
        <z-select
          [zSize]="'default'"
          class="min-w-[120px]"
          [zValue]="currentMonth().toString()"
          [zLabel]="currentMonthName()"
          (zSelectionChange)="onMonthChange($event)"
        >
          @for (month of months; track $index) {
            <z-select-item [zValue]="$index.toString()">{{ month }}</z-select-item>
          }
        </z-select>

        <!-- Year Select -->
        <z-select
          [zSize]="'default'"
          class="min-w-[100px]"
          [zValue]="currentYear().toString()"
          [zLabel]="currentYear().toString()"
          (zSelectionChange)="onYearChange($event)"
        >
          @for (year of availableYears(); track year) {
            <z-select-item [zValue]="year.toString()">{{ year }}</z-select-item>
          }
        </z-select>
      </div>

      <button
        z-button
        zType="ghost"
        zSize="icon"
        (click)="nextMonth()"
        aria-label="Next month"
        class="h-8 w-8"
      >
        <z-icon zType="chevron-right" zSize="sm" />
      </button>
    </div>

    <div class="flex items-center gap-2">
      <button
        z-button
        zType="outline"
        zSize="default"
        (click)="goToToday()"
        class="gap-2"
      >
        Today
      </button>
      <button
        z-button
        zType="outline"
        zSize="default"
        (click)="printCalendar()"
        class="gap-2"
      >
        <z-icon zType="printer" zSize="sm" />
        Print
      </button>
    </div>
  </div>

  <!-- Month View -->
  <div class="flex flex-col gap-2">
    <!-- Month Header -->
    <div class="text-center font-semibold text-lg mb-2">
      {{ currentMonthName() }} {{ currentYear() }}
    </div>

    <!-- Weekdays Header -->
    <div class="grid grid-cols-7 gap-0 text-center text-sm text-muted-foreground mb-1">
      @for (weekday of weekdays; track $index) {
        <div class="p-2 font-medium">{{ weekday }}</div>
      }
    </div>

    <!-- Calendar Days Grid -->
    <div class="relative">
      <div class="grid grid-cols-7 gap-0">
        @for (day of monthDays(); track day.date.getTime(); let dayIndex = $index) {
          <div
            class="relative min-h-[60px] border border-border/50 p-1.5 cursor-pointer hover:bg-accent/50 transition-colors flex flex-col"
            [class.bg-muted/30]="!day.isCurrentMonth"
            [class.opacity-50]="!day.isCurrentMonth"
            [class.bg-accent]="selectedDate() && isSameDay(day.date, selectedDate()!)"
            (click)="selectDate(day.date)"
          >
            <!-- Date Number -->
            <div
              class="text-sm font-medium mb-1 flex-shrink-0 z-20 relative"
              [class.text-foreground]="day.isCurrentMonth"
              [class.text-muted-foreground]="!day.isCurrentMonth"
              [class.font-bold]="day.isToday"
              [class.bg-primary/20]="day.isToday"
              [class.text-primary]="day.isToday"
              [class.rounded]="day.isToday"
              [class.px-1.5]="day.isToday"
              [class.py-0.5]="day.isToday"
              [class.inline-block]="day.isToday"
              [class.self-start]="day.isToday"
            >
              {{ day.date.getDate() }}
            </div>
            <!-- Space for reservation bars -->
            <div class="flex-1 min-h-[20px]"></div>
          </div>
        }
      </div>

      <!-- Spanning Bars Overlay - positioned absolutely over the grid -->
      <div class="absolute inset-0 pointer-events-none">
        @for (bar of spanningBars(); track bar.reservation.id + '-' + bar.weekIndex) {
          @let columnWidth = 100 / 7;
          @let startOffset = bar.isStartOfReservation ? columnWidth * 0.5 : 0;
          @let endOffset = bar.isEndOfReservation ? columnWidth * 0.5 : 0;
          @let leftPercent = (bar.startColumn * columnWidth) + startOffset;
          @let rightPercent = ((6 - bar.endColumn) * columnWidth) + endOffset;
          @let widthPercent = 100 - leftPercent - rightPercent;
          <div
            class="absolute h-5 bg-purple-500 text-white cursor-pointer hover:opacity-90 transition-opacity pointer-events-auto z-10 flex items-center px-1.5"
            [style.left.%]="leftPercent"
            [style.width.%]="widthPercent"
            [style.top.px]="(bar.weekIndex * 60) + 28"
            [title]="(bar.reservation.propertyIdentifier || '') + (bar.reservation.propertyIdentifier && bar.reservation.contactName ? ' - ' : '') + (bar.reservation.contactName || '')"
            (click)="onReservationClick(bar.reservation.id, $event)"
          >
            @if (bar.isStartOfReservation) {
              <div class="w-1.5 h-1.5 rounded-full bg-white flex-shrink-0"></div>
              <span class="truncate text-xs font-medium ml-1.5 text-white">
                @if (bar.reservation.propertyIdentifier || bar.reservation.contactName) {
                  {{ bar.reservation.propertyIdentifier || '' }}{{ bar.reservation.propertyIdentifier && bar.reservation.contactName ? ' - ' : '' }}{{ bar.reservation.contactName || '' }}
                }
              </span>
            }
          </div>
        }
      </div>
    </div>
  </div>
</div>

