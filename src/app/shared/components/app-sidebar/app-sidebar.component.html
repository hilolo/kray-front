<!-- Desktop Sidebar (Hidden on Mobile) -->
<z-sidebar 
  [zWidth]="zSidebarWidth()" 
  [zCollapsible]="true"
  [zCollapsed]="sidebarCollapsed()"
  [zCollapsedWidth]="64"
  (zCollapsedChange)="sidebarCollapsed.set($event)"
  class="hidden md:flex h-full"
>
  <div class="flex flex-col h-full p-2">
    <!-- Logo Section -->
    <a 
      routerLink="/" 
      class="flex items-center gap-3 px-2 py-4 mb-2 flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity" 
      [class.justify-center]="sidebarCollapsed()" 
      [class.justify-start]="!sidebarCollapsed()"
      (click)="onMenuItemClick($event)"
    >
      @if (!logoError()) {
        <img 
          [src]="currentTheme() === 'dark' ? '/assets/logo-white.svg' : '/assets/logo.svg'" 
          alt="Logo" 
          [class]="sidebarCollapsed() ? 'h-8 w-8' : 'h-8 w-auto'"
          (error)="logoError.set(true)"
        />
      } @else {
        <span [class]="sidebarCollapsed() ? 'text-sm font-semibold' : 'text-lg font-semibold'">Logo</span>
      }
      @if (!sidebarCollapsed()) {
        <span class="text-sidebar-foreground/60 text-lg font-medium">Kray</span>
      }
    </a>
    
    <z-sidebar-group class="flex-1 min-h-0 overflow-y-auto">
      <nav class="flex flex-col gap-4 px-2 py-2">
        @for (group of zSidebarItems(); track group.groupKey || group.group) {
          <div class="flex flex-col gap-1">
            @if (!sidebarCollapsed() && (group.group || group.groupKey)) {
              <div class="flex items-center justify-between px-3 py-1.5 group-header">
                <div class="text-xs font-semibold text-sidebar-foreground/60 uppercase tracking-wider">
                  {{ group.groupKey ? (group.groupKey | translate) : group.group }}
                </div>
                @if (group.groupKey === 'sidebar.essential' || group.groupKey === 'sidebar.more') {
                  <button
                    type="button"
                    (click)="group.groupKey === 'sidebar.essential' ? toggleEssentialGroup() : toggleMoreGroup(); $event.stopPropagation()"
                    class="p-1 rounded hover:bg-sidebar-accent/50 transition-colors"
                    [attr.aria-label]="isGroupCollapsed(group.groupKey) ? 'Expand group' : 'Collapse group'"
                  >
                    <z-icon 
                      zType="chevron-down" 
                      zSize="sm" 
                      class="text-sidebar-foreground/60 transition-transform"
                      [class.rotate-180]="!isGroupCollapsed(group.groupKey)"
                    />
                  </button>
                }
              </div>
            }
            @if (sidebarCollapsed() || !group.groupKey || !isGroupCollapsed(group.groupKey)) {
              <div class="flex flex-col gap-0.5">
                @for (item of group.items; track item.route) {
                @if (sidebarCollapsed()) {
                  <a
                    [routerLink]="item.route"
                    routerLinkActive="bg-sidebar-accent text-sidebar-accent-foreground font-medium"
                    [routerLinkActiveOptions]="getRouterLinkActiveOptions(item.route)"
                    [zTooltip]="getItemLabel(item)"
                    zPosition="right"
                    zTrigger="hover"
                    class="flex items-center justify-center px-2 py-2 rounded-md transition-colors group text-sidebar-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground"
                    (click)="onMenuItemClick($event)"
                  >
                    @if (item.icon) {
                      <z-icon [zType]="item.icon" class="shrink-0 w-4 h-4" />
                    }
                  </a>
                } @else {
                  <a
                    [routerLink]="item.route"
                    routerLinkActive="bg-sidebar-accent text-sidebar-accent-foreground font-medium"
                    [routerLinkActiveOptions]="getRouterLinkActiveOptions(item.route)"
                    class="flex items-center gap-2.5 px-3 py-2 rounded-md transition-all group relative text-sidebar-foreground hover:bg-sidebar-accent/50 hover:text-sidebar-accent-foreground hover:scale-[1.02] hover:pl-4 before:absolute before:left-0 before:top-0 before:bottom-0 before:w-1 before:bg-sidebar-accent-foreground before:rounded-r-full before:opacity-0 before:transition-opacity hover:before:opacity-100"
                    (click)="onMenuItemClick($event)"
                  >
                    @if (item.icon) {
                      <z-icon [zType]="item.icon" class="shrink-0 w-4 h-4" />
                    }
                    <span class="text-sm text-sidebar-foreground">{{ item.labelKey ? (item.labelKey | translate) : item.label }}</span>
                  </a>
                }
              }
              </div>
            }
          </div>
        }
      </nav>
    </z-sidebar-group>

    <!-- User Profile Section at Bottom - Always visible -->
    <div class="mt-auto pt-2 border-t border-sidebar-border flex-shrink-0 w-full">
      <z-dropdown-menu>
        <button
          dropdown-trigger
          type="button"
          class="flex gap-2.5 hover:bg-sidebar-accent hover:text-sidebar-accent-foreground items-center py-2 pl-2 pr-0 rounded-md transition-colors w-full group relative"
        >
          @if (!sidebarCollapsed()) {
            <z-avatar 
              zSize="sm" 
              zType="default" 
              [zImage]="userAvatar() ? { url: userAvatar()!, fallback: userName().charAt(0).toUpperCase() } : { fallback: userName().charAt(0).toUpperCase() }"
            />
            <div class="flex-1 min-w-0 text-left">
              <div class="text-sm font-medium break-words">{{ userName() }}</div>
              <div class="text-xs text-sidebar-foreground/60 break-words leading-tight">{{ userEmail() }}</div>
            </div>
          }
        </button>

        <div class="px-2 py-1.5 mb-1">
          <div class="flex items-center gap-3">
            <z-avatar 
              zSize="default" 
              zType="default" 
              [zImage]="userAvatar() ? { url: userAvatar()!, fallback: userName().charAt(0).toUpperCase() } : { fallback: userName().charAt(0).toUpperCase() }"
            />
            <div class="flex-1 min-w-0">
              <div class="text-xs font-medium break-words">{{ userName() }}</div>
              <div class="text-[10px] text-muted-foreground break-words leading-tight">{{ userEmail() }}</div>
            </div>
          </div>
        </div>
        <z-dropdown-menu-item (click)="onSettingsClick()">
          <z-icon zType="settings" zSize="sm" class="mr-2" />
          <span>Settings</span>
        </z-dropdown-menu-item>
        <z-divider class="my-1" />
        <z-dropdown-menu-item (click)="onLogoutClick()" class="text-destructive focus:text-destructive">
          <z-icon zType="log-out" zSize="sm" class="mr-2" />
          <span>Log out</span>
        </z-dropdown-menu-item>
      </z-dropdown-menu>
    </div>
  </div>
</z-sidebar>

<!-- Mobile Sidebar Template (for Sheet) -->
<ng-template #mobileSidebarTemplate>
  <div class="flex flex-col h-full">
    <!-- Logo Section (Mobile) -->
    <a 
      routerLink="/" 
      class="flex items-center gap-3 px-2 py-4 mb-2 flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity"
      (click)="closeMobileSidebar()"
    >
      @if (!logoError()) {
        <img 
          [src]="currentTheme() === 'dark' ? '/assets/logo-white.svg' : '/assets/logo.svg'" 
          alt="Logo" 
          class="h-8 w-auto"
          (error)="logoError.set(true)"
        />
      } @else {
        <span class="text-lg font-semibold">Logo</span>
      }
      <span class="text-sidebar-foreground/60 text-lg font-medium">Kray</span>
    </a>
    
    <z-sidebar-group class="flex-1 overflow-y-auto">
      <nav class="flex flex-col gap-4 p-3">
        @for (group of zSidebarItems(); track group.groupKey || group.group) {
          <div class="flex flex-col gap-1">
            @if (group.group || group.groupKey) {
              <div class="flex items-center justify-between px-3 py-1.5 group-header">
                <div class="text-xs font-semibold text-sidebar-foreground/60 uppercase tracking-wider">
                  {{ group.groupKey ? (group.groupKey | translate) : group.group }}
                </div>
                @if (group.groupKey === 'sidebar.essential' || group.groupKey === 'sidebar.more') {
                  <button
                    type="button"
                    (click)="group.groupKey === 'sidebar.essential' ? toggleEssentialGroup() : toggleMoreGroup(); $event.stopPropagation()"
                    class="p-1 rounded hover:bg-sidebar-accent/50 transition-colors"
                    [attr.aria-label]="isGroupCollapsed(group.groupKey) ? 'Expand group' : 'Collapse group'"
                  >
                    <z-icon 
                      zType="chevron-down" 
                      zSize="sm" 
                      class="text-sidebar-foreground/60 transition-transform"
                      [class.rotate-180]="!isGroupCollapsed(group.groupKey)"
                    />
                  </button>
                }
              </div>
            }
            @if (!group.groupKey || !isGroupCollapsed(group.groupKey)) {
              <div class="flex flex-col gap-0.5">
                @for (item of group.items; track item.route) {
                <a
                  [routerLink]="item.route"
                  routerLinkActive="bg-sidebar-accent text-sidebar-accent-foreground font-medium"
                  [routerLinkActiveOptions]="getRouterLinkActiveOptions(item.route)"
                  [class]="item.isActive ? 'flex items-center gap-2.5 px-3 py-2 rounded-md text-green-600 dark:text-green-500 bg-green-50 dark:bg-green-950/20 hover:bg-green-100 dark:hover:bg-green-950/30 transition-colors font-medium' : 'flex items-center gap-2.5 px-3 py-2 rounded-md text-sidebar-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground transition-colors'"
                  (click)="closeMobileSidebar()"
                >
                  @if (item.icon) {
                    <z-icon 
                      [zType]="item.icon" 
                      [class]="item.isActive ? 'shrink-0 w-4 h-4 text-green-600 dark:text-green-500' : 'shrink-0 w-4 h-4'"
                    />
                  }
                  <span [class]="item.isActive ? 'text-sm text-green-600 dark:text-green-500 font-medium' : 'text-sm text-sidebar-foreground'">{{ item.labelKey ? (item.labelKey | translate) : item.label }}</span>
                </a>
              }
              </div>
            }
          </div>
        }
      </nav>
    </z-sidebar-group>

    <!-- User Profile Section at Bottom (Mobile) -->
    <div class="mt-auto pt-2 border-t border-sidebar-border px-3 pb-3">
      <z-dropdown-menu>
        <button
          dropdown-trigger
          type="button"
          class="w-full flex items-center gap-2.5 p-2 rounded-md hover:bg-sidebar-accent hover:text-sidebar-accent-foreground transition-colors group"
        >
          <z-avatar 
            zSize="sm" 
            zType="default" 
            [zImage]="userAvatar() ? { url: userAvatar()!, fallback: userName().charAt(0).toUpperCase() } : { fallback: userName().charAt(0).toUpperCase() }"
          />
          <div class="flex-1 min-w-0 text-left">
            <div class="text-sm font-medium break-words">{{ userName() }}</div>
            <div class="text-xs text-sidebar-foreground/60 break-words leading-tight">{{ userEmail() }}</div>
          </div>
          <z-icon zType="ellipsis" zSize="sm" class="text-sidebar-foreground/40 group-hover:text-sidebar-accent-foreground flex-shrink-0 transition-colors" />
        </button>

        <div class="px-2 py-1.5 mb-1">
          <div class="flex items-center gap-3">
            <z-avatar 
              zSize="default" 
              zType="default" 
              [zImage]="userAvatar() ? { url: userAvatar()!, fallback: userName().charAt(0).toUpperCase() } : { fallback: userName().charAt(0).toUpperCase() }"
            />
            <div class="flex-1 min-w-0">
              <div class="text-xs font-medium break-words">{{ userName() }}</div>
              <div class="text-[10px] text-muted-foreground break-words leading-tight">{{ userEmail() }}</div>
            </div>
          </div>
        </div>
        <z-dropdown-menu-item (click)="onSettingsClick()">
          <z-icon zType="settings" zSize="sm" class="mr-2" />
          <span>Settings</span>
        </z-dropdown-menu-item>
        <z-divider class="my-1" />
        <z-dropdown-menu-item (click)="onLogoutClick()" class="text-destructive focus:text-destructive">
          <z-icon zType="log-out" zSize="sm" class="mr-2" />
          <span>Log out</span>
        </z-dropdown-menu-item>
      </z-dropdown-menu>
    </div>
  </div>
</ng-template>

