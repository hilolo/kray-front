<z-page [zTitle]="isNew() ? 'Create Document' : 'Edit Document'">
  <div class="flex flex-col min-h-0 h-full overflow-hidden">
    <!-- Header Section -->
    <div class="space-y-4 pb-6 flex-shrink-0">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-3xl font-bold mb-2">
            @if (isNew()) {
              Add New Document
            } @else {
              Edit Document
            }
          </h2>
          <p class="text-muted-foreground">
            @if (isNew()) {
              Create a new document by filling in the information below
            } @else {
              Update the document information below
            }
          </p>
        </div>
        <div class="flex gap-2">
          <z-button zType="outline" zSize="default" [disabled]="isSaving()" (click)="!isSaving() && onCancel()">
            Cancel
          </z-button>
          <z-button [zType]="isSaving() || !isFormValid() ? 'ghost' : 'default'" [disabled]="isSaving()" (click)="!isSaving() && onSave()">
            @if (isSaving()) {
              <span class="flex items-center gap-2">
                <z-icon zType="loader-circle" zSize="sm" class="animate-spin" />
                Saving...
              </span>
            } @else {
              <z-icon zType="check" zSize="sm" class="mr-2" />
              @if (isNew()) {
                Create Document
              } @else {
                Update Document
              }
            }
          </z-button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 min-h-0 overflow-y-auto">
      @if (isLoading()) {
        <div class="flex items-center justify-center h-full">
          <div class="flex flex-col items-center gap-2">
            <z-icon zType="loader-circle" zSize="lg" class="animate-spin text-primary" />
            <p class="text-muted-foreground">Loading document data...</p>
          </div>
        </div>
      } @else {
        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Left Half - Text Editor -->
          <div class="flex flex-col min-h-0">
            <div class="mb-2 flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium">Document Content</h3>
                <p class="text-xs text-muted-foreground">Edit your document content</p>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-xs text-muted-foreground">Text Size:</span>
                <z-segmented
                  [zOptions]="[
                    { value: 'normal', label: 'Normal' },
                    { value: 'large', label: 'Large' },
                    { value: 'extralarge', label: 'Extra Large' }
                  ]"
                  [zDefaultValue]="textSize()"
                  (zChange)="onTextSizeChange($event)"
                  zSize="sm"
                />
              </div>
            </div>
            <div class="flex-1 min-h-0" [style.font-size]="(textSizeMultiplier() * 100) + '%'">
              <z-text-editor
                #textEditor
                [value]="editorContent()"
                [zSize]="'lg'"
                placeholder="Start typing your document content here..."
                (valueChange)="onEditorChange($event)"
                (htmlChange)="onEditorChange($event)"
                class="h-full"
              />
            </div>
          </div>

          <!-- Right Half - PDF Preview -->
          <div class="flex flex-col min-h-0">
            <div class="mb-2 flex items-center justify-between">
              <div>
                <h3 class="text-sm font-medium">Document Details</h3>
                <p class="text-xs text-muted-foreground">PDF Preview</p>
              </div>
              <div class="flex items-center gap-2">
                <z-button 
                  zType="ghost" 
                  zSize="sm" 
                  [disabled]="!pdfDataUrl()" 
                  (click)="openPdfViewer()"
                  class="flex items-center gap-1"
                >
                  <z-icon zType="eye" zSize="sm" />
                  View
                </z-button>
              </div>
            </div>
            <div class="flex-1 min-h-0 border rounded-lg bg-muted/50 overflow-hidden">
              @if (isGeneratingPdf()) {
                <div class="flex items-center justify-center h-full">
                  <div class="flex flex-col items-center gap-2">
                    <z-icon zType="loader-circle" zSize="lg" class="animate-spin text-primary" />
                    <p class="text-sm text-muted-foreground">Generating PDF...</p>
                  </div>
                </div>
              } @else if (pdfDataUrl()) {
                <!-- PDF Preview with iframe (avoids Vite dynamic import warnings) -->
                <div class="h-full w-full overflow-auto bg-white">
                  <iframe
                    [src]="pdfDataUrlWithZoom() | safe: 'resourceUrl'"
                    class="w-full h-full border-0"
                    style="min-height: 600px; width: 100%; height: 100%;"
                    type="application/pdf"
                    allow="fullscreen"
                  ></iframe>
                </div>
              } @else {
                <div class="flex items-center justify-center h-full min-h-[200px]">
                  <div class="text-center text-muted-foreground">
                    <z-icon zType="file-text" zSize="lg" class="mx-auto mb-2 opacity-50" />
                    <p>PDF preview will appear here</p>
                    <p class="text-xs mt-2">Start typing in the editor to generate preview</p>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Debug Section -->
        <div class="mt-6 border-t pt-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Debug Information</h3>
            <z-button zType="ghost" zSize="sm" (click)="toggleDebug()">
              @if (showDebug()) {
                <z-icon zType="chevron-up" zSize="sm" class="mr-1" />
                Hide
              } @else {
                <z-icon zType="chevron-down" zSize="sm" class="mr-1" />
                Show
              }
            </z-button>
          </div>

          @if (showDebug()) {
            <div class="space-y-4">
              <!-- HTML and PDFMake JSON Input Section -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- HTML Input -->
                <z-form-field>
                  <z-form-label>Insert HTML into Editor</z-form-label>
                  <z-form-control>
                    <div class="space-y-2">
                      <textarea
                        z-input
                        [ngModel]="htmlInput()"
                        (ngModelChange)="htmlInput.set($event)"
                        name="htmlInput"
                        placeholder="Paste HTML content here..."
                        rows="6"
                        class="w-full resize-none font-mono text-xs"
                      ></textarea>
                      <z-button 
                        zType="default" 
                        zSize="sm" 
                        [disabled]="!htmlInput().trim()" 
                        (click)="insertHtmlIntoEditor()"
                        class="w-full"
                      >
                        <z-icon zType="code" zSize="sm" class="mr-2" />
                        Insert HTML into Editor
                      </z-button>
                    </div>
                  </z-form-control>
                </z-form-field>

                <!-- PDFMake JSON Input -->
                <z-form-field>
                  <z-form-label>Generate PDF from PDFMake JSON</z-form-label>
                  <z-form-control>
                    <div class="space-y-2">
                      <textarea
                        z-input
                        [ngModel]="pdfMakeJsonInput()"
                        (ngModelChange)="pdfMakeJsonInput.set($event)"
                        name="pdfMakeJsonInput"
                        placeholder="Paste PDFMake JSON here..."
                        rows="6"
                        class="w-full resize-none font-mono text-xs"
                      ></textarea>
                      <z-button 
                        zType="default" 
                        zSize="sm" 
                        [disabled]="!pdfMakeJsonInput().trim() || isGeneratingPdf()" 
                        (click)="generatePdfFromJson()"
                        class="w-full"
                      >
                        @if (isGeneratingPdf()) {
                          <z-icon zType="loader-circle" zSize="sm" class="mr-2 animate-spin" />
                          Generating...
                        } @else {
                          <z-icon zType="file-text" zSize="sm" class="mr-2" />
                          Generate PDF from JSON
                        }
                      </z-button>
                    </div>
                  </z-form-control>
                </z-form-field>
              </div>

              <!-- HTML Content -->
              <div>
                <h4 class="text-sm font-medium mb-2 flex items-center gap-2">
                  <z-icon zType="code" zSize="sm" />
                  HTML Content (Final - after removing line-height)
                </h4>
                <div class="border rounded-lg bg-muted/30 p-4 overflow-auto max-h-[300px]">
                  <pre class="text-xs font-mono whitespace-pre-wrap break-words">{{ cleanedHtml() || editorContent() || '(empty)' }}</pre>
                </div>
              </div>

              <!-- PDFMake JSON -->
              <div>
                <h4 class="text-sm font-medium mb-2 flex items-center gap-2">
                  <z-icon zType="code" zSize="sm" />
                  PDFMake JSON
                </h4>
                <div class="border rounded-lg bg-muted/30 p-4 overflow-auto max-h-[300px]">
                  <pre class="text-xs font-mono whitespace-pre-wrap break-words">{{ pdfMakeJson() || '(empty)' }}</pre>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- PDF Viewer Modal -->
  <z-pdf-viewer
    [isOpen]="showPdfViewer()"
    [pdfUrl]="pdfDataUrl()"
    [pdfName]="isNew() ? 'New Document' : 'Document'"
    (close)="closePdfViewer()"
  />
</z-page>

