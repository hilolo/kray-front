<div class="flex flex-col h-full max-h-[90vh] min-h-0 overflow-hidden">
  <!-- Content -->
  <div class="flex-1 min-h-0 overflow-y-auto px-6 py-4" (click)="$event.stopPropagation()">
    <div class="max-w-2xl mx-auto space-y-4">
      <!-- Property -->
      <z-form-field>
        <z-form-label zRequired>Property</z-form-label>
        <z-form-control [errorMessage]="propertyIdError()">
          <z-combobox
            [options]="propertyOptions()"
            [value]="formData().propertyId || null"
            [placeholder]="'Select property...'"
            [searchPlaceholder]="'Search properties...'"
            [emptyText]="'No properties found'"
            [searchable]="true"
            [disabled]="isLoadingProperties()"
            (zValueChange)="updateField('propertyId', $event || '')"
            [zWidth]="'full'"
            class="w-full"
          />
        </z-form-control>
      </z-form-field>

      <!-- Service -->
      <z-form-field>
        <z-form-label zRequired>Service</z-form-label>
        <z-form-control [errorMessage]="contactIdError()">
          <z-combobox
            [options]="contactOptions()"
            [value]="formData().contactId || null"
            [placeholder]="'Select service...'"
            [searchPlaceholder]="'Search services...'"
            [emptyText]="'No services found'"
            [searchable]="true"
            [disabled]="isLoadingContacts()"
            (zValueChange)="updateField('contactId', $event || '')"
            [zWidth]="'full'"
            class="w-full"
          />
        </z-form-control>
      </z-form-field>

      <!-- Priority and Status -->
      <div class="grid grid-cols-2 gap-4">
        <!-- Priority -->
        <z-form-field>
          <z-form-label zRequired>Priority</z-form-label>
          <z-form-control>
            <z-select
              [zValue]="getPriorityString(formData().priority)"
              (zValueChange)="onPriorityChange($event)"
            >
              <z-icon slot="selected-icon" [zType]="getSelectedPriorityIcon()" zSize="sm" />
              @for (option of priorityOptions; track option.value) {
                <z-select-item [zValue]="option.value">
                  <div class="flex items-center gap-2">
                    <z-icon [zType]="option.icon" zSize="sm" />
                    <span>{{ option.label }}</span>
                  </div>
                </z-select-item>
              }
            </z-select>
          </z-form-control>
        </z-form-field>

        <!-- Status -->
        <z-form-field>
          <z-form-label zRequired>Status</z-form-label>
          <z-form-control>
            <z-select
              [zValue]="getStatusString(formData().status)"
              (zValueChange)="onStatusChange($event)"
            >
              <z-icon slot="selected-icon" [zType]="getSelectedStatusIcon()" zSize="sm" />
              @for (option of statusOptions; track option.value) {
                <z-select-item [zValue]="option.value">
                  <div class="flex items-center gap-2">
                    <z-icon [zType]="option.icon" zSize="sm" />
                    <span>{{ option.label }}</span>
                  </div>
                </z-select-item>
              }
            </z-select>
          </z-form-control>
        </z-form-field>
      </div>

      <!-- Subject -->
      <z-form-field>
        <z-form-label zRequired>Subject</z-form-label>
        <z-form-control [errorMessage]="subjectError()">
          <z-input-group>
            <input
              z-input
              type="text"
              [ngModel]="formData().subject"
              (ngModelChange)="updateField('subject', $event)"
              name="subject"
              placeholder="Enter subject"
              [zStatus]="subjectError() ? 'error' : undefined"
              class="w-full"
            />
          </z-input-group>
        </z-form-control>
      </z-form-field>

      <!-- Description -->
      <z-form-field>
        <z-form-label zRequired>Description</z-form-label>
        <z-form-control [errorMessage]="descriptionError()">
          <textarea
            z-input
            [ngModel]="formData().description"
            (ngModelChange)="updateField('description', $event)"
            name="description"
            placeholder="Enter description"
            rows="4"
            [zStatus]="descriptionError() ? 'error' : undefined"
            class="w-full resize-none"
          ></textarea>
        </z-form-control>
      </z-form-field>

      <!-- Scheduled Date/Time -->
      <div class="grid grid-cols-2 gap-4">
        <!-- Date -->
        <z-form-field>
          <z-form-label zRequired>Scheduled Date</z-form-label>
          <z-form-control [errorMessage]="scheduledDateError()">
            <z-date-picker
              [value]="formData().scheduledDate"
              (dateChange)="updateField('scheduledDate', $event)"
              zFormat="MMM d, yyyy"
              placeholder="Pick a date"
            />
          </z-form-control>
        </z-form-field>

        <!-- Time -->
        <z-form-field>
          <z-form-label zRequired>Scheduled Time</z-form-label>
          <z-form-control [errorMessage]="scheduledTimeError()">
            <z-time-picker
              [value]="formData().scheduledTime"
              (timeChange)="updateField('scheduledTime', $event)"
              zFormat="HH:mm"
              placeholder="Pick a time"
            />
          </z-form-control>
        </z-form-field>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="flex-shrink-0 px-6 py-4 border-t bg-background flex justify-end gap-2">
    <z-button
      zType="outline"
      zSize="default"
      (click)="onCancel()"
      [disabled]="isSaving()"
    >
      Cancel
    </z-button>
    <z-button
      [zType]="isSaving() || !isFormValid() ? 'ghost' : 'default'"
      zSize="default"
      [disabled]="isSaving()"
      (click)="!isSaving() && onSubmit()"
    >
      @if (isSaving()) {
        <span class="flex items-center gap-2">
          <z-icon zType="loader-circle" zSize="sm" class="animate-spin" />
          Saving...
        </span>
      } @else {
        {{ isEditMode() ? 'Update' : 'Create' }}
      }
    </z-button>
  </div>
</div>

<!-- Icon Templates -->
<ng-template #homeIconTemplate>
  <z-icon zType="house" zSize="sm" />
</ng-template>

<ng-template #userIconTemplate>
  <z-icon zType="user" zSize="sm" />
</ng-template>