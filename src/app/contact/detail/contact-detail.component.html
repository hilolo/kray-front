<z-page zTitle="Contact Details">
  <div class="container mx-auto max-w-8xl px-2 py-2">
    @if (isLoading()) {
      <div class="flex items-center justify-center min-h-[400px]">
        <div class="text-center space-y-4">
          <z-icon zType="loader-circle" class="w-8 h-8 animate-spin mx-auto" />
          <p class="text-sm text-muted-foreground">Loading contact details...</p>
        </div>
      </div>
    } @else if (contact()) {
      <!-- Header with Edit Button -->
      <div class="flex items-center justify-between mb-4 gap-4">
        <div class="flex items-center gap-2">
          @if (contact()?.identifier) {
            <z-badge zType="outline" class="flex items-center gap-2 px-4 py-2">
              <z-icon zType="id-card" zSize="default" class="text-muted-foreground" />
              <span class="text-sm font-medium text-muted-foreground">Reference:</span>
              <span class="text-sm font-semibold text-foreground">{{ contact()?.identifier }}</span>
            </z-badge>
          }
        </div>
        <z-button zType="default" (click)="console.log('Button clicked'); onEditContact()">
          <z-icon zType="pencil" zSize="sm" />
          Edit Contact
        </z-button>
      </div>

      <div class="flex flex-col lg:flex-row gap-2 h-full">
        <!-- Left Section: Contact Information -->
        <div class="w-full lg:w-[30%] space-y-2 min-w-0">
          <!-- Contact Profile Card -->
          <z-card zBodySpacing="none">
            <div class="space-y-3">
              <h3 class="text-sm font-semibold">Contact Information</h3>
              <div class="flex items-start gap-3">
                @if (contact()?.avatar) {
                  <img
                    [src]="contact()?.avatar!"
                    [alt]="contactName()"
                    [zImageHoverPreview]="contact()?.avatar || null"
                    [zAlt]="contactName()"
                    [zMaxWidth]="'400px'"
                    [zMaxHeight]="'400px'"
                    class="w-20 h-20 rounded-full object-cover border border-border flex-shrink-0"
                  />
                } @else {
                  <z-avatar
                    [zImage]="{ fallback: contactInitials() }"
                    zType="default"
                    zSize="lg"
                    zShape="circle"
                    class="w-20 h-20 flex-shrink-0"
                  />
                }
                <div class="flex-1 min-w-0">
                  <h1 class="text-lg font-semibold mb-1">{{ contactName() }}</h1>
                  @if (contact()?.email) {
                    <div class="flex items-center gap-2 text-sm text-muted-foreground mb-1">
                      <z-icon zType="mail" zSize="sm" />
                      <span>{{ contact()?.email }}</span>
                    </div>
                  }
                  @if (contact()?.phones && contact()!.phones.length > 0) {
                    <div class="flex items-center gap-2 text-sm text-muted-foreground">
                      <z-icon zType="smartphone" zSize="sm" />
                      <span>{{ contact()!.phones.join(', ') }}</span>
                    </div>
                  }
                </div>
              </div>

              <!-- Company Information -->
              @if (contact()?.isACompany) {
                <div class="border-t border-border pt-3 mt-3 space-y-2">
                  <h4 class="text-sm font-semibold">Company Details</h4>
                  @if (contact()?.ice) {
                    <div class="flex items-center gap-2 text-sm text-muted-foreground">
                      <z-icon zType="building" zSize="sm" />
                      <span>ICE: {{ contact()?.ice }}</span>
                    </div>
                  }
                  @if (contact()?.rc) {
                    <div class="flex items-center gap-2 text-sm text-muted-foreground">
                      <z-icon zType="file-text" zSize="sm" />
                      <span>RC: {{ contact()?.rc }}</span>
                    </div>
                  }
                </div>
              }

              <!-- Bank Information -->
              @if (hasBanks()) {
                <div class="border-t border-border pt-3 mt-3 space-y-2">
                  <h4 class="text-sm font-semibold">Bank Accounts</h4>
                  @for (bank of banks(); track bank.id) {
                    <div class="p-3 rounded-md border border-border bg-muted/50">
                      <div class="flex items-center gap-2 mb-2">
                        <z-icon zType="credit-card" zSize="sm" class="text-primary flex-shrink-0" />
                        <span class="text-sm font-medium">{{ bank.bankName }}</span>
                      </div>
                      <div class="space-y-1.5 text-sm text-muted-foreground ml-6">
                        <div class="flex items-center gap-2">
                          <z-icon zType="file-text" zSize="sm" class="text-muted-foreground/70" />
                          <span>RIB: {{ bank.rib }}</span>
                        </div>
                        @if (bank.iban) {
                          <div class="flex items-center gap-2">
                            <z-icon zType="globe" zSize="sm" class="text-muted-foreground/70" />
                            <span>IBAN: {{ bank.iban }}</span>
                          </div>
                        }
                        @if (bank.swift) {
                          <div class="flex items-center gap-2">
                            <z-icon zType="building" zSize="sm" class="text-muted-foreground/70" />
                            <span>SWIFT: {{ bank.swift }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              }

              <!-- Attachments -->
              @if (hasAttachments()) {
                <div class="border-t border-border pt-3 mt-3 space-y-2">
                  <h4 class="text-sm font-semibold">Attachments</h4>
                  <div class="space-y-2">
                    @for (attachment of attachments(); track attachment.id) {
                      <div 
                        class="flex items-center gap-3 p-2 rounded-md border border-border bg-muted/30 hover:bg-muted/50 transition-colors cursor-pointer group"
                        (click)="isFileFormatSupported(attachment.url) && openFile(attachment.url, attachment.fileName || attachment.originalFileName, attachment.fileSize)"
                        [zImageHoverPreview]="getFileViewerType(attachment.url) === 'image' ? attachment.url : null"
                        [zAlt]="attachment.fileName || attachment.originalFileName"
                        [zPosition]="'right'"
                        [zMaxWidth]="'500px'"
                        [zMaxHeight]="'500px'"
                      >
                        <div class="flex-shrink-0 w-10 h-10 rounded bg-primary/10 flex items-center justify-center">
                          <z-icon 
                            [zType]="getFileViewerType(attachment.url) === 'image' ? 'image' : 'file'" 
                            class="text-primary" 
                            zSize="sm" 
                          />
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="font-medium text-sm truncate">{{ attachment.fileName || attachment.originalFileName }}</p>
                          <p class="text-xs text-muted-foreground">{{ formatFileSize(attachment.fileSize) }}</p>
                        </div>
                        @if (isFileFormatSupported(attachment.url)) {
                          <z-icon zType="eye" zSize="sm" class="text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity" />
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </z-card>
        </div>

        <!-- Right Section: Related Information -->
        <div class="w-full lg:w-[70%] space-y-2 min-w-0">
          <z-card zBodySpacing="none">
            <z-tab-group zTabsPosition="top" zActivePosition="bottom" class="flex flex-col">
              <!-- Finance Tab (always shown) -->
              <z-tab label="FINANCE">
                <div class="pt-4">
                  @if (!hasTransactions()) {
                    <div class="text-center py-8 text-sm text-muted-foreground">
                      No transactions found
                    </div>
                  } @else {
                    <!-- Revenue Section (GREEN) -->
                    @if (hasRevenueTransactions()) {
                      <div class="mb-6">
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b-2 border-green-500">
                          <z-icon zType="plus" zSize="sm" class="text-green-600 dark:text-green-400" />
                          <h3 class="text-sm font-semibold text-green-600 dark:text-green-400">REVENUE</h3>
                          <z-badge zType="default" class="bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">
                            {{ revenueTransactions().length }}
                          </z-badge>
                        </div>
                        <z-accordion zType="multiple" [zDefaultValue]="revenueAccordionDefaultValues()">
                          @for (group of groupedRevenueTransactions(); track group.type) {
                            <z-accordion-item [zValue]="'revenue-' + group.type" [zTitle]="group.label + ' (' + group.transactions.length + ')'">
                              <z-datatable
                                [zData]="group.transactions"
                                [zColumns]="revenueColumns()"
                                [zViewMode]="'list'"
                                [zSelectable]="false"
                                [zEmptyMessage]="'No transactions'"
                                [zRowClass]="getRowClass"
                              >
                                <ng-template #revenueDateCell let-row="row">
                                  <span>{{ formatTransactionDate(row) }}</span>
                                </ng-template>
                                <ng-template #revenuePropertyCell let-row="row">
                                  <div class="flex items-center gap-2 flex-wrap">
                                    @if (row.propertyIdentifier) {
                                      <z-badge zType="outline" zSize="sm">{{ row.propertyIdentifier }}</z-badge>
                                    }
                                    @if (row.propertyAddress) {
                                      <span class="text-sm text-muted-foreground">{{ row.propertyAddress }}</span>
                                    }
                                    @if (!row.propertyIdentifier && !row.propertyAddress) {
                                      @if (row.propertyName) {
                                        <span class="text-sm">{{ row.propertyName }}</span>
                                      } @else {
                                        <span class="text-muted-foreground text-sm">-</span>
                                      }
                                    }
                                  </div>
                                </ng-template>
                                <ng-template #revenueTypeCell let-row="row">
                                  @if (getTransactionTypeLabel(row)) {
                                    <z-badge [zType]="'default'">
                                      {{ getTransactionTypeLabel(row) }}
                                    </z-badge>
                                  } @else {
                                    <span class="text-muted-foreground text-sm">-</span>
                                  }
                                </ng-template>
                                <ng-template #revenueAmountCell let-row="row">
                                  <span class="font-semibold text-green-600 dark:text-green-400">{{ formatCurrency(row.totalAmount) }}</span>
                                </ng-template>
                                <ng-template #revenueStatusCell let-row="row">
                                  <z-badge [zType]="getStatusBadge(row.status)">
                                    <z-icon [zType]="getStatusIcon(row.status)" zSize="sm" [class]="getStatusIconColorClass(row.status)" class="mr-1" />
                                    {{ getStatusLabel(row.status) }}
                                  </z-badge>
                                </ng-template>
                              </z-datatable>
                            </z-accordion-item>
                          }
                        </z-accordion>
                      </div>
                    }

                    <!-- Expense Section (RED) -->
                    @if (hasExpenseTransactions()) {
                      <div>
                        <div class="flex items-center gap-2 mb-4 pb-2 border-b-2 border-red-500">
                          <z-icon zType="minus" zSize="sm" class="text-red-600 dark:text-red-400" />
                          <h3 class="text-sm font-semibold text-red-600 dark:text-red-400">EXPENSE</h3>
                          <z-badge zType="destructive" class="bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">
                            {{ expenseTransactions().length }}
                          </z-badge>
                        </div>
                        <z-accordion zType="multiple" [zDefaultValue]="expenseAccordionDefaultValues()">
                          @for (group of groupedExpenseTransactions(); track group.type) {
                            <z-accordion-item [zValue]="'expense-' + group.type" [zTitle]="group.label + ' (' + group.transactions.length + ')'">
                              <z-datatable
                                [zData]="group.transactions"
                                [zColumns]="expenseColumns()"
                                [zViewMode]="'list'"
                                [zSelectable]="false"
                                [zEmptyMessage]="'No transactions'"
                                [zRowClass]="getRowClass"
                              >
                                <ng-template #expenseDateCell let-row="row">
                                  <span>{{ formatTransactionDate(row) }}</span>
                                </ng-template>
                                <ng-template #expensePropertyCell let-row="row">
                                  <div class="flex items-center gap-2 flex-wrap">
                                    @if (row.propertyIdentifier) {
                                      <z-badge zType="outline" zSize="sm">{{ row.propertyIdentifier }}</z-badge>
                                    }
                                    @if (row.propertyAddress) {
                                      <span class="text-sm text-muted-foreground">{{ row.propertyAddress }}</span>
                                    }
                                    @if (!row.propertyIdentifier && !row.propertyAddress) {
                                      @if (row.propertyName) {
                                        <span class="text-sm">{{ row.propertyName }}</span>
                                      } @else {
                                        <span class="text-muted-foreground text-sm">-</span>
                                      }
                                    }
                                  </div>
                                </ng-template>
                                <ng-template #expenseTypeCell let-row="row">
                                  @if (getTransactionTypeLabel(row)) {
                                    <z-badge [zType]="'default'">
                                      {{ getTransactionTypeLabel(row) }}
                                    </z-badge>
                                  } @else {
                                    <span class="text-muted-foreground text-sm">-</span>
                                  }
                                </ng-template>
                                <ng-template #expenseAmountCell let-row="row">
                                  <span class="font-semibold text-red-600 dark:text-red-400">{{ formatCurrency(row.totalAmount) }}</span>
                                </ng-template>
                                <ng-template #expenseStatusCell let-row="row">
                                  <z-badge [zType]="getStatusBadge(row.status)">
                                    <z-icon [zType]="getStatusIcon(row.status)" zSize="sm" [class]="getStatusIconColorClass(row.status)" class="mr-1" />
                                    {{ getStatusLabel(row.status) }}
                                  </z-badge>
                                </ng-template>
                              </z-datatable>
                            </z-accordion-item>
                          }
                        </z-accordion>
                      </div>
                    }
                  }
                </div>
              </z-tab>

              <!-- Properties Tab (shown only if has data) -->
              @if (properties().length > 0) {
                <z-tab label="PROPERTIES">
                  <div class="pt-4 space-y-3">
                    @for (property of properties(); track property.id) {
                      <z-card class="p-4 cursor-pointer hover:bg-muted/50 transition-colors" zBodySpacing="none" (click)="viewProperty(property.id)">
                        <div class="space-y-2">
                          <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                              <div class="flex items-center gap-2 mb-1">
                                <h4 class="text-sm font-semibold">{{ property.name || property.identifier || 'Unnamed Property' }}</h4>
                                @if (property.identifier) {
                                  <z-badge zType="outline" zSize="sm">
                                    {{ property.identifier }}
                                    @if (property.building?.name) {
                                      <span class="ml-1">• {{ property.building?.name }}</span>
                                    }
                                  </z-badge>
                                }
                              </div>
                              <p class="text-xs text-muted-foreground">{{ property.typeProperty || 'N/A' }}</p>
                              <div class="flex items-center gap-2 text-xs text-muted-foreground mt-1">
                                <z-icon zType="map-pin" zSize="sm" />
                                <span>{{ property.address || 'No address' }}{{ property.city ? ', ' + property.city : '' }}</span>
                              </div>
                            </div>
                            @if (property.defaultAttachmentUrl) {
                              <img
                                [src]="property.defaultAttachmentUrl"
                                [alt]="property.name || property.identifier"
                                class="w-16 h-16 rounded-md object-cover border border-border flex-shrink-0"
                              />
                            } @else {
                              <div class="w-16 h-16 rounded-md border border-border bg-muted flex items-center justify-center flex-shrink-0">
                                <z-icon zType="house" zSize="sm" class="text-muted-foreground" />
                              </div>
                            }
                          </div>
                          <div class="flex items-center justify-between pt-2 border-t border-border">
                            <div class="flex flex-col">
                              <span class="text-sm font-semibold">{{ property.price | propertyPrice:property.typePaiment }}</span>
                              @if (property.area) {
                                <span class="text-xs text-muted-foreground">{{ property.area }} m²</span>
                              }
                            </div>
                          </div>
                        </div>
                      </z-card>
                    }
                  </div>
                </z-tab>
              }

              <!-- Reservations Tab (shown only if has data or is loading) -->
              @if (isLoadingReservations() || reservations().length > 0) {
                <z-tab label="RESERVATIONS">
                  <div class="pt-4 space-y-3">
                    @if (isLoadingReservations()) {
                      <div class="flex items-center justify-center py-8">
                        <div class="text-center space-y-4">
                          <z-icon zType="loader-circle" class="w-8 h-8 animate-spin mx-auto" />
                          <p class="text-sm text-muted-foreground">Loading reservations...</p>
                        </div>
                      </div>
                    } @else if (reservations().length > 0) {
                      @for (reservation of reservations(); track reservation.id) {
                        <z-card class="p-4" zBodySpacing="none">
                          <div class="space-y-2">
                            <div class="flex items-start justify-between gap-2">
                              <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                  <h4 class="text-sm font-semibold">{{ reservation.propertyName }}</h4>
                                  @if (reservation.propertyIdentifier) {
                                    <z-badge zType="outline" zSize="sm">{{ reservation.propertyIdentifier }}</z-badge>
                                  }
                                </div>
                                <p class="text-xs text-muted-foreground">{{ reservation.propertyAddress }}</p>
                              </div>
                              @if (reservation.propertyImageUrl) {
                                <img
                                  [src]="reservation.propertyImageUrl"
                                  [alt]="reservation.propertyName"
                                  [zImageHoverPreview]="reservation.propertyImageUrl"
                                  [zMaxWidth]="'700px'"
                                  [zMaxHeight]="'700px'"
                                  class="w-16 h-16 rounded-md object-cover border border-border flex-shrink-0"
                                />
                              } @else {
                                <div class="w-16 h-16 rounded-md border border-border bg-muted flex items-center justify-center flex-shrink-0">
                                  <z-icon zType="house" zSize="sm" class="text-muted-foreground" />
                                </div>
                              }
                            </div>
                            <div class="flex items-center justify-between pt-2 border-t border-border">
                              <div class="flex flex-col gap-1">
                                <div class="flex items-center gap-2 text-sm text-muted-foreground">
                                  <z-icon zType="calendar" zSize="sm" />
                                  <span>{{ formatDate(reservation.startDate) }} - {{ formatDate(reservation.endDate) }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                  <z-icon zType="circle-dollar-sign" zSize="sm" class="text-muted-foreground" />
                                  <span class="text-sm font-semibold">{{ reservation.totalAmount }} MAD</span>
                                </div>
                              </div>
                              <div class="flex items-center gap-2">
                                <z-badge [zType]="getReservationStatusBadgeType(reservation.status)">
                                  {{ getReservationStatusLabel(reservation.status) }}
                                </z-badge>
                                <z-button zType="ghost" zSize="sm" (click)="viewReservation(reservation.id)">
                                  <z-icon zType="eye" zSize="sm" />
                                  View
                                </z-button>
                              </div>
                            </div>
                          </div>
                        </z-card>
                      }
                    }
                  </div>
                </z-tab>
              }

              <!-- Leases Tab (shown for Owners and Tenants) -->
              @if ((isOwner() || isTenant()) && leases().length > 0) {
                <z-tab label="LEASES">
                  <div class="pt-4 space-y-3">
                    @for (lease of leases(); track lease.id) {
                      <z-card class="p-4" zBodySpacing="none">
                        <div class="space-y-2">
                          <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                              <div class="flex items-center gap-2 mb-1">
                                <h4 class="text-sm font-semibold">{{ lease.propertyName || 'Unnamed Property' }}</h4>
                                @if (lease.propertyIdentifier) {
                                  <z-badge zType="outline" zSize="sm">
                                    {{ lease.propertyIdentifier }}
                                  </z-badge>
                                }
                              </div>
                              <div class="flex items-center gap-2 text-xs text-muted-foreground mt-1">
                                <z-icon zType="map-pin" zSize="sm" />
                                <span>{{ lease.propertyAddress || 'No address' }}</span>
                              </div>
                            </div>
                            <z-badge [zType]="getLeaseStatusBadgeType(lease.status)">
                              {{ getLeaseStatusLabel(lease.status) }}
                            </z-badge>
                          </div>
                          <div class="space-y-1 text-sm text-muted-foreground pt-2 border-t border-border">
                            @if (lease.tenantName) {
                              <div class="flex items-center gap-2">
                                <z-icon zType="user" zSize="sm" />
                                <span>Tenant: {{ lease.tenantName }}</span>
                              </div>
                            }
                            <div class="flex items-center gap-2">
                              <z-icon zType="calendar" zSize="sm" />
                              <span>{{ formatDate(lease.tenancyStart) }} - {{ formatDate(lease.tenancyEnd) }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                              <z-icon zType="circle-dollar-sign" zSize="sm" />
                              <span>{{ lease.rentPrice || 0 }} MAD</span>
                            </div>
                          </div>
                        </div>
                      </z-card>
                    }
                  </div>
                </z-tab>
              }

              <!-- Maintenance Tab (shown only if has data) -->
              @if (maintenances().length > 0) {
                <z-tab label="MAINTENANCE">
                  <div class="pt-4 space-y-3">
                    @for (maintenance of maintenances(); track maintenance.id) {
                      <z-card class="p-4 cursor-pointer hover:bg-muted/50 transition-colors" zBodySpacing="none" (click)="viewMaintenance(maintenance.id)">
                        <div class="space-y-2">
                          <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                              <h4 class="text-sm font-semibold mb-1">{{ maintenance.subject }}</h4>
                              <p class="text-xs text-muted-foreground">{{ maintenance.propertyName }}</p>
                            </div>
                            <div class="flex flex-col gap-1 items-end">
                              <z-badge [zType]="getMaintenanceStatusBadgeType(maintenance.status)">
                                {{ getMaintenanceStatusLabel(maintenance.status) }}
                              </z-badge>
                              <z-badge [zType]="getMaintenancePriorityBadgeType(maintenance.priority)" zSize="sm">
                                {{ getMaintenancePriorityLabel(maintenance.priority) }}
                              </z-badge>
                            </div>
                          </div>
                          <div class="space-y-1 text-sm text-muted-foreground pt-2 border-t border-border">
                            <div class="flex items-center gap-2">
                              <z-icon zType="calendar" zSize="sm" />
                              <span>{{ formatDate(maintenance.scheduledDateTime) }}</span>
                            </div>
                            @if (maintenance.description) {
                              <p class="text-xs line-clamp-2">{{ maintenance.description }}</p>
                            }
                          </div>
                        </div>
                      </z-card>
                    }
                  </div>
                </z-tab>
              }
            </z-tab-group>
          </z-card>
        </div>
      </div>
    } @else {
      <div class="flex items-center justify-center min-h-[400px]">
        <div class="text-center space-y-4">
          <p class="text-sm text-muted-foreground">Contact not found</p>
          <z-button zType="default" (click)="router.navigate(['/contact'])">
            Back to Contacts
          </z-button>
        </div>
      </div>
    }
  </div>

  <!-- File Viewer -->
  <z-file-viewer
    [fileUrl]="fileViewerUrl()"
    [fileName]="fileViewerName()"
    [fileSize]="fileViewerSize()"
    [isOpen]="fileViewerOpen()"
    [images]="fileViewerImages()"
    [currentIndex]="fileViewerCurrentIndex()"
    (close)="closeFileViewer()"
    (imageChanged)="onImageChanged($event)"
  />
</z-page>

