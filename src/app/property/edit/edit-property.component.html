<z-page [zTitle]="isEditMode() ? 'Edit Property' : 'Add Property'">
      <div class="flex flex-col min-h-0 h-full overflow-hidden">
        <!-- Header Section -->
        <div class="space-y-4 pb-6 flex-shrink-0">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-3xl font-bold mb-2">
                @if (isEditMode()) {
                  Edit Property
                } @else {
                  Add New Property
                }
              </h2>
              <p class="text-muted-foreground">
                @if (isEditMode()) {
                  Update the property information below
                } @else {
                  Create a new property by filling in the information below
                }
              </p>
            </div>
            <div class="flex gap-2">
              <z-button zType="outline" zSize="default" [disabled]="isSaving()" (click)="!isSaving() && onCancel()">
                Cancel
              </z-button>
              <z-button [zType]="isSaving() || !isFormValid() ? 'ghost' : 'default'" [disabled]="isSaving()" (click)="!isSaving() && onSave()">
                @if (isSaving()) {
                  <span class="flex items-center gap-2">
                    <z-icon zType="loader-circle" zSize="sm" class="animate-spin" />
                    Saving...
                  </span>
                } @else {
                  <z-icon zType="check" zSize="sm" class="mr-2" />
                  Save Property
                }
              </z-button>
            </div>
          </div>
        </div>

        <!-- Main Form -->
        <div class="flex-1 min-h-0 overflow-y-auto">
          @if (isLoading()) {
            <div class="flex items-center justify-center h-full">
              <div class="flex flex-col items-center gap-4">
                <z-icon zType="loader-circle" zSize="lg" class="animate-spin text-primary" />
                <p class="text-muted-foreground">Loading property data...</p>
              </div>
            </div>
          } @else {
            <z-card class="max-w-7xl mx-auto">
              <div class="p-8 space-y-8">
                <!-- Basic Information Section -->
                <div class="space-y-6 pb-6 border-b">
                  <div>
                    <h3 class="text-lg font-semibold mb-1">Basic Information</h3>
                    <p class="text-sm text-muted-foreground">
                      Enter the basic details of the property
                    </p>
                  </div>

                  <!-- First Row: Category, Identifier, Name, Type Property -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <z-form-field>
                      <z-form-label>Category</z-form-label>
                      <z-form-control>
                        <z-select
                          [zValue]="formData().category.toString()"
                          [zLabel]="getCategoryLabel()"
                          (zSelectionChange)="onCategoryChange(+$event)"
                        >
                          @for (option of categoryOptions; track option.value) {
                            <z-select-item [zValue]="option.value.toString()">
                              {{ option.label }}
                            </z-select-item>
                          }
                        </z-select>
                      </z-form-control>
                    </z-form-field>

                    <z-form-field>
                      <z-form-label zRequired>Identifier</z-form-label>
                      <z-form-control [errorMessage]="identifierError()">
                        <div class="flex gap-2">
                          <z-input-group [zPrefix]="homeIconTemplate" class="flex-1">
                            <input
                              z-input
                              type="text"
                              [ngModel]="formData().identifier"
                              (ngModelChange)="updateField('identifier', $event)"
                              placeholder="Enter property identifier"
                              [zStatus]="identifierHasError() ? 'error' : undefined"
                              class="w-full"
                            />
                          </z-input-group>
                          <z-button
                            zType="outline"
                            zSize="default"
                            (click)="generateIdentifier()"
                            title="Generate identifier"
                            class="flex-shrink-0"
                          >
                            <z-icon zType="refresh-cw" zSize="sm" />
                          </z-button>
                        </div>
                      </z-form-control>
                    </z-form-field>

                    <z-form-field>
                      <z-form-label zRequired>Name</z-form-label>
                      <z-form-control [errorMessage]="nameError()">
                        <z-input-group [zPrefix]="homeIconTemplate">
                          <input
                            z-input
                            type="text"
                            [ngModel]="formData().name"
                            (ngModelChange)="updateField('name', $event)"
                            placeholder="Enter property name"
                            [zStatus]="nameHasError() ? 'error' : undefined"
                            class="w-full"
                          />
                        </z-input-group>
                      </z-form-control>
                    </z-form-field>

                    <z-form-field>
                      <z-form-label zRequired>Type Property</z-form-label>
                      <z-form-control [errorMessage]="typePropertyError()">
                        <z-select
                          [zValue]="formData().typeProperty || ''"
                          [zLabel]="formData().typeProperty || 'Select type'"
                          (zSelectionChange)="updateField('typeProperty', $event)"
                        >
                          @for (type of propertyTypes(); track type) {
                            <z-select-item [zValue]="type">
                              {{ type }}
                            </z-select-item>
                          }
                        </z-select>
                      </z-form-control>
                    </z-form-field>
                  </div>

                  <!-- Second Row: Description (full width, resizable) -->
                  <z-form-field>
                    <z-form-label>Description</z-form-label>
                    <z-form-control>
                      <textarea
                        z-input
                        [ngModel]="formData().description"
                        (ngModelChange)="updateField('description', $event)"
                        placeholder="Enter property description"
                        rows="4"
                        class="w-full resize-y"
                      ></textarea>
                    </z-form-control>
                  </z-form-field>
                </div>

                <!-- Location Section -->
                <div class="space-y-6 pb-6 border-b">
                  <div>
                    <h3 class="text-lg font-semibold mb-1">Location</h3>
                    <p class="text-sm text-muted-foreground">
                      Enter the property address
                    </p>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <z-form-field>
                      <z-form-label>Address</z-form-label>
                      <z-form-control>
                        <z-input-group [zPrefix]="mapPinIconTemplate">
                          <input
                            z-input
                            type="text"
                            [ngModel]="formData().address"
                            (ngModelChange)="updateField('address', $event)"
                            placeholder="Enter address"
                            class="w-full"
                          />
                        </z-input-group>
                      </z-form-control>
                    </z-form-field>

                    <z-form-field>
                      <z-form-label>City</z-form-label>
                      <z-form-control>
                        <z-select
                          [zValue]="formData().city || ''"
                          [zLabel]="formData().city || 'Select city'"
                          (zSelectionChange)="updateField('city', $event)"
                        >
                          @for (city of cityOptions; track city) {
                            <z-select-item [zValue]="city">
                              {{ city }}
                            </z-select-item>
                          }
                        </z-select>
                      </z-form-control>
                    </z-form-field>
                  </div>
                </div>

                <!-- Property Details Section -->
                <div class="space-y-6 pb-6 border-b">
                  <div>
                    <h3 class="text-lg font-semibold mb-1">Property Details</h3>
                    <p class="text-sm text-muted-foreground">
                      Enter the property specifications
                    </p>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <z-form-field>
                      <z-form-label zRequired>Area (mÂ²)</z-form-label>
                      <z-form-control [errorMessage]="areaError()">
                        <z-input-group [zPrefix]="squareIconTemplate">
                          <input
                            z-input
                            type="number"
                            [ngModel]="formData().area"
                            (ngModelChange)="updateField('area', +$event)"
                            placeholder="0"
                            min="0"
                            step="100"
                            [zStatus]="areaHasError() ? 'error' : undefined"
                            class="w-full"
                          />
                        </z-input-group>
                      </z-form-control>
                    </z-form-field>

                    <z-form-field>
                      <z-form-label zRequired>Pieces</z-form-label>
                      <z-form-control [errorMessage]="piecesError()">
                        <z-input-group [zPrefix]="homeIconTemplate">
                          <input
                            z-input
                            type="number"
                            [ngModel]="formData().pieces"
                            (ngModelChange)="updateField('pieces', +$event)"
                            placeholder="0"
                            min="0"
                            step="1"
                            [zStatus]="piecesHasError() ? 'error' : undefined"
                            class="w-full"
                          />
                        </z-input-group>
                      </z-form-control>
                    </z-form-field>

                    <z-form-field>
                      <z-form-label>Bathrooms</z-form-label>
                      <z-form-control>
                        <z-input-group [zPrefix]="homeIconTemplate">
                          <input
                            z-input
                            type="number"
                            [ngModel]="formData().bathrooms"
                            (ngModelChange)="updateField('bathrooms', +$event)"
                            placeholder="0"
                            min="0"
                            step="1"
                            class="w-full"
                          />
                        </z-input-group>
                      </z-form-control>
                    </z-form-field>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <z-form-field class="md:col-span-1 lg:col-span-2">
                      <z-form-label zRequired>Price</z-form-label>
                      <z-form-control [errorMessage]="priceError()">
                        <z-input-group [zPrefix]="banknoteIconTemplate">
                          <input
                            z-input
                            type="number"
                            [ngModel]="formData().price"
                            (ngModelChange)="updateField('price', +$event)"
                            placeholder="0"
                            min="0"
                            step="0.01"
                            [zStatus]="priceHasError() ? 'error' : undefined"
                            class="w-full"
                          />
                        </z-input-group>
                      </z-form-control>
                    </z-form-field>

                    <z-form-field>
                      <z-form-label>Payment Type</z-form-label>
                      <z-form-control>
                        <z-select
                          [zValue]="formData().typePaiment.toString()"
                          [zLabel]="getTypePaimentLabel()"
                          (zSelectionChange)="updateField('typePaiment', +$event)"
                        >
                          @for (option of typePaimentOptions; track option.value) {
                            <z-select-item [zValue]="option.value.toString()">
                              {{ option.label }}
                            </z-select-item>
                          }
                        </z-select>
                      </z-form-control>
                    </z-form-field>

                    <z-form-field>
                      <z-form-label>Furnished</z-form-label>
                      <z-form-control>
                        <div class="flex items-center gap-2 h-10">
                          <z-checkbox
                            [ngModel]="formData().furnished"
                            (checkChange)="updateField('furnished', $event)"
                          />
                          <span class="text-sm">Furnished</span>
                        </div>
                      </z-form-control>
                    </z-form-field>
                  </div>
                </div>

                <!-- Amenities and Features Section -->
                <div class="space-y-6 pb-6 border-b">
                  <div>
                    <h3 class="text-lg font-semibold mb-1">Amenities and Features</h3>
                    <p class="text-sm text-muted-foreground">
                      Select the amenities and features available for this property
                    </p>
                  </div>

                  <!-- Amenities -->
                  @if (amenitiesOptions().length > 0) {
                    <div class="space-y-3">
                      <h4 class="text-sm font-medium text-foreground">Amenities</h4>
                      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                        @for (amenity of amenitiesOptions(); track amenity) {
                          <label class="flex items-center gap-2 p-2 rounded-md border border-border hover:bg-accent/50 transition-colors cursor-pointer">
                            <z-checkbox
                              [ngModel]="isAmenityOrFeatureSelected('amenity', amenity)"
                              (checkChange)="toggleAmenityOrFeature('amenity', amenity)"
                            />
                            <span class="text-sm flex-1">{{ amenity }}</span>
                          </label>
                        }
                      </div>
                    </div>
                  }

                  <!-- Features -->
                  @if (featuresOptions().length > 0) {
                    <div class="space-y-3">
                      <h4 class="text-sm font-medium text-foreground">Features</h4>
                      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                        @for (feature of featuresOptions(); track feature) {
                          <label class="flex items-center gap-2 p-2 rounded-md border border-border hover:bg-accent/50 transition-colors cursor-pointer">
                            <z-checkbox
                              [ngModel]="isAmenityOrFeatureSelected('feature', feature)"
                              (checkChange)="toggleAmenityOrFeature('feature', feature)"
                            />
                            <span class="text-sm flex-1">{{ feature }}</span>
                          </label>
                        }
                      </div>
                    </div>
                  }

                  @if (amenitiesOptions().length === 0 && featuresOptions().length === 0) {
                    <div class="text-sm text-muted-foreground italic">
                      No amenities or features available. Please configure them in Settings.
                    </div>
                  }
                </div>

                <!-- Owner Section -->
                <div class="space-y-6 pb-6 border-b">
                  <div>
                    <h3 class="text-lg font-semibold mb-1">Owner</h3>
                    <p class="text-sm text-muted-foreground">
                      Select the property owner
                    </p>
                  </div>

                  <z-form-field>
                    <z-form-label zRequired>Owner</z-form-label>
                    <z-form-control [errorMessage]="contactIdError()">
                      <div class="flex gap-2">
                        <z-combobox
                          [options]="ownerOptions()"
                          [value]="formData().contactId || null"
                          [placeholder]="'Select owner...'"
                          [searchPlaceholder]="'Search owners...'"
                          [emptyText]="'No owners found'"
                          [searchable]="true"
                          [disabled]="isLoadingOwners()"
                          (zValueChange)="updateField('contactId', $event || '')"
                          [zWidth]="'full'"
                          class="flex-1 [&_z-command-list]:max-h-[500px] [&_z-popover]:!w-[400px]"
                        />
                        <z-button
                          zType="outline"
                          zSize="default"
                          (click)="openAddOwnerDialog()"
                          title="Add new owner"
                          class="flex-shrink-0"
                        >
                          <z-icon zType="plus" zSize="sm" />
                        </z-button>
                      </div>
                    </z-form-control>
                  </z-form-field>
                </div>

                <!-- Building Section -->
                <div class="space-y-6 pb-6 border-b">
                  <div>
                    <h3 class="text-lg font-semibold mb-1">Building</h3>
                    <p class="text-sm text-muted-foreground">
                      Attach this property to a building (optional)
                    </p>
                  </div>

                  <z-form-field>
                    <z-form-label>Building</z-form-label>
                    <z-form-control>
                      <z-combobox
                        [options]="buildingOptions()"
                        [value]="formData().buildingId || null"
                        [placeholder]="'Select building (optional)...'"
                        [searchPlaceholder]="'Search buildings...'"
                        [emptyText]="'No buildings found'"
                        [searchable]="true"
                        [disabled]="isLoadingBuildings()"
                        (zValueChange)="updateField('buildingId', $event || '')"
                        [zWidth]="'full'"
                        class="[&_z-command-list]:max-h-[500px] [&_z-popover]:!w-[400px]"
                      />
                    </z-form-control>
                  </z-form-field>
                </div>

                <!-- Property Images Section -->
                <z-form-field>
                  <z-form-label zRequired>Property Images</z-form-label>
                  <z-form-control [errorMessage]="imagesError()">
                    <div class="space-y-6">
                      <p class="text-sm text-muted-foreground">
                        Upload images of the property. Select one as the default image.
                      </p>

                      <!-- Image Gallery -->
                      @if (hasImages()) {
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                          @for (image of allImages(); track image.id) {
                            <div class="relative group">
                              <div class="aspect-square rounded-lg overflow-hidden border-2 relative" [class.border-primary]="image.isDefault" [class.border-border]="!image.isDefault">
                                <img
                                  [src]="image.url"
                                  [alt]="'Property image'"
                                  class="w-full h-full object-cover"
                                  [zImageHoverPreview]="image.url"
                                  [zAlt]="'Property image'"
                                  [zPosition]="'right'"
                                  [zMaxWidth]="'600px'"
                                  [zMaxHeight]="'600px'"
                                />
                                
                                <!-- X Button - Top Right -->
                                <z-button
                                  zType="ghost"
                                  zSize="sm"
                                  class="absolute top-2 right-2 bg-background/90 dark:bg-background/90 hover:bg-background border border-border rounded-full p-1.5 h-auto w-auto opacity-0 group-hover:opacity-100 transition-opacity z-10"
                                  (click)="onRemoveImage(image.id, !image.isUploaded)"
                                  title="Remove image"
                                >
                                  <z-icon zType="x" zSize="sm" class="text-foreground" />
                                </z-button>

                                <!-- Default Badge -->
                                @if (image.isDefault) {
                                  <div class="absolute top-2 left-2 bg-primary text-primary-foreground px-2 py-1 rounded text-xs font-medium z-10">
                                    Default
                                  </div>
                                }
                                
                                <!-- Set Default Button - Bottom Center -->
                                @if (!image.isDefault) {
                                  <div class="absolute bottom-2 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                    <z-button
                                      zType="default"
                                      zSize="sm"
                                      class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white border border-gray-200 dark:border-gray-700 shadow-md hover:bg-gray-50 dark:hover:bg-gray-800"
                                      (click)="onSetDefaultImage(image.id, !image.isUploaded)"
                                      title="Set as default"
                                    >
                                      <z-icon zType="star" zSize="sm" class="mr-1" />
                                      Set Default
                                    </z-button>
                                  </div>
                                }
                              </div>
                            </div>
                          }
                        </div>
                      }

                      <!-- Upload Area -->
                      <div
                        class="relative border-2 border-dashed rounded-lg p-8 text-center hover:border-primary/50 hover:bg-accent/5 transition-all cursor-pointer group"
                        [class.border-red-500]="imagesHasError()"
                        [class.border-border]="!imagesHasError()"
                        (click)="onImageClick()"
                      >
                        <div class="flex flex-col items-center gap-3">
                          <div class="w-12 h-12 rounded-full bg-primary/10 group-hover:bg-primary/20 flex items-center justify-center transition-colors">
                            <z-icon zType="upload" class="text-primary" />
                          </div>
                          <div>
                            <p class="font-medium">Click to upload images or drag and drop</p>
                            <p class="text-sm text-muted-foreground mt-1">
                              Images only (Max 10MB per file)
                            </p>
                          </div>
                        </div>
                        <input
                          #imageInput
                          type="file"
                          multiple
                          accept="image/*"
                          (change)="onImagesSelected($event)"
                          class="hidden"
                        />
                      </div>
                    </div>
                  </z-form-control>
                </z-form-field>
              </div>
            </z-card>
          }
        </div>
      </div>
    </z-page>

<!-- Icon Templates -->
<ng-template #homeIconTemplate>
  <z-icon zType="building-2" zSize="sm" />
</ng-template>

<ng-template #mapPinIconTemplate>
  <z-icon zType="map-pin" zSize="sm" />
</ng-template>

<ng-template #buildingIconTemplate>
  <z-icon zType="building" zSize="sm" />
</ng-template>

<ng-template #squareIconTemplate>
  <z-icon zType="square-library" zSize="sm" />
</ng-template>

<ng-template #banknoteIconTemplate>
  <z-icon zType="banknote" zSize="sm" />
</ng-template>

<ng-template #userIconTemplate>
  <z-icon zType="user" zSize="sm" />
</ng-template>
